<!DOCTYPE html>
<html lang="en" class="theme-black accent-rainbow rainbow-mode">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Approval Toolbox | AblesAI</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 64 64%22><ellipse cx=%2232%22 cy=%2232%22 rx=%2228%22 ry=%228%22 stroke=%22%23ea580c%22 stroke-width=%222.5%22 fill=%22none%22 transform=%22rotate(-20 32 32)%22 stroke-dasharray=%2270 140%22/><circle cx=%2232%22 cy=%2232%22 r=%2212%22 fill=%22%23eab308%22/><ellipse cx=%2232%22 cy=%2232%22 rx=%2228%22 ry=%228%22 stroke=%22%23ea580c%22 stroke-width=%222.5%22 fill=%22none%22 transform=%22rotate(-20 32 32)%22 stroke-dasharray=%2270 140%22 stroke-dashoffset=%22-70%22/><circle cx=%2254%22 cy=%2228%22 r=%224%22 fill=%22%23a855f7%22/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Plus Jakarta Sans', 'sans-serif'],
            mono: ['monospace']
          },
          colors: {
            emerald: {
              450: '#34d399',
              550: '#10b981'
            },
            neutral: { 
              850: '#1a1a1a',
              925: '#0d0d0d'
            }
          }
        }
      }
    }
  </script>

  <style>
    /* ============================================
       ABLES.AI HEADER LOGO STYLES
       ============================================ */
    .header-logo {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .header-logo svg {
      width: 32px;
      height: 32px;
    }
    .header-logo h1 {
      font-size: 1.25rem;
      font-weight: 800;
      letter-spacing: -0.5px;
      color: var(--text-primary);
      margin: 0;
    }
    .header-logo h1 span {
      color: #888;
    }
    .header-logo-sm svg {
      width: 24px;
      height: 24px;
    }
    .header-logo-sm h1 {
      font-size: 0.875rem;
    }
    .orbiting-moon {
      transform-origin: 32px 32px;
      animation: orbit 3s linear infinite, moonColor 2s ease-in-out infinite;
    }
    @keyframes orbit {
      0% { transform: rotate(-20deg) translate(26px, 0) scale(1); opacity: 1; }
      12.5% { transform: rotate(-20deg) translate(18px, 5px) scale(0.9); opacity: 1; }
      25% { transform: rotate(-20deg) translate(0, 7px) scale(0.75); opacity: 0.7; }
      37.5% { transform: rotate(-20deg) translate(-18px, 5px) scale(0.6); opacity: 0.5; }
      50% { transform: rotate(-20deg) translate(-26px, 0) scale(0.5); opacity: 0.4; }
      62.5% { transform: rotate(-20deg) translate(-18px, -5px) scale(0.6); opacity: 0.5; }
      75% { transform: rotate(-20deg) translate(0, -7px) scale(0.75); opacity: 0.7; }
      87.5% { transform: rotate(-20deg) translate(18px, -5px) scale(0.9); opacity: 1; }
      100% { transform: rotate(-20deg) translate(26px, 0) scale(1); opacity: 1; }
    }
    @keyframes moonColor {
      0%, 100% { fill: #a855f7; }
      25% { fill: #3b82f6; }
      50% { fill: #ec4899; }
      75% { fill: #10b981; }
    }
    
    /* ============================================
       DESIGN SYSTEM VARIABLES - LIGHT THEME (DEFAULT)
       ============================================ */
    :root,
    .theme-light {
      --bg-body: #f8fafc;
      --bg-body-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --bg-card: #ffffff;
      --bg-card-inner: #f8fafc;
      --bg-input: #ffffff;
      --bg-toggle: #f1f5f9;
      --bg-option-card: #f8fafc;
      --bg-stat-hover: rgba(16, 185, 129, 0.08);
      --border-primary: #e2e8f0;
      --border-secondary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --slider-track: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08);
      --preview-header-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      --preview-header-text: #ffffff;
      --pattern-color: rgba(0,0,0,0.02);
      --chart-bg: #e2e8f0;
      --modal-overlay: rgba(15, 23, 42, 0.6);
    }

    /* ============================================
       DARK THEME - Deep Navy
       ============================================ */
    .theme-dark {
      --bg-body: #0a0f1a;
      --bg-body-gradient: linear-gradient(135deg, #0a0f1a 0%, #111827 100%);
      --bg-card: #141c2e;
      --bg-card-inner: #0a0f1a;
      --bg-input: #1e293b;
      --bg-toggle: #1e293b;
      --bg-option-card: #0d1321;
      --bg-stat-hover: rgba(16, 185, 129, 0.15);
      --border-primary: #1e293b;
      --border-secondary: #141c2e;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --slider-track: #1e293b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.4);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.4);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.6), 0 4px 6px -4px rgb(0 0 0 / 0.5);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.6), 0 8px 10px -6px rgb(0 0 0 / 0.5);
      --preview-header-bg: linear-gradient(135deg, #020617 0%, #0a0f1a 50%, #020617 100%);
      --preview-header-text: #f1f5f9;
      --pattern-color: rgba(255,255,255,0.02);
      --chart-bg: #1e293b;
      --modal-overlay: rgba(0, 0, 0, 0.85);
    }

    /* ============================================
       BLACK THEME (AMOLED)
       ============================================ */
    .theme-black {
      --bg-body: #000000;
      --bg-body-gradient: linear-gradient(135deg, #000000 0%, #050505 100%);
      --bg-card: #121212;
      --bg-card-inner: #0a0a0a;
      --bg-input: #1f1f1f;
      --bg-toggle: #1f1f1f;
      --bg-option-card: #0a0a0a;
      --bg-stat-hover: rgba(16, 185, 129, 0.2);
      --border-primary: #2a2a2a;
      --border-secondary: #1a1a1a;
      --text-primary: #f5f5f5;
      --text-secondary: #a3a3a3;
      --text-muted: #666666;
      --slider-track: #2a2a2a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.6), 0 2px 4px -2px rgb(0 0 0 / 0.5);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.7), 0 4px 6px -4px rgb(0 0 0 / 0.6);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.7), 0 8px 10px -6px rgb(0 0 0 / 0.6);
      --preview-header-bg: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
      --preview-header-text: #f5f5f5;
      --pattern-color: rgba(255,255,255,0.01);
      --chart-bg: #1f1f1f;
      --modal-overlay: rgba(0, 0, 0, 0.9);
    }

    /* ============================================
       ACCENT COLORS - MINT (DEFAULT)
       ============================================ */
    :root,
    .accent-mint {
      --accent: #10b981;
      --accent-light: #34d399;
      --accent-dark: #059669;
      --accent-glow: rgba(16, 185, 129, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 16, 185, 129;
    }

    /* BLUE ACCENT */
    .accent-blue {
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --accent-dark: #2563eb;
      --accent-glow: rgba(59, 130, 246, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 59, 130, 246;
    }

    /* PURPLE ACCENT */
    .accent-purple {
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      --accent-dark: #7c3aed;
      --accent-glow: rgba(139, 92, 246, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 139, 92, 246;
    }

    /* RAINBOW ACCENT - cycles via JavaScript */
    .accent-rainbow {
      --accent: #10b981;
      --accent-light: #34d399;
      --accent-dark: #059669;
      --accent-glow: rgba(16, 185, 129, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 16, 185, 129;
    }

    /* ORANGE ACCENT */
    .accent-orange {
      --accent: #f97316;
      --accent-light: #fb923c;
      --accent-dark: #ea580c;
      --accent-glow: rgba(249, 115, 22, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 249, 115, 22;
    }

    /* CYAN ACCENT */
    .accent-cyan {
      --accent: #06b6d4;
      --accent-light: #22d3ee;
      --accent-dark: #0891b2;
      --accent-glow: rgba(6, 182, 212, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 6, 182, 212;
    }

    /* GOLD ACCENT */
    .accent-gold {
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --accent-glow: rgba(234, 179, 8, 0.15);
      --accent-text: #0f172a;
      --accent-rgb: 234, 179, 8;
    }

    /* SLATE ACCENT (Monochrome) */
    .accent-slate {
      --accent: #525252;
      --accent-light: #737373;
      --accent-dark: #404040;
      --accent-glow: rgba(82, 82, 82, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 82, 82, 82;
    }

    /* FOREST ACCENT */
    .accent-lime {
      --accent: #166534;
      --accent-light: #22c55e;
      --accent-dark: #14532d;
      --accent-glow: rgba(22, 101, 52, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 22, 101, 52;
    }

    /* NAVY ACCENT */
    .accent-teal {
      --accent: #1e3a5f;
      --accent-light: #3b82f6;
      --accent-dark: #172554;
      --accent-glow: rgba(30, 58, 95, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 30, 58, 95;
    }

    /* BURGUNDY ACCENT */
    .accent-pink {
      --accent: #881337;
      --accent-light: #be185d;
      --accent-dark: #4c0519;
      --accent-glow: rgba(136, 19, 55, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 136, 19, 55;
    }

    /* STEEL ACCENT */
    .accent-indigo {
      --accent: #64748b;
      --accent-light: #94a3b8;
      --accent-dark: #475569;
      --accent-glow: rgba(100, 116, 139, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 100, 116, 139;
    }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: var(--bg-body-gradient);
      color: var(--text-primary); 
      min-height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(circle at 1px 1px, var(--pattern-color) 1px, transparent 0);
      background-size: 24px 24px;
      pointer-events: none;
      z-index: -1;
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }

    .input-field {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
      outline: none;
    }

    .input-field:hover:not(:focus) {
      border-color: var(--text-muted);
    }

    .input-field::placeholder {
      color: var(--text-muted);
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
      pointer-events: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--accent-text);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.3), var(--shadow-md);
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.5), var(--shadow-lg), 0 8px 20px -4px rgba(var(--accent-rgb), 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      color: var(--text-secondary);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.2), var(--shadow-md);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      color: var(--accent);
      background: var(--accent-glow);
    }

    /* ============================================
       CARDS
       ============================================ */
    .card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-section {
      border-left: 3px solid var(--accent);
    }

    /* ============================================
       TABS
       ============================================ */
    .calc-tab {
      position: relative;
      transition: all 0.2s;
      color: var(--text-muted);
    }

    .calc-tab:hover:not(.active) {
      color: var(--text-secondary);
    }

    .calc-tab.active {
      color: var(--accent);
      background: var(--bg-card);
      border-color: var(--border-primary);
      border-bottom-color: var(--bg-card);
    }

    .calc-tab.active::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: 3px 3px 0 0;
    }

    /* ============================================
       TOGGLES & SWITCHES
       ============================================ */
    .toggle-group {
      background: var(--bg-toggle);
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
    }

    .toggle-btn {
      color: var(--text-muted);
      font-weight: 600;
      transition: all 0.2s;
    }

    .toggle-btn:hover:not(.active) {
      color: var(--text-secondary);
    }

    .toggle-btn.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--accent-text);
      box-shadow: var(--shadow-md);
      border-radius: 8px;
    }

    /* Custom Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--slider-track);
      border-radius: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .switch-slider::before {
      content: '';
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .switch input:checked + .switch-slider {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    }

    .switch input:checked + .switch-slider::before {
      transform: translateX(20px);
    }

    .switch input:focus + .switch-slider {
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* ============================================
       SLIDERS
       ============================================ */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
      outline: none;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 4px 12px rgba(0,0,0,0.15);
    }

    .slider::-webkit-slider-thumb:active {
      cursor: grabbing;
      transform: scale(1.05);
    }

    .slider::-moz-range-thumb {
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .slider::-moz-range-track {
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
    }

    /* Dark variant for client slider */
    .slider-dark {
      background: rgba(255, 255, 255, 0.12);
      height: 10px;
    }

    .slider-dark::-webkit-slider-thumb {
      border: 0;
      background: linear-gradient(135deg, var(--accent-light), var(--accent));
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 0 0 4px rgba(255,255,255,0.15), 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.15s ease, background 1.5s ease, box-shadow 1.5s ease;
    }

    .slider-dark::-webkit-slider-thumb:hover {
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.6), 0 0 0 6px rgba(255,255,255,0.2), 0 6px 16px rgba(0,0,0,0.35);
    }

    /* ============================================
       CHARTS
       ============================================ */
    .circular-chart {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 100%;
    }

    .circle-bg {
      fill: none;
      stroke: var(--chart-bg);
      stroke-width: 3;
    }

    .circle {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
      stroke: url(#gradient);
      transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 2px 4px rgba(var(--accent-rgb), 0.3));
    }

    /* ============================================
       STICKY PREVIEW COLUMN
       ============================================ */
    #previewColumn {
      position: relative;
    }
    
    /* Desktop: Sticky behavior */
    @media (min-width: 1024px) {
      #previewColumn {
        position: -webkit-sticky;
        position: sticky;
        top: 100px;
        align-self: start;
        max-height: calc(100vh - 120px);
        overflow-y: auto;
        scrollbar-width: thin;
        scrollbar-color: var(--accent) transparent;
      }
      
      #previewColumn::-webkit-scrollbar {
        width: 6px;
      }
      
      #previewColumn::-webkit-scrollbar-track {
        background: transparent;
      }
      
      #previewColumn::-webkit-scrollbar-thumb {
        background: var(--accent);
        border-radius: 3px;
      }
    }
    
    .preview-sticky-wrapper {
      /* No constraints */
    }
    
    /* Action Bar - Hidden (buttons are in header) */
    #stickyActionBar {
      display: none !important;
    }
    
    /* Sticky Header */
    #adminPanel > header {
      background: #000 !important;
    }
    
    /* Sticky Preview Dropdown */
    .preview-picker-sticky {
      position: relative;
    }
    
    .preview-picker-sticky .preview-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      min-width: 220px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 8px;
      box-shadow: var(--shadow-xl);
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s ease;
      z-index: 100;
    }
    
    .preview-picker-sticky .preview-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    /* Ensure nothing breaks sticky */
    .w-full.max-w-7xl,
    #adminPanel,
    #adminPanel .grid {
      overflow: visible !important;
    }

    /* ============================================
       PREVIEW CARD
       ============================================ */
    .preview-card {
      background: var(--bg-card);
      border-radius: 28px;
      border: 4px solid var(--accent);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.25),
        0 0 80px rgba(var(--accent-rgb), 0.1),
        0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .preview-card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 0 60px rgba(var(--accent-rgb), 0.35),
        0 0 100px rgba(var(--accent-rgb), 0.15),
        0 30px 60px -12px rgba(0, 0, 0, 0.3);
    }

    .preview-header {
      background: var(--preview-header-bg);
      position: relative;
      overflow: hidden;
    }

    .preview-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 30% 20%, rgba(var(--accent-rgb), 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(var(--accent-rgb), 0.05) 0%, transparent 40%);
      pointer-events: none;
    }

    .preview-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    .amount-display {
      font-size: clamp(2.5rem, 8vw, 3.5rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 20px rgba(255,255,255,0.1);
    }

    /* Business Name Styling */
    .business-name-display {
      font-size: 1.125rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #ffffff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Logo Styling */
    .preview-logo {
      max-height: 48px;
      max-width: 160px;
      object-fit: contain;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
    }

    .preview-logo-container {
      margin-bottom: 16px;
    }

    .company-name-display {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    .stat-cell {
      padding: 20px 16px;
      text-align: center;
      transition: all 0.2s;
      position: relative;
    }

    .stat-cell::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: transparent;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .stat-cell:hover::after {
      background: var(--bg-stat-hover);
    }

    .stat-label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .stat-value {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }

    /* ============================================
       INLINE EDITABLE VALUES
       ============================================ */
    .editable-value {
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      padding: 2px 6px;
      margin: -2px -6px;
      position: relative;
    }

    .editable-value:hover {
      background: var(--accent-glow);
      box-shadow: 0 0 0 2px var(--accent-glow);
    }

    .editable-value:focus {
      outline: none;
      background: rgba(255,255,255,0.15);
      box-shadow: 0 0 0 2px var(--accent);
    }

    .editable-value::after {
      content: '✎';
      position: absolute;
      right: -18px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 10px;
      opacity: 0;
      color: var(--accent);
      transition: opacity 0.2s;
      pointer-events: none;
    }

    .editable-value:hover::after {
      opacity: 0.7;
    }

    .editable-value:focus::after {
      opacity: 0;
    }

    .amount-display.editable-value::after {
      right: -24px;
      font-size: 14px;
    }

    /* ============================================
       THEME PICKER
       ============================================ */
    .theme-picker {
      position: relative;
    }

    .theme-picker-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 36px;
      padding: 0 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-picker-btn:hover {
      background: var(--bg-card);
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow-xl);
      z-index: 100;
      min-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .theme-section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .theme-mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .theme-mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border-primary);
      background: var(--bg-option-card);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .theme-mode-btn:hover {
      border-color: var(--accent);
    }

    .theme-mode-btn.active {
      border-color: var(--accent);
      background: var(--accent-glow);
      color: var(--accent);
    }

    /* Mode Toggle Buttons */
    .mode-toggle-btn {
      transition: all 0.2s;
      border-radius: 20px;
    }
    .mode-toggle-btn:hover {
      background: var(--accent-glow);
    }
    .mode-toggle-btn.active {
      background: var(--accent);
      color: var(--accent-text) !important;
    }

    /* Tier Preset Buttons */
    .tier-preset-btn {
      cursor: pointer;
    }
    .tier-preset-btn:hover {
      border-color: var(--accent) !important;
      background: var(--bg-option-card) !important;
    }
    .tier-preset-btn.active {
      border-color: var(--accent) !important;
      background: var(--accent-glow) !important;
    }

    /* Preview Dropdown */
    .preview-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 8px;
      box-shadow: var(--shadow-xl);
      z-index: 100;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .preview-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .preview-option {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
      color: var(--text-secondary);
    }
    
    .preview-option:hover {
      background: var(--bg-option-card);
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateX(4px);
    }
    
    .preview-option:hover .preview-option-title {
      color: var(--accent);
    }
    
    .preview-option:hover svg {
      color: var(--accent);
    }
    
    .preview-option svg {
      flex-shrink: 0;
      transition: color 0.15s ease;
    }
    
    .preview-option-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      transition: color 0.15s ease;
    }
    
    .preview-option-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .color-swatches {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid transparent;
      position: relative;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.active {
      border-color: var(--text-primary);
    }

    .color-swatch.active::after {
      content: '✓';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .color-swatch.locked {
      opacity: 0.4;
      cursor: not-allowed;
    }

    .color-swatch.locked:hover {
      transform: none;
    }

    .color-swatch.locked::before {
      content: '';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='white' stroke-width='2'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: center;
      background-size: 14px 14px;
    }

    .swatch-mint { background: linear-gradient(135deg, #10b981, #059669); }
    .swatch-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .swatch-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .swatch-rainbow { 
      background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6, #f43f5e, #f97316, #eab308); 
      background-size: 300% 300%;
      animation: rainbowSwatch 6s ease infinite;
    }
    @keyframes rainbowSwatch {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .swatch-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
    .swatch-cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .swatch-gold { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .swatch-slate { background: linear-gradient(135deg, #525252, #404040); }
    .swatch-lime { background: linear-gradient(135deg, #166534, #14532d); }
    .swatch-teal { background: linear-gradient(135deg, #1e3a5f, #172554); }
    .swatch-pink { background: linear-gradient(135deg, #881337, #4c0519); }
    .swatch-indigo { background: linear-gradient(135deg, #64748b, #475569); }

    /* Logo Input in Theme Dropdown */
    .logo-input-container {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-secondary);
    }

    .logo-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .logo-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .logo-input::placeholder {
      color: var(--text-muted);
    }

    .logo-preview-small {
      margin-top: 10px;
      padding: 12px;
      background: var(--bg-option-card);
      border-radius: 8px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-preview-small img {
      max-height: 36px;
      max-width: 100%;
      object-fit: contain;
    }

    .logo-preview-placeholder {
      font-size: 11px;
      color: var(--text-muted);
    }

    .clear-logo-btn {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s;
    }

    .clear-logo-btn:hover {
      color: #ef4444;
    }

    /* Brand Section Locked State */
    .brand-section {
      position: relative;
      overflow: hidden;
    }

    .brand-section.locked .brand-content {
      filter: blur(1px);
      pointer-events: none;
      user-select: none;
      opacity: 0.7;
    }

    .brand-lock-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      gap: 6px;
    }

    .brand-section:not(.locked) .brand-lock-overlay {
      display: none;
    }

    .brand-lock-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .brand-lock-btn:hover {
      filter: brightness(1.1);
      transform: scale(1.02);
    }

    .brand-lock-text {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Welcome/Login Screen */
    .welcome-screen {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 2000;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      opacity: 1;
      visibility: visible;
      transition: all 0.4s ease-out;
    }

    .welcome-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .hidden {
      display: none !important;
    }

    .welcome-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 2px solid var(--accent);
      box-shadow: 0 0 40px rgba(var(--accent-rgb), 0.4), 0 0 80px rgba(var(--accent-rgb), 0.2), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      text-align: center;
      position: relative;
      overflow: visible;
      transition: border-color 0.8s ease, box-shadow 0.8s ease;
    }
    
    .welcome-logo {
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
      color: var(--accent);
      transition: color 0.8s ease, transform 0.2s ease;
      cursor: pointer;
      display: block;
      text-decoration: none;
    }
    
    .welcome-logo:hover {
      transform: scale(1.1);
    }

    .welcome-logo svg {
      width: 100%;
      height: 100%;
    }

    .welcome-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .welcome-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    .welcome-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .welcome-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .welcome-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .welcome-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .welcome-btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 20px;
      color: var(--accent-text);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 1.5s ease, box-shadow 1.5s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.4), 0 0 40px rgba(var(--accent-rgb), 0.2), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .welcome-btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .welcome-btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 30px rgba(var(--accent-rgb), 0.5), 0 0 60px rgba(var(--accent-rgb), 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .welcome-btn-primary:hover::before {
      opacity: 1;
    }
    
    .welcome-btn-primary:active {
      transform: translateY(-1px) scale(1.01);
    }
    
    .welcome-btn-primary svg {
      width: 18px;
      height: 18px;
    }
    
    .welcome-btn-primary .pro-badge {
      background: rgba(0,0,0,0.25);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.1em;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .welcome-btn-secondary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 20px;
      background: var(--bg-card-inner);
      border: 1px solid var(--accent);
      border-radius: 14px;
      color: var(--accent);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 1.5s ease, color 1.5s ease, box-shadow 1.5s ease;
      position: relative;
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.15);
    }

    .welcome-btn-secondary:hover {
      background: var(--accent-glow);
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.25);
    }
    
    .welcome-btn-secondary:active {
      transform: translateY(0);
    }
    
    .welcome-btn-secondary .lite-badge {
      background: rgba(var(--accent-rgb), 0.15);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent);
      border: 1px solid rgba(var(--accent-rgb), 0.3);
      transition: all 1.5s ease;
    }

    .welcome-error {
      font-size: 13px;
      color: #ef4444;
      text-align: center;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      display: none;
      font-weight: 500;
    }

    .welcome-error.show {
      display: block;
    }

    .welcome-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .welcome-divider::before,
    .welcome-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .welcome-features {
      margin-top: 24px;
      text-align: left;
    }

    .welcome-mode-toggle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .welcome-mode-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .welcome-toggle-wrapper {
      width: 100%;
      background: #000000;
      border: 1px solid var(--border-primary);
      transition: background 0.8s ease, border-color 0.8s ease;
      display: flex;
      border-radius: 12px;
    }
    
    .welcome-toggle-btn {
      flex: 1;
      color: var(--text-secondary);
      background: transparent;
      transition: all 0.3s ease;
      justify-content: center;
    }
    
    .welcome-toggle-btn.active {
      color: #000000;
      background: var(--accent);
    }
    
    .welcome-toggle-btn:hover:not(.active) {
      color: var(--accent-light);
    }
    
    .welcome-toggle-divider {
      background: var(--border-primary);
      transition: background 0.8s ease;
    }
    
    .welcome-mode-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .welcome-mode-btn:hover {
      color: var(--text-primary);
    }
    
    .welcome-mode-btn.active {
      color: var(--accent);
      background: rgba(255,255,255,0.1);
    }

    .welcome-features-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .welcome-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
    }

    .welcome-feature svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .welcome-feature.locked svg {
      color: var(--text-muted);
    }

    .welcome-feature.locked {
      color: var(--text-muted);
    }

    /* Login Modal (for later logins from brand section) */
    .login-modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .login-modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .login-modal {
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-radius: 24px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.4),
        0 0 80px rgba(var(--accent-rgb), 0.2),
        0 25px 50px -12px rgba(0, 0, 0, 0.5);
      overflow: visible;
    }
    
    .login-modal-overlay.open .login-modal {
      transform: scale(1) translateY(0);
    }

    .login-modal-content {
      padding: 32px;
      text-align: center;
      overflow: hidden;
      border-radius: 22px;
    }

    .login-modal-icon {
      width: 100px;
      height: 100px;
      margin: 0 auto 20px;
      color: var(--accent);
    }
    
    .login-modal-icon svg {
      width: 100%;
      height: 100%;
    }

    .login-modal-title {
      font-size: 20px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .login-modal-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .login-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .login-error {
      font-size: 13px;
      color: #ef4444;
      text-align: center;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      display: none;
      font-weight: 500;
    }

    .login-error.show {
      display: block;
    }

    .login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 4px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(var(--accent-rgb), 0.3);
    }
    
    .login-btn svg {
      width: 18px;
      height: 18px;
    }

    .login-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .login-free-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 14px 16px;
      background: transparent;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-free-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .login-features {
      margin-top: 24px;
      text-align: left;
    }

    .login-features-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .login-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
    }

    .login-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .login-feature-locked {
      color: var(--text-muted);
    }

    .login-feature-locked svg {
      color: var(--text-muted);
    }

    .login-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--bg-input);
      color: var(--text-secondary);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .login-close-btn:hover {
      background: var(--accent-glow);
      color: var(--accent);
    }

    /* User Badge in Header */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.3);
      transition: all 0.2s, border-color 1.5s ease, background 1.5s ease, color 1.5s ease, box-shadow 1.5s ease;
    }
    
    .user-badge:hover {
      background: var(--accent);
      color: var(--accent-text);
      border-color: var(--accent);
      box-shadow: 0 0 25px rgba(var(--accent-rgb), 0.5);
    }

    .user-badge svg {
      width: 14px;
      height: 14px;
    }

    .logout-btn {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      border-color: #ef4444;
      color: #ef4444;
    }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(8px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .fade-enter {
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(100%); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 var(--accent-glow); }
      70% { box-shadow: 0 0 0 10px transparent; }
      100% { box-shadow: 0 0 0 0 transparent; }
    }

    .pulse-ring {
      animation: pulse-ring 2s infinite;
    }

    /* Toast */
    .toast {
      transform: translateY(120%);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .toast.show {
      transform: translateY(0);
    }

    /* ============================================
       SECTION LABELS
       ============================================ */
    .section-indicator {
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--accent), var(--accent-light));
      border-radius: 4px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    /* ============================================
       OPTION TOGGLE CARDS
       ============================================ */
    .option-card {
      background: var(--bg-option-card);
      border-radius: 14px;
      border: 1px solid var(--border-secondary);
      padding: 16px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .option-card:hover {
      border-color: rgba(var(--accent-rgb), 0.3);
    }

    .option-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* ============================================
       MODALS
       ============================================ */
    .modal-overlay {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: var(--modal-overlay);
    }

    .modal-content {
      animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-card);
      color: var(--text-primary);
    }

    .share-option:hover {
      border-color: var(--accent) !important;
      transform: translateY(-2px);
    }
    .share-option:hover > div:first-child {
      transform: scale(1.1);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* ============================================
       TABLE STYLES
       ============================================ */
    .amort-table {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .amort-table th {
      position: sticky;
      top: 0;
      background: var(--bg-option-card);
      z-index: 10;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .amort-table tbody tr {
      transition: background 0.15s;
    }

    .amort-table tbody tr:hover {
      background: var(--bg-option-card);
    }

    .amort-table td {
      color: var(--text-secondary);
    }

    /* ============================================
       COLLAPSIBLE SECTIONS (All Screens)
       ============================================ */
    .mobile-collapsible .section-header {
      cursor: pointer;
      user-select: none;
    }
    
    .mobile-collapsible .section-header .collapse-icon {
      display: flex;
      transition: transform 0.3s ease;
    }
    
    .mobile-collapsible.collapsed .section-header .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .mobile-collapsible .section-content {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .mobile-collapsible.collapsed .section-content {
      max-height: 0 !important;
      opacity: 0;
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    .mobile-collapsible:not(.collapsed) .section-content {
      max-height: 2000px;
      opacity: 1;
    }
    
    /* Force expanded on desktop */
    @media (min-width: 769px) {
      .mobile-collapsible.collapsed .section-content {
        max-height: 2000px !important;
        opacity: 1 !important;
        padding-top: revert !important;
        margin-top: revert !important;
      }
      .mobile-collapsible .section-header .collapse-icon {
        display: none;
      }
    }

    /* ============================================
       RESPONSIVE ADJUSTMENTS
       ============================================ */
    @media (max-width: 768px) {
      .preview-card {
        border-width: 3px;
        border-radius: 24px;
      }

      .amount-display {
        font-size: 2.5rem;
      }

      .theme-dropdown {
        right: -50px;
        min-width: 260px;
      }

      .business-name-display {
        font-size: 1rem;
      }

      /* Mobile Header Styles */
      .header-main {
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 12px;
        padding: 16px 12px;
      }

      /* Row 1: Shield + Title centered on top */
      .header-brand {
        order: 1 !important;
        justify-content: center;
        width: 100%;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .header-brand h1 {
        font-size: 20px;
      }

      .header-brand svg {
        width: 32px;
        height: 32px;
      }

      /* User badge - top right corner */
      #userBadge {
        order: 0 !important;
        position: absolute;
        right: 12px;
        top: 12px;
      }

      /* Row 2: Action buttons centered */
      .header-actions {
        order: 2 !important;
        justify-content: center;
        gap: 8px;
        width: 100%;
      }

      /* Row 3: Mode toggle (Lender/ISO/Client) centered at bottom */
      .header-mode-toggle {
        order: 3 !important;
        padding: 4px 2px !important;
      }

      .header-mode-toggle button {
        padding: 0 10px !important;
        font-size: 12px !important;
      }

      /* Make action buttons more compact */
      .header-actions button,
      .header-actions .theme-picker button,
      .header-actions .preview-picker button {
        height: 32px;
        padding: 0 10px !important;
        font-size: 11px !important;
      }

      /* Hide button text on small screens, show only icons */
      header .btn-text {
        display: none;
      }

      /* Keep dropdown arrow visible */
      header > .flex.items-center.gap-2 .preview-picker button svg:last-child {
        display: block;
      }

      /* Adjust dropdown positions for mobile */
      .theme-dropdown {
        right: auto;
        left: 50%;
        transform: translateX(-50%);
        min-width: 280px;
      }

      .preview-dropdown {
        right: auto;
        left: 50%;
        transform: translateX(-50%);
      }
    }

    /* Extra small screens */
    @media (max-width: 480px) {
      .header-main {
        padding: 10px 8px;
        gap: 8px;
      }

      .header-mode-toggle {
        transform: scale(0.95);
      }

      .header-actions {
        gap: 4px;
      }

      .header-actions button {
        padding: 0 8px !important;
      }
    }

    /* ============================================
       SCROLLBAR STYLES
       ============================================ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-option-card);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--slider-track);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================================
       BADGE STYLES
       ============================================ */
    .trust-badge {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-md), 0 0 0 1px rgba(var(--accent-rgb), 0.1);
      position: relative;
      overflow: hidden;
    }

    .trust-badge::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.08), transparent);
      pointer-events: none;
    }

    .trust-badge-icon {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(var(--accent-rgb), 0.4);
    }

    .trust-badge-icon svg {
      width: 12px;
      height: 12px;
      color: white;
    }

    .trust-badge-text {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-secondary);
    }

    .trust-badge-accent {
      color: var(--accent);
      font-weight: 800;
    }

    /* Light theme trust badge */
    .theme-light .trust-badge {
      background: white;
      border-color: rgba(var(--accent-rgb), 0.2);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(var(--accent-rgb), 0.1);
    }

    /* Dark theme trust badge */
    .theme-dark .trust-badge {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(var(--accent-rgb), 0.3);
    }

    /* Black theme trust badge */
    .theme-black .trust-badge {
      background: rgba(20, 20, 20, 0.95);
      border-color: rgba(var(--accent-rgb), 0.4);
    }

    .option-badge {
      background: rgba(var(--accent-rgb), 0.1);
      border: 1px solid rgba(var(--accent-rgb), 0.2);
      color: var(--accent);
    }

    /* Dark theme specific overrides */
    .theme-dark .preview-header .amount-display {
      background: linear-gradient(180deg, #ffffff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-dark .btn-secondary:hover {
      background: var(--accent-glow);
    }

    .theme-dark input,
    .theme-dark textarea,
    .theme-dark select {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    /* Gradient fix for dark mode inputs */
    .theme-dark .option-card input,
    .theme-dark .option-card textarea {
      background: var(--bg-card);
      border-color: var(--border-primary);
    }

    .theme-dark .stats-grid {
      background: var(--bg-card-inner);
    }

    .theme-dark .stat-cell {
      border-color: var(--border-primary) !important;
    }

    /* Black theme specific overrides */
    .theme-black .preview-header .amount-display {
      background: linear-gradient(180deg, #ffffff 0%, #a3a3a3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-black .btn-secondary:hover {
      background: var(--accent-glow);
    }

    .theme-black input,
    .theme-black textarea,
    .theme-black select {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .theme-black .option-card input,
    .theme-black .option-card textarea {
      background: var(--bg-card);
      border-color: var(--border-primary);
    }

    .theme-black .stats-grid {
      background: #0a0a0a;
    }

    .theme-black .stats-grid:nth-child(even) {
      background: #0f0f0f;
    }

    .theme-black .stat-cell {
      border-color: var(--border-primary) !important;
    }

    /* Dashboard Styles */
    .offer-count-badge {
      background: var(--accent);
      color: var(--accent-text);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
    }
    
    /* Lite usage badge - grey by default, orange when low */
    .lite-badge {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    
    .lite-badge.low {
      background: var(--accent);
      color: var(--accent-text);
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
    }
    
    /* ============================================
       OFFER PIPELINE MODAL
       ============================================ */
    .dashboard-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .dashboard-backdrop {
      position: absolute;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      z-index: 1;
    }
    
    .dashboard-content {
      position: relative;
      z-index: 2;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      border-radius: 24px;
      width: 100%;
      max-width: 1100px;
      max-height: 90vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.2),
        0 0 80px rgba(var(--accent-rgb), 0.1),
        0 25px 50px -12px rgba(0, 0, 0, 0.5);
    }
    
    .dashboard-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border-secondary);
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--preview-header-bg);
      position: relative;
    }
    
    .dashboard-header .header-actions {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 2;
    }
    
    .dashboard-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 50% 50%, rgba(var(--accent-rgb), 0.1) 0%, transparent 50%);
      pointer-events: none;
    }
    
    .dashboard-title {
      display: flex;
      align-items: center;
      gap: 12px;
      position: relative;
      z-index: 1;
    }
    
    .dashboard-title .section-indicator {
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--accent-light), var(--accent));
      border-radius: 2px;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.5);
    }
    
    .dashboard-title h2 {
      font-size: 16px;
      font-weight: 700;
      color: #ffffff;
      margin: 0;
      letter-spacing: 0.02em;
    }
    
    .dashboard-body {
      overflow-y: auto;
      flex: 1;
      padding: 16px;
      scrollbar-width: thin;
      scrollbar-color: var(--accent) transparent;
    }
    
    .dashboard-body::-webkit-scrollbar { width: 6px; }
    .dashboard-body::-webkit-scrollbar-track { background: transparent; }
    .dashboard-body::-webkit-scrollbar-thumb { background: var(--accent); border-radius: 3px; }
    .dashboard-body::-webkit-scrollbar-thumb:hover { background: var(--accent-light); }
    
    /* Pipeline Metrics */
    /* Pipeline Metrics - Summary Cards */
    .pipeline-metrics {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
      gap: 10px;
      margin-bottom: 20px;
    }
    
    .metric-card {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 14px;
      padding: 14px 10px;
      text-align: center;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
    }
    
    .metric-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: var(--border-secondary);
      transition: all 0.25s;
    }
    
    .metric-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    }
    
    .metric-card.active {
      border-color: currentColor;
      box-shadow: 0 0 20px rgba(255,255,255,0.1);
    }
    
    .metric-card.active::before {
      height: 4px;
    }
    
    .metric-card.total.active { border-color: var(--accent); box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.3); }
    .metric-card.shared.active { border-color: #8b5cf6; box-shadow: 0 0 20px rgba(139, 92, 246, 0.3); }
    .metric-card.viewed.active { border-color: #06b6d4; box-shadow: 0 0 20px rgba(6, 182, 212, 0.3); }
    .metric-card.accepted.active { border-color: #10b981; box-shadow: 0 0 20px rgba(16, 185, 129, 0.3); }
    .metric-card.declined.active { border-color: #ef4444; box-shadow: 0 0 20px rgba(239, 68, 68, 0.3); }
    .metric-card.pending.active { border-color: #f59e0b; box-shadow: 0 0 20px rgba(245, 158, 11, 0.3); }
    
    .metric-value {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      line-height: 1.1;
    }
    
    .metric-count {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .metric-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
      margin-top: 6px;
    }
    
    /* Metric card color variants */
    .metric-card.total::before { background: var(--accent); }
    .metric-card.total .metric-value { color: var(--accent); }
    
    .metric-card.shared::before { background: #8b5cf6; }
    .metric-card.shared .metric-value { color: #8b5cf6; }
    
    .metric-card.viewed::before { background: #06b6d4; }
    .metric-card.viewed .metric-value { color: #06b6d4; }
    
    .metric-card.accepted::before { background: #10b981; }
    .metric-card.accepted .metric-value { color: #10b981; }
    
    .metric-card.declined::before { background: #ef4444; }
    .metric-card.declined .metric-value { color: #ef4444; }
    
    .metric-card.pending::before { background: #f59e0b; }
    .metric-card.pending .metric-value { color: #f59e0b; }
    
    /* View Toggle & Toolbar */
    .pipeline-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    
    .view-toggle {
      display: flex;
      background: var(--bg-toggle);
      border-radius: 10px;
      padding: 3px;
      border: 1px solid var(--border-secondary);
    }
    
    .view-toggle-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .view-toggle-btn:hover {
      color: var(--text-primary);
    }
    
    .view-toggle-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 2px 8px rgba(var(--accent-rgb), 0.4);
    }
    
    .view-toggle-btn svg {
      width: 14px;
      height: 14px;
    }
    
    .toolbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .toolbar-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      border: 1px solid var(--border-secondary);
      background: var(--bg-option-card);
      color: var(--text-secondary);
      font-size: 11px;
      font-weight: 600;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .toolbar-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .toolbar-btn.active {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .toolbar-btn svg {
      width: 14px;
      height: 14px;
    }
    
    /* Kanban Board */
    .kanban-board {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
      min-height: 400px;
    }
    
    @media (max-width: 900px) {
      .kanban-board {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 600px) {
      .kanban-board {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      
      .kanban-column {
        max-height: 300px;
      }
    }
    
    .kanban-column {
      display: flex;
      flex-direction: column;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 14px;
      min-height: 200px;
      max-height: 500px;
    }
    
    .kanban-column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--border-secondary);
      position: sticky;
      top: 0;
      background: var(--bg-option-card);
      border-radius: 14px 14px 0 0;
      z-index: 1;
    }
    
    .kanban-column-title {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .kanban-column-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }
    
    .kanban-column-name {
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    
    .kanban-column-count {
      font-size: 11px;
      font-weight: 700;
      padding: 2px 8px;
      background: var(--bg-toggle);
      border-radius: 10px;
      color: var(--text-muted);
    }
    
    .kanban-column-body {
      flex: 1;
      padding: 10px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .kanban-column-body::-webkit-scrollbar { width: 4px; }
    .kanban-column-body::-webkit-scrollbar-track { background: transparent; }
    .kanban-column-body::-webkit-scrollbar-thumb { background: var(--border-secondary); border-radius: 2px; }
    
    /* Kanban Card (compact) */
    .kanban-card {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .kanban-card:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    }
    
    .kanban-card.starred {
      border-color: #fbbf24;
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.2);
    }
    
    .kanban-card.stale {
      border-color: #ef4444;
      background: rgba(239, 68, 68, 0.05);
    }
    
    .kanban-card.archived {
      opacity: 0.5;
    }
    
    .kanban-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    
    .kanban-card-title {
      font-size: 13px;
      font-weight: 700;
      color: var(--text-primary);
      line-height: 1.3;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .kanban-card-star {
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
      flex-shrink: 0;
    }
    
    .kanban-card-star:hover {
      color: #fbbf24;
      transform: scale(1.1);
    }
    
    .kanban-card-star.active {
      color: #fbbf24;
      filter: drop-shadow(0 0 4px rgba(251, 191, 36, 0.5));
    }
    
    .kanban-card-star svg {
      width: 14px;
      height: 14px;
    }
    
    .kanban-card-amount {
      font-size: 15px;
      font-weight: 800;
      color: var(--accent);
      margin-bottom: 6px;
    }
    
    .kanban-card-meta {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    
    .kanban-card-date {
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .kanban-card-stale {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 6px;
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border-radius: 4px;
    }
    
    /* Tags System */
    .offer-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 6px;
    }
    
    .offer-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 2px 8px;
      border-radius: 10px;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      cursor: default;
    }
    
    .offer-tag.hot-lead {
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .offer-tag.renewal {
      background: rgba(16, 185, 129, 0.15);
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    
    .offer-tag.referral {
      background: rgba(139, 92, 246, 0.15);
      color: #a78bfa;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }
    
    .offer-tag.follow-up {
      background: rgba(245, 158, 11, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(245, 158, 11, 0.3);
    }
    
    .offer-tag.vip {
      background: rgba(236, 72, 153, 0.15);
      color: #f472b6;
      border: 1px solid rgba(236, 72, 153, 0.3);
    }
    
    /* Tag Picker Dropdown */
    .tag-picker {
      position: relative;
      display: inline-block;
    }
    
    .tag-picker-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 6px;
      border: 1px dashed var(--border-secondary);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tag-picker-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      border-style: solid;
    }
    
    .tag-picker-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .tag-picker-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      margin-top: 4px;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 6px;
      min-width: 120px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.3);
      z-index: 100;
      display: none;
    }
    
    .tag-picker-dropdown.show {
      display: block;
    }
    
    .tag-picker-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.15s;
    }
    
    .tag-picker-option:hover {
      background: var(--bg-option-card);
    }
    
    .tag-picker-option.selected {
      background: var(--accent-glow);
    }
    
    /* Star Button in List View */
    .offer-star-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .offer-star-btn:hover {
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.1);
    }
    
    .offer-star-btn.active {
      color: #fbbf24;
    }
    
    .offer-star-btn.active svg {
      fill: #fbbf24;
    }
    
    /* Archive Button */
    .offer-action-btn.archive {
      color: #8b5cf6;
    }
    
    .offer-action-btn.archive:hover {
      background: rgba(139, 92, 246, 0.15);
      border-color: #8b5cf6;
    }
    
    /* Stale Indicator on List View */
    .stale-indicator {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
      font-weight: 700;
      padding: 3px 8px;
      background: rgba(239, 68, 68, 0.15);
      color: #f87171;
      border-radius: 6px;
      margin-left: 8px;
    }
    
    .stale-indicator svg {
      width: 12px;
      height: 12px;
    }
    
    /* Activity Timeline */
    .activity-timeline {
      padding: 12px 0;
      border-top: 1px solid var(--border-secondary);
      margin-top: 8px;
    }
    
    .timeline-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 8px 0;
      position: relative;
    }
    
    .timeline-item:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 11px;
      top: 28px;
      bottom: -8px;
      width: 2px;
      background: var(--border-secondary);
    }
    
    .timeline-dot {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: var(--bg-toggle);
      border: 2px solid var(--border-secondary);
    }
    
    .timeline-dot svg {
      width: 12px;
      height: 12px;
    }
    
    .timeline-dot.created { border-color: var(--text-muted); color: var(--text-muted); }
    .timeline-dot.sent { border-color: #8b5cf6; color: #8b5cf6; }
    .timeline-dot.viewed { border-color: #06b6d4; color: #06b6d4; }
    .timeline-dot.accepted { border-color: #10b981; color: #10b981; background: rgba(16, 185, 129, 0.15); }
    .timeline-dot.declined { border-color: #ef4444; color: #ef4444; background: rgba(239, 68, 68, 0.15); }
    
    .timeline-content {
      flex: 1;
    }
    
    .timeline-event {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .timeline-time {
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    /* Volume Chart */
    .volume-chart-container {
      border-radius: 14px;
      padding: 16px 0;
      margin-bottom: 16px;
    }
    
    .volume-chart-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 16px;
    }
    
    .volume-chart-title {
      font-size: 12px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-secondary);
    }
    
    .volume-chart-period {
      display: flex;
      gap: 4px;
    }
    
    .volume-chart-period button {
      padding: 4px 10px;
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 600;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .volume-chart-period button:hover {
      color: var(--text-primary);
    }
    
    .volume-chart-period button.active {
      background: var(--accent);
      color: #fff;
    }
    
    .volume-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 6px;
      height: 80px;
      padding-top: 20px;
    }
    
    .volume-bar-wrap {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .volume-bar {
      width: 100%;
      max-width: 40px;
      background: var(--accent);
      border-radius: 4px 4px 0 0;
      min-height: 4px;
      transition: height 0.3s ease;
      position: relative;
    }
    
    .volume-bar:hover {
      filter: brightness(1.2);
    }
    
    .volume-bar-label {
      font-size: 9px;
      color: var(--text-muted);
      font-weight: 600;
    }
    
    .volume-bar-value {
      position: absolute;
      top: -18px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 10px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .volume-bar-wrap:hover .volume-bar-value {
      color: var(--accent);
    }
    
    /* Enhanced Stats Row */
    .enhanced-stats {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    
    @media (max-width: 700px) {
      .enhanced-stats {
        grid-template-columns: repeat(3, 1fr);
      }
    }
    
    @media (max-width: 500px) {
      .enhanced-stats {
        grid-template-columns: repeat(2, 1fr);
      }
    }
    
    .enhanced-stat {
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      padding: 10px 8px;
      text-align: center;
    }
    
    .enhanced-stat-value {
      font-size: 18px;
      font-weight: 800;
      color: var(--text-primary);
    }
    
    .enhanced-stat-label {
      font-size: 8px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-top: 4px;
    }
    
    /* Funded status */
    .offer-status-badge.funded {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(6, 182, 212, 0.2));
      color: #34d399;
      border: 1px solid rgba(16, 185, 129, 0.5);
      box-shadow: 0 0 16px rgba(16, 185, 129, 0.3);
    }
    
    .metric-card.funded::before { background: linear-gradient(90deg, #10b981, #06b6d4); }
    .metric-card.funded .metric-value { color: #10b981; }
    
    /* Search Bar */
    .dashboard-search-wrap {
      position: relative;
      margin-bottom: 16px;
    }
    
    .dashboard-search-wrap input {
      width: 100%;
      padding: 12px 16px 12px 44px;
      border-radius: 12px;
      border: 1px solid var(--border-primary);
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 500;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .dashboard-search-wrap input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow), 0 0 16px rgba(var(--accent-rgb), 0.15);
    }
    
    .dashboard-search-wrap input::placeholder {
      color: var(--text-muted);
    }
    
    .dashboard-search-wrap svg {
      position: absolute;
      left: 14px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
      width: 18px;
      height: 18px;
      transition: color 0.2s;
    }
    
    .dashboard-search-wrap input:focus + svg,
    .dashboard-search-wrap:focus-within svg {
      color: var(--accent);
    }
    
    /* Offer List */
    .offer-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    /* Offer Card */
    .offer-card {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      border-radius: 16px;
      padding: 16px 18px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .offer-card:hover {
      border-color: var(--accent);
      box-shadow: 0 0 28px rgba(var(--accent-rgb), 0.12), 0 8px 24px -8px rgba(0, 0, 0, 0.3);
      transform: translateY(-1px);
    }
    
    .offer-card-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .offer-card-title {
      flex: 1;
      min-width: 0;
    }
    
    .offer-card-title h3 {
      font-size: 15px;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0 0 4px 0;
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .offer-card-title .iso-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      background: var(--accent-glow);
      color: var(--accent);
      border-radius: 20px;
      border: 1px solid rgba(var(--accent-rgb), 0.3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .offer-card-title .lender-tag {
      font-size: 9px;
      font-weight: 700;
      padding: 3px 8px;
      background: rgba(99, 102, 241, 0.15);
      color: #818cf8;
      border-radius: 20px;
      border: 1px solid rgba(99, 102, 241, 0.3);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    
    .offer-card-title .sub-info {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }
    
    /* Status Badge */
    .offer-status-badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .offer-status-badge.accepted {
      background: rgba(52, 211, 153, 0.15);
      color: #34d399;
      border: 1px solid rgba(52, 211, 153, 0.4);
      box-shadow: 0 0 12px rgba(52, 211, 153, 0.25);
    }
    
    .offer-status-badge.declined {
      background: rgba(248, 113, 113, 0.15);
      color: #f87171;
      border: 1px solid rgba(248, 113, 113, 0.4);
      box-shadow: 0 0 12px rgba(248, 113, 113, 0.25);
    }
    
    .offer-status-badge.viewed {
      background: rgba(34, 211, 238, 0.15);
      color: #22d3ee;
      border: 1px solid rgba(34, 211, 238, 0.4);
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.25);
    }
    
    .offer-status-badge.sent {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.4);
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.25);
    }
    
    .offer-status-badge.locked {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
      border: 1px solid rgba(251, 191, 36, 0.4);
      box-shadow: 0 0 12px rgba(251, 191, 36, 0.25);
    }
    
    .offer-status-badge.draft {
      background: var(--bg-toggle);
      color: var(--text-muted);
      border: 1px solid var(--border-primary);
    }
    
    .offer-status-badge.client-shared {
      background: rgba(6, 182, 212, 0.15);
      color: #06b6d4;
      border: 1px solid rgba(6, 182, 212, 0.4);
      box-shadow: 0 0 12px rgba(6, 182, 212, 0.25);
    }
    
    .offer-status-badge.client-viewed {
      background: rgba(34, 211, 238, 0.15);
      color: #22d3ee;
      border: 1px solid rgba(34, 211, 238, 0.4);
      box-shadow: 0 0 12px rgba(34, 211, 238, 0.25);
    }
    
    .offer-status-badge.iso-shared {
      background: rgba(168, 85, 247, 0.15);
      color: #a855f7;
      border: 1px solid rgba(168, 85, 247, 0.4);
      box-shadow: 0 0 12px rgba(168, 85, 247, 0.25);
    }
    
    .offer-status-badge.iso-viewed {
      background: rgba(99, 102, 241, 0.15);
      color: #6366f1;
      border: 1px solid rgba(99, 102, 241, 0.4);
      box-shadow: 0 0 12px rgba(99, 102, 241, 0.25);
    }
    
    /* Stats Row */
    .offer-stats {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 12px 14px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    
    .offer-stat {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .offer-stat-label {
      font-size: 9px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: var(--text-muted);
    }
    
    .offer-stat-value {
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
    }
    
    .offer-stat-value.profit {
      color: var(--accent);
      text-shadow: 0 0 10px rgba(var(--accent-rgb), 0.4);
    }
    
    .offer-stat-divider {
      width: 1px;
      height: 24px;
      background: var(--border-secondary);
    }
    
    /* Tracking Progress - Horizontal Pipeline */
    .offer-tracking {
      display: flex;
      align-items: flex-start;
      padding: 12px 14px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 10px;
      margin-bottom: 12px;
      overflow-x: auto;
      gap: 0;
    }
    
    .tracking-stage {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      flex-shrink: 0;
      min-width: 48px;
    }
    
    .tracking-icon {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-toggle);
      border: 2px solid var(--border-secondary);
      opacity: 0.35;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      color: var(--text-muted);
    }
    
    .tracking-icon svg {
      width: 14px;
      height: 14px;
    }
    
    .tracking-label {
      font-size: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
      color: var(--text-muted);
      opacity: 0.4;
      transition: all 0.25s;
      white-space: nowrap;
      text-align: center;
      line-height: 1.2;
    }
    
    .tracking-icon.complete {
      opacity: 1;
      transform: scale(1.05);
    }
    
    .tracking-stage.complete .tracking-label {
      opacity: 1;
    }
    
    /* Stage Colors - Distinct progression palette */
    .tracking-icon.complete.locked { 
      background: rgba(251, 191, 36, 0.15); 
      border-color: #fbbf24;
      box-shadow: 0 0 10px rgba(251, 191, 36, 0.3);
      color: #fbbf24;
    }
    .tracking-stage.complete.locked .tracking-label { color: #fbbf24; }
    
    .tracking-icon.complete.iso-share { 
      background: rgba(168, 85, 247, 0.15); 
      border-color: #a855f7;
      box-shadow: 0 0 10px rgba(168, 85, 247, 0.3);
      color: #a855f7;
    }
    .tracking-stage.complete.iso-share .tracking-label { color: #a855f7; }
    
    .tracking-icon.complete.iso-view { 
      background: rgba(99, 102, 241, 0.15); 
      border-color: #6366f1;
      box-shadow: 0 0 10px rgba(99, 102, 241, 0.3);
      color: #6366f1;
    }
    .tracking-stage.complete.iso-view .tracking-label { color: #6366f1; }
    
    .tracking-icon.complete.client-share { 
      background: rgba(6, 182, 212, 0.15); 
      border-color: #06b6d4;
      box-shadow: 0 0 10px rgba(6, 182, 212, 0.3);
      color: #06b6d4;
    }
    .tracking-stage.complete.client-share .tracking-label { color: #06b6d4; }
    
    .tracking-icon.complete.client-view { 
      background: rgba(34, 211, 238, 0.15); 
      border-color: #22d3ee;
      box-shadow: 0 0 10px rgba(34, 211, 238, 0.3);
      color: #22d3ee;
    }
    .tracking-stage.complete.client-view .tracking-label { color: #22d3ee; }
    
    .tracking-icon.complete.rejected { 
      background: rgba(248, 113, 113, 0.15); 
      border-color: #f87171;
      box-shadow: 0 0 10px rgba(248, 113, 113, 0.3);
      color: #f87171;
    }
    .tracking-stage.complete.rejected .tracking-label { color: #f87171; }
    
    .tracking-icon.complete.accepted { 
      background: rgba(52, 211, 153, 0.15); 
      border-color: #34d399;
      box-shadow: 0 0 10px rgba(52, 211, 153, 0.3);
      color: #34d399;
    }
    .tracking-stage.complete.accepted .tracking-label { color: #34d399; }
    
    .tracking-line {
      flex: 1;
      height: 2px;
      min-width: 12px;
      max-width: 28px;
      background: var(--border-secondary);
      border-radius: 2px;
    }
    
    /* Detailed Tracking View */
    .tracking-detailed {
      display: none;
      flex-direction: column;
      gap: 0;
      padding: 16px;
      background: var(--bg-option-card);
      border: 1px solid var(--border-secondary);
      border-radius: 12px;
      margin-top: 8px;
    }
    
    .tracking-detailed.show {
      display: flex;
    }
    
    .tracking-detail-row {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 10px 0;
      position: relative;
    }
    
    .tracking-detail-row:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 17px;
      top: 42px;
      bottom: -10px;
      width: 2px;
      background: var(--border-secondary);
    }
    
    .tracking-detail-row.complete:not(:last-child)::after {
      background: linear-gradient(to bottom, currentColor 0%, var(--border-secondary) 100%);
    }
    
    .tracking-detail-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-toggle);
      border: 2px solid var(--border-secondary);
      flex-shrink: 0;
      opacity: 0.4;
      color: var(--text-muted);
      z-index: 1;
    }
    
    .tracking-detail-icon svg {
      width: 16px;
      height: 16px;
    }
    
    .tracking-detail-row.complete .tracking-detail-icon {
      opacity: 1;
    }
    
    .tracking-detail-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    
    .tracking-detail-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      opacity: 0.5;
    }
    
    .tracking-detail-row.complete .tracking-detail-label {
      opacity: 1;
    }
    
    .tracking-detail-time {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    .tracking-detail-status {
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--bg-toggle);
      color: var(--text-muted);
    }
    
    .tracking-detail-row.complete .tracking-detail-status {
      background: rgba(16, 185, 129, 0.15);
      color: #10b981;
    }
    
    .tracking-detail-row.pending .tracking-detail-status {
      background: rgba(251, 191, 36, 0.15);
      color: #fbbf24;
    }
    
    /* Detail row colors when complete */
    .tracking-detail-row.complete.locked .tracking-detail-icon {
      background: rgba(251, 191, 36, 0.15);
      border-color: #fbbf24;
      color: #fbbf24;
    }
    .tracking-detail-row.complete.locked { color: #fbbf24; }
    
    .tracking-detail-row.complete.iso-share .tracking-detail-icon {
      background: rgba(168, 85, 247, 0.15);
      border-color: #a855f7;
      color: #a855f7;
    }
    .tracking-detail-row.complete.iso-share { color: #a855f7; }
    
    .tracking-detail-row.complete.iso-view .tracking-detail-icon {
      background: rgba(99, 102, 241, 0.15);
      border-color: #6366f1;
      color: #6366f1;
    }
    .tracking-detail-row.complete.iso-view { color: #6366f1; }
    
    .tracking-detail-row.complete.client-share .tracking-detail-icon {
      background: rgba(6, 182, 212, 0.15);
      border-color: #06b6d4;
      color: #06b6d4;
    }
    .tracking-detail-row.complete.client-share { color: #06b6d4; }
    
    .tracking-detail-row.complete.client-view .tracking-detail-icon {
      background: rgba(34, 211, 238, 0.15);
      border-color: #22d3ee;
      color: #22d3ee;
    }
    .tracking-detail-row.complete.client-view { color: #22d3ee; }
    
    .tracking-detail-row.complete.rejected .tracking-detail-icon {
      background: rgba(248, 113, 113, 0.15);
      border-color: #f87171;
      color: #f87171;
    }
    .tracking-detail-row.complete.rejected { color: #f87171; }
    
    .tracking-detail-row.complete.accepted .tracking-detail-icon {
      background: rgba(52, 211, 153, 0.15);
      border-color: #34d399;
      color: #34d399;
    }
    .tracking-detail-row.complete.accepted { color: #34d399; }
    
    /* Toggle button for details */
    .tracking-toggle {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 6px 12px;
      margin-top: 8px;
      background: transparent;
      border: 1px solid var(--border-secondary);
      border-radius: 6px;
      color: var(--text-muted);
      font-size: 11px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tracking-toggle:hover {
      background: var(--bg-toggle);
      color: var(--text-primary);
    }
    
    .tracking-toggle svg {
      width: 12px;
      height: 12px;
      transition: transform 0.2s;
    }
    
    .tracking-toggle.expanded svg {
      transform: rotate(180deg);
    }
    
    .tracking-line.complete {
      height: 2px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      box-shadow: 0 0 8px rgba(var(--accent-rgb), 0.5);
    }
    
    /* Offer Actions */
    .offer-actions {
      display: flex;
      gap: 6px;
    }
    
    .offer-action-btn {
      padding: 6px 10px;
      border-radius: 8px;
      border: 1px solid var(--border-primary);
      background: var(--bg-card);
      color: var(--text-secondary);
      font-size: 10px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .offer-action-btn svg {
      width: 12px;
      height: 12px;
    }
    
    .offer-action-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.2);
    }
    
    .offer-action-btn.delete:hover {
      border-color: #ef4444;
      color: #ef4444;
      background: rgba(239, 68, 68, 0.1);
      box-shadow: 0 0 12px rgba(239, 68, 68, 0.2);
    }
    
    /* Empty State */
    .dashboard-empty {
      text-align: center;
      padding: 60px 24px;
      color: var(--text-muted);
    }
    
    .dashboard-empty svg {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      opacity: 0.3;
      color: var(--accent);
    }
    
    .dashboard-empty h3 {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-secondary);
      margin: 0 0 8px 0;
    }
    
    .dashboard-empty p {
      font-size: 13px;
      margin: 0;
    }
    
    .clear-all-btn {
      cursor: pointer;
      border: none;
      background: transparent;
    }
    
    .clear-all-btn:hover {
      color: #ef4444 !important;
      background: rgba(239, 68, 68, 0.1);
    }

    /* Rainbow mode: Allow ONLY color transitions, kill everything else */
    html.rainbow-mode *,
    html.rainbow-mode *::before,
    html.rainbow-mode *::after {
      transition: color 0.8s ease, background-color 0.8s ease, border-color 0.8s ease, box-shadow 0.8s ease, fill 0.8s ease, stroke 0.8s ease !important;
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8 flex justify-center">

  <!-- SVG GRADIENT DEFINITION -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" class="gradient-start" style="stop-color:var(--accent)"/>
        <stop offset="100%" class="gradient-end" style="stop-color:var(--accent-light)"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- WELCOME SCREEN -->
  <div id="welcomeScreen" class="welcome-screen">
    <div class="welcome-card">
      <!-- Icon -->
      <a href="index.html" class="welcome-logo header-logo" title="Back to Home">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <!-- Back half of ring (behind planet) -->
          <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
          <!-- Planet -->
          <circle cx="32" cy="32" r="12" fill="#eab308"/>
          <!-- Front half of ring (in front of planet) -->
          <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
          <!-- Orbiting moon -->
          <circle class="orbiting-moon" cx="32" cy="32" r="4" fill="#a855f7"/>
        </svg>
      </a>
      
      <!-- Title -->
      <h1 class="welcome-title">Ables<span style="color: #888;">AI</span></h1>
      <p class="welcome-subtitle">&nbsp;</p>
      
      <!-- Form -->
      <div class="welcome-form">
        <input type="text" id="welcomeUsername" class="welcome-input" placeholder="Username" autocomplete="username" />
        <input type="password" id="welcomePassword" class="welcome-input" placeholder="Password" autocomplete="current-password" />
        <div id="welcomeError" class="welcome-error">Invalid username or password</div>
        <!-- Mode Toggle -->
        <div class="welcome-toggle-wrapper flex items-center overflow-hidden" style="padding: 4px;">
          <button id="welcomeLenderModeBtn" onclick="setClientModeWelcome('lender')" class="mode-toggle-btn welcome-toggle-btn flex items-center gap-2 transition-all" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border-radius: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Lender
          </button>
          <button id="welcomeIsoModeBtn" onclick="setClientModeWelcome('iso')" class="mode-toggle-btn welcome-toggle-btn active flex items-center gap-2 transition-all" style="padding: 12px 16px; font-size: 14px; font-weight: 600; border-radius: 8px;">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 16px; height: 16px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            ISO
          </button>
        </div>
        <button onclick="handleWelcomeLogin()" class="welcome-btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
          </svg>
          Sign In
          <span class="pro-badge">PRO</span>
        </button>
      </div>
      
      <!-- Divider -->
      <div class="welcome-divider">or</div>
      
      <!-- Free Version Button -->
      <button onclick="continueAsFree()" class="welcome-btn-secondary">
          Continue
          <span class="lite-badge">LITE</span>
        </button>
      
      <!-- Features -->
      <div class="welcome-features">
        <div class="welcome-features-title">WHAT'S INCLUDED</div>
        <div class="welcome-feature">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          Create unlimited funding offers
        </div>
        <div class="welcome-feature">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          Share via link or email
        </div>
        <div class="welcome-feature">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          Multiple theme options
        </div>
        <div class="welcome-feature locked">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Custom branding (Pro only)
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (for unlocking brand section later) -->
  <div id="loginModal" class="login-modal-overlay">
    <div class="login-modal">
      <button onclick="closeLoginModal()" class="login-close-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- Content -->
      <div class="login-modal-content">
        <!-- Icon -->
        <div class="login-modal-icon header-logo" style="justify-content: center;">
          <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <!-- Back half of ring (behind planet) -->
            <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
            <!-- Planet -->
            <circle cx="32" cy="32" r="12" fill="#eab308"/>
            <!-- Front half of ring (in front of planet) -->
            <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
            <!-- Orbiting moon -->
            <circle class="orbiting-moon" cx="32" cy="32" r="4" fill="#a855f7"/>
          </svg>
        </div>
        
        <!-- Title -->
        <h2 class="login-modal-title">Ables<span style="color: #888;">AI</span></h2>
        <p class="login-modal-subtitle">&nbsp;</p>
        
        <!-- Form -->
        <form class="login-form" id="loginForm">
          <input type="text" id="loginUsername" class="login-input" placeholder="Username" autocomplete="username" required />
          <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password" required />
          <div id="loginError" class="login-error">Invalid username or password</div>
          <button type="button" onclick="handleLogin()" class="login-btn" style="flex-direction: column; gap: 6px;">
            <span style="display: flex; align-items: center; gap: 8px;">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              Sign In
            </span>
            <span style="background: rgba(0,0,0,0.3); padding: 2px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em;">PRO</span>
          </button>
        </form>
        
        <!-- Divider -->
        <div class="login-divider">
          <span>or</span>
        </div>
        
        <!-- Free Version Button -->
        <button onclick="closeLoginModal()" class="login-free-btn" style="flex-direction: column; gap: 6px;">
          <span>Continue</span>
          <span style="background: rgba(255,255,255,0.15); padding: 2px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em;">LITE</span>
        </button>
        
        <!-- Features -->
        <div class="login-features">
          <div class="login-features-title">WHAT'S INCLUDED</div>
          <div class="login-feature">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Create unlimited funding offers
          </div>
          <div class="login-feature">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Share via link or email
          </div>
          <div class="login-feature">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Multiple theme options
          </div>
          <div class="login-feature login-feature-locked">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            Custom branding (Pro only)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD MODAL -->
  <div id="dashboardModal" class="dashboard-modal hidden">
    <div class="dashboard-backdrop" onclick="closeDashboard()"></div>
    <div class="dashboard-content">
      <div class="dashboard-header">
        <div class="dashboard-title">
          <svg xmlns="http://www.w3.org/2000/svg" style="width: 20px; height: 20px;" viewBox="0 0 24 24" fill="none" stroke="var(--accent)" stroke-width="1.5">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
            <path d="M9 12l2 2 4-4" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h2>Offer Pipeline</h2>
        </div>
        <div class="header-actions">
          <button type="button" id="clearAllBtn" class="offer-action-btn delete" style="padding: 6px 10px; font-size: 10px;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Clear
          </button>
          <button onclick="closeDashboard()" class="offer-action-btn" style="padding: 6px;">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <div class="dashboard-body">
        <!-- Enhanced Stats Row -->
        <div id="enhancedStats" class="enhanced-stats">
          <!-- Populated by JS -->
        </div>
        
        <!-- Volume Chart -->
        <div id="volumeChartContainer" class="volume-chart-container">
          <div class="volume-chart-header">
            <span class="volume-chart-title">Offer Volume</span>
            <div class="volume-chart-period">
              <button onclick="setChartPeriod('week')" class="active">Week</button>
              <button onclick="setChartPeriod('month')">Month</button>
            </div>
          </div>
          <div id="volumeChart" class="volume-chart">
            <!-- Populated by JS -->
          </div>
        </div>
        
        <!-- Toolbar -->
        <div class="pipeline-toolbar">
          <div class="view-toggle">
            <button onclick="setPipelineView('list')" class="view-toggle-btn active" id="listViewBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 10h16M4 14h16M4 18h16" />
              </svg>
              List
            </button>
            <button onclick="setPipelineView('kanban')" class="view-toggle-btn" id="kanbanViewBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 17V7m0 10a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2h2a2 2 0 012 2m0 10a2 2 0 002 2h2a2 2 0 002-2M9 7a2 2 0 012-2h2a2 2 0 012 2m0 10V7m0 10a2 2 0 002 2h2a2 2 0 002-2V7a2 2 0 00-2-2h-2a2 2 0 00-2 2" />
              </svg>
              Kanban
            </button>
          </div>
          <div class="toolbar-actions">
            <button onclick="toggleShowArchived()" class="toolbar-btn" id="showArchivedBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" />
              </svg>
              Archived
            </button>
            <button onclick="toggleShowStarred()" class="toolbar-btn" id="showStarredBtn">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
              </svg>
              Starred
            </button>
          </div>
        </div>
        
        <div class="dashboard-search-wrap">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
          </svg>
          <input type="text" id="dashboardSearch" placeholder="Search offers..." oninput="filterDashboardOffers()">
        </div>
        
        <!-- List View Container -->
        <div id="offersTableContainer" class="offer-list">
          <!-- Offers rendered by JS -->
        </div>
        
        <!-- Kanban View Container -->
        <div id="kanbanContainer" class="kanban-board hidden">
          <div class="kanban-column" data-stage="draft">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: var(--text-muted);"></div>
                <span class="kanban-column-name">Draft</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-draft">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-draft"></div>
          </div>
          <div class="kanban-column" data-stage="sent">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: #8b5cf6;"></div>
                <span class="kanban-column-name">Sent</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-sent">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-sent"></div>
          </div>
          <div class="kanban-column" data-stage="viewed">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: #06b6d4;"></div>
                <span class="kanban-column-name">Viewed</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-viewed">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-viewed"></div>
          </div>
          <div class="kanban-column" data-stage="accepted">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: #10b981;"></div>
                <span class="kanban-column-name">Accepted</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-accepted">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-accepted"></div>
          </div>
          <div class="kanban-column" data-stage="funded">
            <div class="kanban-column-header">
              <div class="kanban-column-title">
                <div class="kanban-column-dot" style="background: linear-gradient(135deg, #10b981, #06b6d4);"></div>
                <span class="kanban-column-name">Funded</span>
              </div>
              <span class="kanban-column-count" id="kanban-count-funded">0</span>
            </div>
            <div class="kanban-column-body" id="kanban-funded"></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- WRAPPER -->
  <div class="w-full max-w-7xl">

      <!-- ========================================== -->
      <!-- ADMIN PANEL                                -->
      <!-- ========================================== -->
      <div id="adminPanel">
          <!-- Floating Preview Button -->
          <button id="floatingPreviewBtn" onclick="openFloatingPreview()" class="fixed bottom-6 right-6 z-40 w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg" style="background: var(--accent); color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'" title="Preview Client View">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
              </svg>
          </button>
          
          <!-- HEADER -->
          <header class="header-main flex flex-wrap items-center justify-between gap-3 mb-4 py-2 sticky top-0 z-30" style="background: var(--bg-card); position: relative;">
                <!-- Logo and Title -->
                <div class="header-brand header-logo header-logo-sm flex items-center gap-2">
                    <a href="index.html" class="transition-transform hover:scale-105" title="Back to Home">
                        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                          <!-- Back half of ring (behind planet) -->
                          <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140"/>
                          <!-- Planet -->
                          <circle cx="32" cy="32" r="12" fill="#eab308"/>
                          <!-- Front half of ring (in front of planet) -->
                          <ellipse cx="32" cy="32" rx="28" ry="8" stroke="#ea580c" stroke-width="2.5" fill="none" transform="rotate(-20 32 32)" stroke-dasharray="70 140" stroke-dashoffset="-70"/>
                          <!-- Orbiting moon -->
                          <circle class="orbiting-moon" cx="32" cy="32" r="4" fill="#a855f7"/>
                        </svg>
                    </a>
                    <h1>Ables<span>AI</span></h1>
                </div>
                <div id="userBadge" class="user-badge hidden" style="cursor: pointer;" onclick="handleLogout()" title="Click to logout">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="userBadgeName">User</span>
                </div>
                <!-- Mode Toggle -->
                <div id="modeToggleContainer" class="header-mode-toggle flex items-center rounded-full overflow-hidden" style="background: var(--accent-glow); border: 1px solid var(--accent); padding: 6px 4px;">
                    <button id="lenderModeBtn" onclick="setClientMode('lender')" class="mode-toggle-btn flex items-center gap-1.5 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
                        <span id="lenderStatusIcon" class="hidden" style="color: #f59e0b;">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                            </svg>
                        </span>
                        Lender
                    </button>
                    <div style="width: 1px; height: 14px; background: var(--accent); opacity: 0.3; margin: 0 4px;"></div>
                    <button id="isoModeBtn" onclick="setClientMode('iso')" class="mode-toggle-btn active flex items-center gap-1.5 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
                        <span id="isoStatusIcon" class="hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                        </span>
                        ISO
                    </button>
                    <div style="width: 1px; height: 14px; background: var(--accent); opacity: 0.3; margin: 0 4px;"></div>
                    <button id="clientModeBtn" onclick="previewClientView()" class="mode-toggle-btn flex items-center gap-1.5 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
                        <span id="clientStatusIcon" class="hidden">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                            </svg>
                        </span>
                        Client
                    </button>
                </div>
                
                <!-- Action Buttons -->
                <div class="header-actions flex items-center gap-2">
                    <!-- Pipeline Button -->
                    <button id="dashboardBtn" onclick="openDashboard()" class="h-8 px-3 rounded-full flex items-center justify-center gap-2 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span class="btn-text">Pipeline</span>
                        <span id="offerCount" class="offer-count-badge hidden">0</span>
                    </button>
                    
                    <!-- Settings Button -->
                    <div class="theme-picker relative">
                        <button id="settingsBtn" onclick="toggleThemeDropdown()" class="h-8 px-3 rounded-full flex items-center justify-center gap-2 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            <span class="btn-text">Settings</span>
                        </button>
                        <div id="themeDropdown" class="theme-dropdown">
                            <!-- Theme Mode Section -->
                            <div class="theme-section-title">Theme</div>
                            <div class="theme-mode-toggle">
                                <button onclick="setThemeMode('light')" class="theme-mode-btn" data-mode="light">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    Light
                                </button>
                                <button onclick="setThemeMode('dark')" class="theme-mode-btn" data-mode="dark">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                    </svg>
                                    Dark
                                </button>
                                <button onclick="setThemeMode('black')" class="theme-mode-btn" data-mode="black">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" />
                                    </svg>
                                    Black
                                </button>
                            </div>
                            
                            <!-- Lender Rate Settings (shown in lender mode) -->
                            <div id="lenderRateSettings" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                                    <!-- Tier Preset Customization -->
                                    <div class="theme-section-title">Rate Tiers</div>
                                    <p class="text-xs mb-3" style="color: var(--text-muted);">Customize preset tiers (Buy / Max Sell)</p>
                                    
                                    <!-- Tier A -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span class="text-xs font-bold" style="color: var(--text-secondary); width: 45px;">Tier A</span>
                                        <input type="number" id="tierABuy" step="0.01" min="1.00" max="1.99" value="1.15"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('A')" />
                                        <span class="text-xs" style="color: var(--text-muted);">/</span>
                                        <input type="number" id="tierAMax" step="0.01" min="1.00" max="1.99" value="1.25"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('A')" />
                                    </div>
                                    
                                    <!-- Tier B -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span class="text-xs font-bold" style="color: var(--text-secondary); width: 45px;">Tier B</span>
                                        <input type="number" id="tierBBuy" step="0.01" min="1.00" max="1.99" value="1.25"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('B')" />
                                        <span class="text-xs" style="color: var(--text-muted);">/</span>
                                        <input type="number" id="tierBMax" step="0.01" min="1.00" max="1.99" value="1.35"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('B')" />
                                    </div>
                                    
                                    <!-- Tier C -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="text-xs font-bold" style="color: var(--text-secondary); width: 45px;">Tier C</span>
                                        <input type="number" id="tierCBuy" step="0.01" min="1.00" max="1.99" value="1.35"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('C')" />
                                        <span class="text-xs" style="color: var(--text-muted);">/</span>
                                        <input type="number" id="tierCMax" step="0.01" min="1.00" max="1.99" value="1.45"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('C')" />
                                    </div>
                                </div>
                            
                            <!-- Brand Section (Locked when not logged in) -->
                            <div id="brandSection" class="brand-section locked" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary); position: relative;">
                                <div class="brand-lock-overlay">
                                    <button onclick="openLoginModal()" class="brand-lock-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                        Unlock
                                    </button>
                                </div>
                                
                                <div class="brand-content">
                                    <div class="theme-section-title" style="display: flex; align-items: center; gap: 6px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                        </svg>
                                        Brand
                                    </div>
                                    
                                    <!-- Company Name Input -->
                                    <div style="margin-bottom: 16px;">
                                        <label class="block text-xs font-medium mb-2" style="color: var(--text-secondary);">Company Name</label>
                                        <input 
                                            type="text" 
                                            id="companyNameInput" 
                                            class="logo-input" 
                                            placeholder="Your Company Name"
                                            oninput="updateCompanyName(this.value)"
                                            maxlength="50"
                                        />
                                    </div>
                                    
                                    <!-- Logo URL Input -->
                                    <div>
                                        <label class="block text-xs font-medium mb-2" style="color: var(--text-secondary);">Company Logo</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="text" 
                                                id="logoUrlInput" 
                                                class="logo-input flex-1" 
                                                placeholder="https://example.com/logo.png"
                                                oninput="updateLogoPreview(this.value)"
                                            />
                                            <button onclick="updateLogoPreview($('logoUrlInput').value)" class="px-3 py-2 rounded-lg text-xs font-semibold" style="background: var(--accent); color: white;">Load</button>
                                        </div>
                                        <div id="logoPreviewSmall" class="logo-preview-small">
                                            <span class="logo-preview-placeholder">Logo preview will appear here</span>
                                        </div>
                                        <div id="clearLogoBtn" class="clear-logo-btn hidden" onclick="clearLogo()">
                                            ✕ Remove Logo
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Accent Color Section -->
                            <div class="theme-section-title" style="margin-top: 16px;">Accent Color</div>
                            <div class="color-swatches">
                                <div onclick="setAccentColor('mint')" class="color-swatch swatch-mint" data-accent="mint" title="Mint"></div>
                                <div onclick="setAccentColor('blue')" class="color-swatch swatch-blue" data-accent="blue" title="Blue"></div>
                                <div onclick="setAccentColor('purple')" class="color-swatch swatch-purple" data-accent="purple" title="Purple"></div>
                                <div onclick="setAccentColor('rainbow')" class="color-swatch swatch-rainbow" data-accent="rainbow" title="Rainbow"></div>
                                <div onclick="setAccentColor('orange')" class="color-swatch swatch-orange" data-accent="orange" title="Orange"></div>
                                <div onclick="setAccentColor('cyan')" class="color-swatch swatch-cyan" data-accent="cyan" title="Cyan"></div>
                                <div onclick="setAccentColor('gold')" class="color-swatch swatch-gold" data-accent="gold" title="Gold"></div>
                                <div onclick="setAccentColor('slate')" class="color-swatch swatch-slate" data-accent="slate" title="Slate"></div>
                                <div onclick="setAccentColor('lime')" class="color-swatch swatch-lime" data-accent="lime" title="Forest"></div>
                                <div onclick="setAccentColor('teal')" class="color-swatch swatch-teal" data-accent="teal" title="Navy"></div>
                                <div onclick="setAccentColor('pink')" class="color-swatch swatch-pink" data-accent="pink" title="Burgundy"></div>
                                <div onclick="setAccentColor('indigo')" class="color-swatch swatch-indigo" data-accent="indigo" title="Steel"></div>
                            </div>
                            
                            <!-- Reset Button -->
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                                <button onclick="resetBrandKit()" class="w-full text-xs font-semibold py-2 px-3 rounded-lg transition-all" style="color: var(--text-muted); background: var(--bg-option-card);" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Reset Theme
                                </button>
                                
                                <!-- Save as Favorite Button (logged-in users only) -->
                                <button id="saveFavoriteBtn" onclick="saveFavoriteTheme()" class="w-full text-xs font-semibold py-2 px-3 rounded-lg transition-all hidden" style="margin-top: 8px; color: var(--accent); background: var(--bg-option-card); border: 1px solid var(--accent);" onmouseover="this.style.background='var(--accent)'; this.style.color='white'" onmouseout="this.style.background='var(--bg-option-card)'; this.style.color='var(--accent)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                    </svg>
                                    Save as Favorite
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Preview Dropdown -->
                    <div class="preview-picker relative">
                        <button id="previewBtn" onclick="togglePreviewDropdown()" class="h-8 px-3 rounded-full flex items-center justify-center gap-2 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            <span class="btn-text">Preview</span>
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 10px; height: 10px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="previewDropdown" class="preview-dropdown">
                            <button onclick="previewClientView(); togglePreviewDropdown();" class="preview-option">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <div>
                                    <div class="preview-option-title">Client Preview</div>
                                    <div class="preview-option-desc">See what your client sees</div>
                                </div>
                            </button>
                            <button id="isoPreviewOption" onclick="previewISOView(); togglePreviewDropdown();" class="preview-option hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <div>
                                    <div class="preview-option-title">ISO Preview</div>
                                    <div class="preview-option-desc">See what your ISO partner sees</div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Share Button -->
                    <button onclick="shareOffer()" class="share-btn h-8 px-3 rounded-full flex items-center justify-center gap-2 font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                        </svg>
                        <span class="btn-text">Share</span>
                    </button>
                </div>
          </header>

          <!-- ISO Preview Bar (shows in admin panel during ISO preview mode) -->
          <div id="isoPreviewBar" class="hidden p-4 fixed top-0 left-0 right-0 z-50 flex justify-between items-center shadow-xl" style="background: #0d3d2e; border-bottom: 1px solid #10b981;">
              <span class="font-bold text-sm uppercase tracking-wider flex items-center gap-2" style="color: #10b981;">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  ISO Preview Mode
              </span>
              <div class="flex items-center gap-3">
                  <span class="text-xs" style="color: var(--text-muted);">This is what your ISO partner sees</span>
                  <button onclick="exitISOPreview()" class="text-xs font-bold px-4 py-2 rounded-lg transition-all" style="background: #10b981; color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">Back to Editor</button>
              </div>
          </div>

          <!-- ADMIN GRID -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
              
              <!-- LEFT: INPUTS -->
              <div class="lg:col-span-7 space-y-6 order-2 lg:order-1">
                
                <!-- Client Info Card -->
                <div class="card p-6 mobile-collapsible collapsed" id="clientInfoCard">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('clientInfoCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Client Information</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="section-content mt-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold mb-2 ml-1" style="color: var(--text-muted);">Business Name</label>
                                <input id="calcBusinessName" type="text" class="w-full p-3.5 border rounded-xl input-field text-sm font-medium" placeholder="e.g. Acme Corporation LLC" value="Acme Corporation LLC" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-2 ml-1" style="color: var(--text-muted);">Contact Name</label>
                                <input id="calcContactName" type="text" class="w-full p-3.5 border rounded-xl input-field text-sm font-medium" placeholder="First Last" value="First Last" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms Card -->
                <div class="card p-6 mobile-collapsible" id="structureOfferCard">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('structureOfferCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Structure Offer</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="section-content">
                    <!-- Tabs -->
                    <div class="flex gap-2 border-b mb-8 mt-4" style="border-color: var(--border-primary);">
                        <button id="tab-btn-0" class="calc-tab active px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(0)">Option A</button>
                        <button id="tab-btn-1" class="calc-tab hidden px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(1)">Option B</button>
                        <button id="tab-btn-2" class="calc-tab hidden px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(2)">Option C</button>
                        <div class="ml-auto flex items-center gap-2">
                            <button onclick="resetCalculator()" class="text-xs font-bold px-3 py-2 rounded-lg transition-colors" style="color: var(--text-muted);" onmouseover="this.style.background='var(--bg-option-card)'; this.style.color='var(--text-secondary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-muted)'" title="Reset Calculator">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Reset
                            </button>
                            <button id="add-tab-btn" class="text-xs font-bold px-3 py-2 rounded-lg transition-colors" style="color: var(--accent);" onmouseover="this.style.background='var(--accent-glow)'" onmouseout="this.style.background='transparent'" onclick="addCalcOption()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                                Add Option
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-8 fade-enter">
                        <!-- Funding Amount Slider -->
                        <div class="rounded-2xl p-6 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Funding Amount</label>
                                <button id="remove-option-btn" onclick="removeCalcOption()" class="text-xs hidden font-bold hover:underline flex items-center gap-1" style="color: #ef4444;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    Remove
                                </button>
                            </div>
                            <div class="flex items-baseline gap-1.5 mb-5">
                                <span class="font-semibold text-xl" style="color: var(--text-muted);">$</span>
                                <input id="calcAmount" type="text" class="w-full bg-transparent border-none p-0 text-4xl font-extrabold focus:ring-0 focus:outline-none" style="color: var(--text-primary);" value="50,000" />
                            </div>
                            <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="slider w-full" />
                            <div class="flex justify-between text-[10px] font-semibold mt-2 uppercase tracking-wider" style="color: var(--text-muted);">
                                <span>$5k</span>
                                <span>$1M</span>
                            </div>
                        </div>
                        
                        <!-- Factor & Term Sliders -->
                        <div id="factorTermGrid" class="grid grid-cols-1 gap-6">
                            <div id="factorRateCard" class="option-card hidden">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Factor Rate</label>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="calcFactor" type="number" step="0.01" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">PTR</span>
                                </div>
                                <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="slider w-full" />
                            </div>
                            <div class="option-card">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Term Length</label>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="calcTerm" type="number" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="130" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">Pmts</span>
                                </div>
                                <input id="calcTermSlider" type="range" min="5" max="520" step="1" value="130" class="slider w-full" />
                            </div>
                            
                            <!-- Payment Frequency -->
                            <div class="option-card">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Payment Frequency</label>
                                <div class="toggle-group inline-flex w-full">
                                    <button class="toggle-btn active flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="daily" onclick="setFrequency('daily')">Daily</button>
                                    <button class="toggle-btn flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="weekly" onclick="setFrequency('weekly')">Weekly</button>
                                    <button class="toggle-btn flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="monthly" onclick="setFrequency('monthly')">Monthly</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lender Mode: Rate Settings -->
                        <div id="lenderRateSection" class="hidden">
                            <div class="option-card">
                                <div class="flex items-center justify-between mb-4">
                                    <label class="text-xs font-bold uppercase tracking-wide" style="color: var(--accent);">Lender Rate Settings</label>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" style="background: var(--accent); color: var(--accent-text);">Lender Mode</span>
                                </div>
                                
                                <!-- Tier Presets -->
                                <div class="mb-4">
                                    <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Rate Tier Presets</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setLenderTier(1)" id="tierBtn1" class="tier-preset-btn active p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--accent);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier A</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.15 / 1.25</span>
                                        </button>
                                        <button onclick="setLenderTier(2)" id="tierBtn2" class="tier-preset-btn p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier B</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.25 / 1.35</span>
                                        </button>
                                        <button onclick="setLenderTier(3)" id="tierBtn3" class="tier-preset-btn p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier C</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.35 / 1.45</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Buy Rate -->
                                    <div>
                                        <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Buy Rate (ISO)</label>
                                        <div class="flex items-center justify-between mb-2 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <input id="lenderBuyRate" type="number" step="0.01" min="1.05" max="1.60" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.15" />
                                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">BUY</span>
                                        </div>
                                        <input id="lenderBuyRateSlider" type="range" min="1.05" max="1.60" step="0.01" value="1.15" class="slider w-full" />
                                    </div>
                                    
                                    <!-- Max Sell Rate -->
                                    <div>
                                        <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Max Sell Rate (ISO Ceiling)</label>
                                        <div class="flex items-center justify-between mb-2 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <input id="lenderMaxSell" type="number" step="0.01" min="1.10" max="1.70" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">MAX</span>
                                        </div>
                                        <input id="lenderMaxSellSlider" type="range" min="1.10" max="1.70" step="0.01" value="1.25" class="slider w-full" />
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4 p-3 rounded-lg" style="background: var(--bg-card);">
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Max Upsell</p>
                                        <p id="lenderMaxSpread" class="text-lg font-bold" style="color: var(--accent);">0.24</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Max ISO Profit</p>
                                        <p id="lenderMaxProfit" class="text-lg font-bold" style="color: #10b981;">$0</p>
                                    </div>
                                </div>
                                
                                <button id="lockShareISOBtn" onclick="shareWithISO()" class="w-full py-3 px-4 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 transition-all" style="background: var(--accent); color: var(--accent-text);">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                    </svg>
                                    <span id="lockShareISOText">Lock and Share with ISO</span>
                                </button>
                                
                                <!-- Unlock button (hidden by default) -->
                                <button id="unlockISOBtn" onclick="unlockTerms()" class="hidden w-full py-3 px-4 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 transition-all mt-2" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-secondary);">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                                    </svg>
                                    Unlock All Options
                                </button>
                            </div>
                        </div>
                        
                        <!-- ISO Mode: Upsell Slider (when opened via shared link) -->
                        <div id="isoUpsellSection" class="hidden">
                            <div class="option-card">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-xs font-bold uppercase tracking-wide" style="color: #10b981;">Rate</label>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" style="background: #10b981; color: white;">ISO Mode</span>
                                </div>
                                <p class="text-xs mb-3" style="color: var(--text-muted);">Adjust your sell rate to set your profit margin</p>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="isoSellRate" type="number" step="0.01" min="1.05" max="1.70" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">SELL</span>
                                </div>
                                <input id="isoSellRateSlider" type="range" min="1.05" max="1.70" step="0.01" value="1.25" class="slider w-full" />
                                <div class="grid grid-cols-3 gap-2 mt-4 pt-4" style="border-top: 1px solid var(--border-secondary);">
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Buy Rate</p>
                                        <p id="isoBuyRateDisplay" class="text-sm font-bold" style="color: var(--text-primary);">1.15</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Upsell</p>
                                        <p id="isoSpreadDisplay" class="text-sm font-bold" style="color: #10b981;">0.10</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Your Profit</p>
                                        <p id="isoProfitDisplay" class="text-sm font-bold" style="color: #10b981;">$0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                </div> <!-- end structureOfferCard -->
                
                <!-- Offer Options Card (Collapsible on Mobile) -->
                <div id="offerOptionsCard" class="card p-6 mobile-collapsible collapsed">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('offerOptionsCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Offer Options</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="section-content mt-6">
                <!-- Options Grid - 2x3 -->
                <div class="grid grid-cols-2 gap-3">
                <!-- Origination Fee Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #ec4899, #db2777);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Origination Fee</span>
                        </div>
                        <label class="switch">
                            <input id="toggleFee" type="checkbox" onchange="toggleSection('Fee', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secFee" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <div class="flex items-center gap-3">
                            <input id="calcFee" type="number" step="0.5" min="0" max="15" class="w-16 border rounded-lg p-2 text-sm font-bold text-center outline-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" value="0" oninput="setVal('calcFeeSlider', this.value); updateSliderFill($('calcFeeSlider')); updatePreview()" />
                            <span class="text-sm font-bold" style="color: var(--text-muted);">%</span>
                            <input id="calcFeeSlider" type="range" min="0" max="15" step="0.5" value="0" class="slider h-1.5 flex-1" oninput="setVal('calcFee', this.value); updatePreview(); updateSliderFill(this);" />
                        </div>
                    </div>
                </div>
                
                <!-- Prepay Discount Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #14b8a6, #0d9488);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Prepay Discount</span>
                        </div>
                        <label class="switch">
                            <input id="togglePrepay" type="checkbox" onchange="toggleSection('Prepay', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secPrepay" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div class="flex items-center gap-2">
                                <input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-14 border rounded-lg p-2 text-sm font-bold text-center outline-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" value="0" oninput="setVal('calcPrepaySlider', this.value); updateSliderFill($('calcPrepaySlider')); updatePreview()" />
                                <span class="text-xs font-bold" style="color: var(--text-muted);">%</span>
                            </div>
                            <input id="calcPrepayDate" type="date" class="w-full border rounded-lg p-2 text-xs font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" onchange="updatePreview()" />
                        </div>
                        <input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="slider h-1.5 w-full" oninput="setVal('calcPrepay', this.value); updatePreview(); updateSliderFill(this);" />
                    </div>
                </div>
                
                <!-- Custom Term Label Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Custom Term Label</span>
                        </div>
                        <label class="switch">
                            <input id="toggleOverride" type="checkbox" onchange="toggleSection('Override', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secOverride" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcTermOverride" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. 6 Months" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Offer Expiration Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Offer Expiration</span>
                        </div>
                        <label class="switch">
                            <input id="toggleExpiry" type="checkbox" onchange="toggleSection('Expiry', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secExpiry" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcExpiryDate" type="date" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" onchange="updatePreview()" />
                    </div>
                </div>
                
                <!-- ISO Name Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">ISO Name</span>
                        </div>
                        <label class="switch">
                            <input id="toggleISO" type="checkbox" onchange="toggleSection('ISO', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secISO" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcISOName" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. ABC Funding" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Lender Name Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #6366f1);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Lender Name</span>
                        </div>
                        <label class="switch">
                            <input id="toggleLender" type="checkbox" onchange="toggleSection('Lender', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secLender" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcLenderName" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. XYZ Capital" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Offer Notes Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Offer Notes</span>
                        </div>
                        <label class="switch">
                            <input id="toggleNotes" type="checkbox" onchange="toggleSection('Notes', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secNotes" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <textarea id="calcNotes" class="w-full border rounded-lg p-2 text-sm font-medium resize-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" rows="3" placeholder="One note per line..." oninput="updatePreview()"></textarea>
                    </div>
                </div>
                
                <!-- Closing Documents Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Closing Documents</span>
                        </div>
                        <label class="switch">
                            <input id="toggleDocs" type="checkbox" onchange="toggleSection('Docs', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secDocs" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <textarea id="calcDocs" class="w-full border rounded-lg p-2 text-sm font-medium resize-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" rows="3" oninput="updatePreview()">Voided Check
Government Issued ID</textarea>
                    </div>
                </div>
                </div> <!-- end 2x3 grid -->
                    </div> <!-- end section-content -->
                </div> <!-- end offerOptionsCard -->
              </div>

              <!-- RIGHT: PREVIEW -->
              <div id="previewColumn" class="lg:col-span-5 order-1 lg:order-2">
                  <div class="preview-sticky-wrapper">
                      <!-- Sticky Action Bar (Desktop Only) -->
                      <div id="stickyActionBar" class="flex flex-wrap items-center justify-center gap-2 mb-4 p-2 rounded-2xl" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <!-- Settings Button -->
                          <div class="theme-picker-sticky relative">
                              <button onclick="toggleThemeDropdownSticky()" class="h-8 px-2 rounded-full flex items-center justify-center gap-1.5 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                                  <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                  </svg>
                                  Settings
                              </button>
                          </div>
                          
                          <!-- Offers Button -->
                          <button onclick="openDashboard()" class="h-8 px-2 rounded-full flex items-center justify-center gap-1.5 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                              </svg>
                              Offers
                              <span id="stickyOfferCount" class="offer-count-badge hidden">0</span>
                          </button>
                          
                          <!-- Preview Button -->
                          <div class="preview-picker-sticky relative">
                              <button onclick="togglePreviewDropdownSticky()" class="h-8 px-2 rounded-full flex items-center justify-center gap-1.5 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                                  <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                                  </svg>
                                  Preview
                                  <svg xmlns="http://www.w3.org/2000/svg" style="width: 10px; height: 10px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                      <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                                  </svg>
                              </button>
                              <div id="previewDropdownSticky" class="preview-dropdown">
                                  <button onclick="previewClientView(); togglePreviewDropdownSticky();" class="preview-option">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                      </svg>
                                      <div>
                                          <div class="preview-option-title">Client Preview</div>
                                          <div class="preview-option-desc">See what your client sees</div>
                                      </div>
                                  </button>
                                  <button id="isoPreviewOptionSticky" onclick="previewISOView(); togglePreviewDropdownSticky();" class="preview-option hidden">
                                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                          <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                      </svg>
                                      <div>
                                          <div class="preview-option-title">ISO Preview</div>
                                          <div class="preview-option-desc">See what your ISO partner sees</div>
                                      </div>
                                  </button>
                              </div>
                          </div>
                          
                          <!-- Share Button -->
                          <button onclick="shareOffer()" class="share-btn h-8 px-2 rounded-full flex items-center justify-center gap-1.5 font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 11px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                              <svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                              </svg>
                              Share
                          </button>
                      </div>
                      
                      <!-- Preview Card -->
                      <div class="preview-card">
                        
                        <!-- Header -->
                        <div class="preview-header p-8 pb-10 text-center">
                          <div class="relative z-10 pt-2">
                            <!-- Logo Container -->
                            <div id="previewLogoContainer" class="preview-logo-container hidden">
                                <img id="previewLogo" src="" alt="Company Logo" class="preview-logo mx-auto" referrerpolicy="no-referrer" />
                            </div>
                            <div id="previewCompanyName" class="company-name-display hidden"></div>
                            
                            <div id="previewLabelContainer" class="mb-5 hidden">
                                <span id="previewOptionLabel" class="option-badge inline-block text-[10px] font-bold uppercase tracking-widest px-4 py-1.5 rounded-full">Option A</span>
                            </div>
                            <div id="previewBusinessName" class="business-name-display mt-2 mb-4 hidden"></div>
                            
                            <span class="text-[11px] font-bold uppercase tracking-widest block mb-3" style="color: var(--text-muted);">You Get</span>
                            <span id="previewAmount" class="amount-display block editable-value" contenteditable="true" data-field="amount">$50,000</span>
                          </div>
                        </div>
                        
                        <!-- Chart Section -->
                        <div class="px-8 py-10 flex items-center justify-center gap-8" style="background: linear-gradient(to bottom, var(--bg-card), var(--bg-option-card));">
                           <div class="relative w-36 h-36 flex-shrink-0">
                              <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                              </svg>
                              <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-[10px] font-bold uppercase tracking-wide" style="color: var(--text-muted);">Payback</span>
                                <span id="previewPaybackChart" class="text-base font-bold block tracking-tight mt-0.5" style="color: var(--text-primary);">$62,500</span>
                              </div>
                           </div>
                           <div class="space-y-3 text-xs">
                               <div class="flex items-center gap-2.5">
                                 <span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
                                 <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
                               </div>
                               <div class="flex items-center gap-2.5">
                                 <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
                                 <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
                               </div>
                           </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="border-t" style="border-color: var(--border-secondary); background: var(--bg-option-card);">
                          <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                            <div class="stat-cell">
                              <span class="stat-label">Term Length</span>
                              <span id="previewTermLength" class="stat-value editable-value" contenteditable="true" data-field="termLength">6 months</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Payments</span>
                              <span id="previewTermPayments" class="stat-value editable-value" contenteditable="true" data-field="payments">130</span>
                            </div>
                          </div>
                          <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                            <div class="stat-cell">
                              <span class="stat-label">Factor Rate</span>
                              <span id="previewFactor" class="stat-value font-mono editable-value" contenteditable="true" data-field="factor">1.19x</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Total Cost</span>
                              <span id="previewCost" class="stat-value">$12,500</span>
                            </div>
                          </div>
                          
                          <div id="previewFeeRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(251, 191, 36, 0.1);">
                            <div class="stat-cell">
                              <span class="stat-label">Origination Fee</span>
                              <span id="previewFeeAmount" class="stat-value">$0</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Net Proceeds</span>
                              <span id="previewNet" class="stat-value">$50,000</span>
                            </div>
                          </div>
                          
                          <div id="previewPrepayRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(34, 197, 94, 0.1);">
                            <div class="stat-cell" style="grid-column: span 2;">
                              <span class="stat-label">Prepay Discount</span>
                              <span id="previewPrepay" class="stat-value" style="color: #22c55e;">10% off if paid early</span>
                            </div>
                          </div>

                          <!-- Payment Display - GRADIENT REMOVED -->
                          <div class="p-8 text-center" style="background: var(--bg-card);">
                            <div>
                                <span id="previewPaymentLabel" class="text-[10px] font-bold block uppercase tracking-widest mb-2" style="color: var(--text-muted);">Daily Payment</span>
                                <span id="previewPayment" class="text-3xl font-extrabold tracking-tight" style="color: var(--text-primary);">$480.77</span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="p-4 text-center border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                              <button onclick="openAmortSchedule()" class="text-xs font-bold flex items-center justify-center gap-1.5 mx-auto group transition-colors" style="color: var(--accent);">
                                  <span>View Payment Schedule</span>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                              </button>
                        </div>

                      </div>
                      
                      <!-- Admin Preview: Notes Section -->
                      <div id="previewNotesSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                              <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Offer Notes</h4>
                          </div>
                          <ul id="previewNotesList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                      
                      <!-- Admin Preview: Docs Section -->
                      <div id="previewDocsSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                              <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Closing Documents</h4>
                          </div>
                          <ul id="previewDocsList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                      
                      <!-- Admin Preview: Expiration Section (at bottom) -->
                      <div id="previewExpirySection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                              <div>
                                  <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Offer Expiration</h4>
                                  <p class="text-sm" style="color: var(--text-secondary);">Expires <span id="previewExpiryDate" class="font-bold" style="color: var(--accent);"></span></p>
                              </div>
                          </div>
                      </div>
                      
                      <div id="previewSourceSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                              <div class="flex-1">
                                  <h4 class="font-bold text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Source Info</h4>
                                  <div class="flex flex-wrap gap-2">
                                      <span id="previewISOTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(var(--accent-rgb), 0.3);"></span>
                                      <span id="previewLenderTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3);"></span>
                                  </div>
                              </div>
                          </div>
                      </div>
                      
                  </div>
              </div>
          </div>
      </div>
      
      <!-- ========================================== -->
      <!-- CLIENT PANEL                               -->
      <!-- ========================================== -->
      <div id="clientPanel" class="hidden w-full max-w-4xl mx-auto mt-6">
          <div id="clientPreviewBar" class="hidden p-4 fixed top-0 left-0 right-0 z-50 flex justify-between items-center shadow-xl" style="background: #1e1e3f; border-bottom: 1px solid #6366f1;">
              <span class="font-bold text-sm uppercase tracking-wider flex items-center gap-2" style="color: #6366f1;">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                  Client Preview Mode
              </span>
              <div class="flex items-center gap-3">
                  <span class="text-xs" style="color: var(--text-muted);">This is what your client sees</span>
                  <button onclick="exitPreview()" class="text-xs font-bold px-4 py-2 rounded-lg transition-all" style="background: #6366f1; color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">Back to Editor</button>
              </div>
          </div>
          
          <div class="text-center mb-10">
              <!-- Trust Badge -->
              <div class="trust-badge inline-flex items-center gap-3 px-5 py-2.5 rounded-full mb-8">
                  <div class="trust-badge-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.749.749 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.352-.114-2.662-.334-3.908a.75.75 0 00-.722-.515 11.208 11.208 0 01-7.877-3.08zm3.134 7.09a.75.75 0 00-1.06-1.06L11 11.79l-1.09-1.09a.75.75 0 00-1.06 1.06l1.62 1.62a.75.75 0 001.06 0l4.12-4.12z" clip-rule="evenodd" />
                      </svg>
                  </div>
                  <span class="trust-badge-text"><span class="trust-badge-accent">TrustBureau</span> Verified</span>
              </div>
              
              <h1 id="clientGreeting" class="text-3xl font-extrabold mb-3" style="color: var(--text-primary);">Hello, Business Owner</h1>
              <p style="color: var(--text-muted);" class="max-w-lg mx-auto text-sm">Your business <span id="clientBusinessName" class="font-semibold" style="color: var(--text-primary);"></span> has been pre-approved for funding.</p>
          </div>

          <!-- Client Card -->
          <div class="max-w-md mx-auto relative">
              <div class="preview-card">
                  
                  <!-- Header -->
                  <div class="preview-header p-8 pb-10 text-center">
                    <div class="relative z-10 pt-2">
                      <!-- Logo Container -->
                      <div id="cPreviewLogoContainer" class="preview-logo-container hidden">
                          <img id="cPreviewLogo" src="" alt="Company Logo" class="preview-logo mx-auto" referrerpolicy="no-referrer" />
                      </div>
                      <div id="cPreviewCompanyName" class="company-name-display hidden"></div>
                      
                      <!-- Option Tabs -->
                      <div id="clientTabsContainer" class="flex justify-center gap-2 mb-6 hidden"></div>
                      <div id="cPreviewLabelContainer" class="mb-5 hidden">
                          <span id="cPreviewOptionLabel" class="option-badge inline-block text-[10px] font-bold uppercase tracking-widest px-4 py-1.5 rounded-full">Option A</span>
                      </div>

                      <span class="text-[11px] font-bold uppercase tracking-widest block mb-3" style="color: var(--text-muted);">You Get</span>
                      <span id="cPreviewAmount" class="amount-display block">$50,000</span>
                      
                      <!-- Amount Slider -->
                      <div class="mt-10 px-2 relative z-20">
                          <input id="clientAmountSlider" type="range" class="slider slider-dark w-full" />
                          <div class="flex justify-between text-[10px] font-bold mt-3 uppercase tracking-widest" style="color: var(--text-muted);">
                              <span>$5k</span>
                              <span id="clientMaxLabelSlider">Max</span>
                          </div>
                      </div>

                    </div>
                  </div>

                  <!-- Chart Section -->
                  <div class="px-8 py-10 flex items-center justify-center gap-8" style="background: linear-gradient(to bottom, var(--bg-card), var(--bg-option-card));">
                     <div class="relative w-36 h-36 flex-shrink-0">
                        <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                          <path id="cPreviewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                          <span class="text-[10px] font-bold uppercase tracking-wide" style="color: var(--text-muted);">Payback</span>
                          <span id="cPreviewPayback" class="text-base font-bold block tracking-tight mt-0.5" style="color: var(--text-primary);">$62,500</span>
                        </div>
                     </div>
                     <div class="space-y-3 text-xs">
                         <div class="flex items-center gap-2.5">
                           <span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
                           <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
                         </div>
                         <div class="flex items-center gap-2.5">
                           <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
                           <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
                         </div>
                     </div>
                  </div>

                  <!-- Stats Grid -->
                  <div class="border-t" style="border-color: var(--border-secondary); background: var(--bg-option-card);">
                      <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                        <div class="stat-cell">
                          <span class="stat-label">Term Length</span>
                          <span id="cPreviewTerm" class="stat-value">6 months</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Payments</span>
                          <span id="cPreviewCount" class="stat-value">130</span>
                        </div>
                      </div>
                      <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                        <div class="stat-cell">
                          <span class="stat-label">Factor Rate</span>
                          <span id="cPreviewFactor" class="stat-value font-mono">1.19x</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Total Cost</span>
                          <span id="cPreviewCost" class="stat-value">$12,500</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewFeeRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(251, 191, 36, 0.1);">
                        <div class="stat-cell">
                          <span class="stat-label">Origination Fee</span>
                          <span id="cPreviewFee" class="stat-value">$0</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Net Proceeds</span>
                          <span id="cPreviewNet" class="stat-value">$50,000</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewPrepayRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(34, 197, 94, 0.1);">
                        <div class="stat-cell" style="grid-column: span 2;">
                          <span class="stat-label">Prepay Discount</span>
                          <span id="cPreviewPrepay" class="stat-value" style="color: #22c55e;">10% off if paid early</span>
                        </div>
                      </div>

                      <!-- Payment Display - GRADIENT REMOVED -->
                      <div class="p-8 text-center" style="background: var(--bg-card);">
                          <div>
                              <span id="cPreviewPaymentLabel" class="text-[10px] font-bold block uppercase tracking-widest mb-2" style="color: var(--text-muted);">Daily Payment</span>
                              <span id="cPreviewPayment" class="text-3xl font-extrabold tracking-tight" style="color: var(--text-primary);">$480.77</span>
                          </div>
                      </div>
                  </div>

                  <!-- View Schedule Link -->
                  <div class="p-4 text-center border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                      <button onclick="openAmortSchedule()" class="text-xs font-bold flex items-center justify-center gap-1.5 mx-auto group transition-colors" style="color: var(--accent);">
                          <span>View Payment Schedule</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                      </button>
                  </div>

                  <!-- Accept Button -->
                  <div class="p-6 border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                      <button onclick="acceptOffer()" class="btn btn-primary w-full py-4 rounded-xl text-base font-bold flex items-center justify-center gap-2.5">
                          <span>Accept Offer & Proceed</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                      </button>
                      <p class="text-center text-[10px] mt-3 font-medium" style="color: var(--text-muted);">Clicking accept is non-binding.</p>
                      <button onclick="declineOffer()" class="w-full mt-3 py-2 text-xs font-medium rounded-lg border transition-all hover:border-red-500 hover:text-red-500" style="color: var(--text-muted); border-color: var(--border-secondary); background: transparent;">
                          Decline Offer
                      </button>
                  </div>

              </div>

              <!-- Terms & Documents - Separate Sections -->
              <div id="clientTermsContainer" class="mt-8 px-2 max-w-2xl mx-auto space-y-4 hidden">
                  
                  <!-- Notes & Documents - Side by Side -->
                  <div id="clientNotesDocsRow" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                      <!-- Notes Section -->
                      <div id="clientNotesSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                              <h4 class="font-bold text-sm" style="color: var(--text-primary);">Offer Notes</h4>
                          </div>
                          <ul id="clientNotesList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>

                      <!-- Documents Section -->
                      <div id="clientDocsSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                              <h4 class="font-bold text-sm" style="color: var(--text-primary);">Closing Documents</h4>
                          </div>
                          <ul id="clientDocsList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                  </div>
                  
                  <!-- Expiration Section - At bottom -->
                  <div id="clientExpirySection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                      <div class="flex items-center gap-3">
                          <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                          <p class="text-sm" style="color: var(--text-secondary);">This offer expires on <span id="clientExpiryDate" class="font-bold" style="color: var(--accent);">December 31, 2024</span></p>
                      </div>
                  </div>
                  
                  <!-- Source Info Section -->
                  <div id="clientSourceSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                      <div class="flex items-center gap-3">
                          <div class="section-indicator" style="background: linear-gradient(135deg, #06b6d4, #0891b2);"></div>
                          <div class="flex-1">
                              <h4 class="font-bold text-xs uppercase tracking-wider mb-2" style="color: var(--text-muted);">Source Info</h4>
                              <div class="flex flex-wrap gap-2">
                                  <span id="clientISOTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: var(--accent-glow); color: var(--accent); border: 1px solid rgba(var(--accent-rgb), 0.3);"></span>
                                  <span id="clientLenderTag" class="hidden text-xs font-bold px-3 py-1 rounded-full" style="background: rgba(99, 102, 241, 0.15); color: #818cf8; border: 1px solid rgba(99, 102, 241, 0.3);"></span>
                              </div>
                          </div>
                      </div>
                  </div>

              </div>

          </div>
      </div>

  </div>

  <!-- ========================================== -->
  <!-- MODALS                                     -->
  <!-- ========================================== -->
  
  <!-- Success Modal -->
  <div id="successModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-md shadow-2xl p-8 text-center relative overflow-hidden">
      <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(to bottom, var(--accent-glow), transparent);"></div>
      
      <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 relative z-10 shadow-lg" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
      </div>
      
      <h3 class="text-2xl font-extrabold mb-3 relative z-10" style="color: var(--text-primary);">Offer Accepted!</h3>
      <p class="mb-8 relative z-10 text-sm leading-relaxed" style="color: var(--text-secondary);">Great news! Your pre-approval has been registered. Please contact your funding representative immediately to finalize the documents and receive your funds.</p>
      
      <div class="relative z-10">
          <button onclick="$('successModal').classList.add('hidden')" class="btn btn-primary w-full py-3.5 rounded-xl font-bold">
              Close
          </button>
      </div>
    </div>
  </div>

  <!-- Amortization Modal -->
  <div id="amortModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
      <div class="p-5 border-b flex justify-between items-center" style="background: var(--bg-option-card); border-color: var(--border-primary);">
          <h3 class="font-bold" style="color: var(--text-primary);">Payment Schedule</h3>
          <button onclick="$('amortModal').classList.add('hidden')" class="p-1 rounded-lg transition-colors" style="color: var(--text-muted);" onmouseover="this.style.background='var(--bg-option-card)'" onmouseout="this.style.background='transparent'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
      </div>
      <div class="overflow-y-auto p-0 flex-1">
          <table class="w-full text-sm amort-table">
              <thead>
                  <tr>
                      <th class="px-6 py-4 text-left">#</th>
                      <th class="px-6 py-4 text-left">Date</th>
                      <th class="px-6 py-4 text-right">Payment</th>
                      <th class="px-6 py-4 text-right">Balance</th>
                  </tr>
              </thead>
              <tbody id="amortTableBody" class="divide-y" style="border-color: var(--border-secondary);"></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl w-full max-w-lg p-6 text-center" style="background: var(--bg-card); border: 1px solid var(--border-primary); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);">
      <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-bold" style="color: var(--text-primary);">Share Offer</h3>
        <button onclick="$('shareModal').classList.add('hidden')" class="w-8 h-8 rounded-lg flex items-center justify-center transition-all" style="background: var(--bg-card-inner); color: var(--text-muted);" onmouseover="this.style.color='var(--text-primary)'" onmouseout="this.style.color='var(--text-muted)'">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="grid grid-cols-3 gap-3">
          <button onclick="copyLink()" class="share-option group p-4 rounded-xl flex flex-col items-center justify-center gap-3 transition-all" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center transition-all" style="background: rgba(59, 130, 246, 0.1); color: #3b82f6;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>
              </div>
              <div>
                <p class="text-xs font-bold mb-0.5" style="color: var(--text-primary);">Link</p>
                <p class="text-[10px]" style="color: var(--text-muted);">Copy URL</p>
              </div>
          </button>
          <button onclick="copySMS()" class="share-option group p-4 rounded-xl flex flex-col items-center justify-center gap-3 transition-all" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center transition-all" style="background: rgba(16, 185, 129, 0.1); color: #10b981;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" /></svg>
              </div>
              <div>
                <p class="text-xs font-bold mb-0.5" style="color: var(--text-primary);">SMS</p>
                <p class="text-[10px]" style="color: var(--text-muted);">Text message</p>
              </div>
          </button>
          <button onclick="copyText()" class="share-option group p-4 rounded-xl flex flex-col items-center justify-center gap-3 transition-all" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
              <div class="w-10 h-10 rounded-xl flex items-center justify-center transition-all" style="background: rgba(139, 92, 246, 0.1); color: #8b5cf6;">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg>
              </div>
              <div>
                <p class="text-xs font-bold mb-0.5" style="color: var(--text-primary);">Email</p>
                <p class="text-[10px]" style="color: var(--text-muted);">HTML template</p>
              </div>
          </button>
      </div>
    </div>
  </div>

  <!-- Floating Preview Modal -->
  <div id="floatingPreviewModal" class="fixed inset-0 z-50 hidden" style="background: rgba(0,0,0,0.85); backdrop-filter: blur(8px);">
    <div class="absolute top-4 right-4 flex items-center gap-3 z-10">
      <button onclick="copyLinkFromPreview()" class="px-4 py-2 rounded-lg font-semibold text-sm flex items-center gap-2 transition-all" style="background: var(--accent); color: white;">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
        Copy Link
      </button>
      <button onclick="closeFloatingPreview()" class="w-10 h-10 rounded-full flex items-center justify-center transition-all" style="background: rgba(255,255,255,0.1); color: white;" onmouseover="this.style.background='rgba(255,255,255,0.2)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="flex items-start justify-center h-full p-4 pt-16 overflow-y-auto">
      <!-- Preview Frame -->
      <div class="relative w-full max-w-2xl">
        <div class="rounded-2xl overflow-hidden" style="background: #121212; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5), 0 0 0 1px rgba(255,255,255,0.1);">
          <!-- Screen -->
          <div id="floatingPreviewContent" class="overflow-y-auto" style="max-height: 80vh;">
            <!-- Client view content will be injected here -->
          </div>
        </div>
        <!-- Label -->
        <div class="text-center mt-4">
          <span class="text-xs font-semibold px-3 py-1 rounded-full" style="background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);">Client Preview</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast fixed bottom-6 right-6 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3" style="background: var(--bg-card);">
    <div class="p-1.5 rounded-full" style="background: rgba(var(--accent-rgb), 0.2);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" style="color: var(--accent);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
    </div>
    <span id="toastMessage" class="font-semibold text-sm">Success!</span>
  </div>

  <script>
    // ============================================
    // UTILITIES
    // ============================================
    const $ = (id) => document.getElementById(id);
    const $$ = (s) => document.querySelectorAll(s);
    const formatCurrency = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n);
    const parseNumber = (v) => parseFloat(v.toString().replace(/[\$,]/g, '')) || 0;
    const formatNumber = (n) => new Intl.NumberFormat('en-US').format(n);
    const getLetter = (i) => String.fromCharCode(65 + i);
    
    // Animate number spin up
    function animateNumber(element, targetValue, duration = 1500, formatter = formatCurrency) {
        // Cancel any existing animation on this element
        if (element._animationId) {
            cancelAnimationFrame(element._animationId);
        }
        
        // Ensure target value is valid and non-negative for currency
        if (typeof targetValue !== 'number' || isNaN(targetValue)) {
            targetValue = 0;
        }
        // For currency formatting, prevent negative values
        if (formatter === formatCurrency && targetValue < 0) {
            targetValue = 0;
        }
        
        // Start from current displayed value instead of always 0
        let startValue = 0;
        const currentText = element.textContent || '';
        const parsed = parseFloat(currentText.replace(/[^0-9.-]/g, ''));
        if (!isNaN(parsed) && parsed >= 0) {
            startValue = parsed;
        }
        
        const startTime = performance.now();
        const isInteger = Number.isInteger(targetValue);
        
        function easeOutExpo(t) {
            return t === 1 ? 1 : 1 - Math.pow(2, -10 * t);
        }
        
        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            const easedProgress = easeOutExpo(progress);
            let currentValue = startValue + (targetValue - startValue) * easedProgress;
            
            // Ensure non-negative for currency values
            if (formatter === formatCurrency) {
                currentValue = Math.max(0, currentValue);
            }
            
            // Only round for integer targets (amounts, counts), preserve decimals for factors
            if (isInteger) currentValue = Math.round(currentValue);
            
            element.textContent = formatter(currentValue);
            
            if (progress < 1) {
                element._animationId = requestAnimationFrame(update);
            } else {
                element._animationId = null;
            }
        }
        
        element._animationId = requestAnimationFrame(update);
    }

    // ============================================
    // THEME MANAGEMENT
    // ============================================
    let currentTheme = 'black';
    let currentAccent = 'rainbow';
    let currentLogoUrl = '';
    let currentCompanyName = '';
    let currentClientMode = 'iso';
    let lenderBuyRate = 1.15;
    let lenderMaxSellRate = 1.25;

    // Mobile collapsible sections
    function toggleMobileSection(cardId) {
        // Only toggle on mobile
        if (window.innerWidth > 768) return;
        
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.toggle('collapsed');
        }
    }
    
    // Initialize mobile sections on load
    function initMobileSections() {
        if (window.innerWidth <= 768) {
            // Keep Structure Offer expanded by default on mobile
            const structureCard = document.getElementById('structureOfferCard');
            if (structureCard) {
                structureCard.classList.remove('collapsed');
            }
        }
    }
    
    // Re-check on resize
    window.addEventListener('resize', function() {
        const collapsibles = document.querySelectorAll('.mobile-collapsible');
        if (window.innerWidth > 768) {
            // Remove collapsed class on desktop
            collapsibles.forEach(el => el.classList.remove('collapsed'));
        }
    });

    // ============================================
    // LENDER LOCK SYSTEM (Per-Option)
    // ============================================
    
    function lockTerms() {
        // Save current option state first (captures current rates for this option)
        saveState(activeCalcTab);
        
        // Lock ALL options with their INDIVIDUAL stored rates
        const lockedSummary = [];
        calcOptions.forEach((opt, i) => {
            // Use this option's stored rates, or fall back to defaults
            const optBuyRate = opt.buyRate || 1.15;
            const optMaxSell = opt.maxSell || 1.25;
            
            console.log('Locking option', i, '- buyRate:', optBuyRate, 'maxSell:', optMaxSell);
            
            opt.locked = true;
            opt.lockedAmount = opt.amount;
            opt.lockedTerm = opt.term;
            opt.lockedFrequency = opt.frequency;
            opt.lockedBuyRate = optBuyRate;
            opt.lockedMaxSell = optMaxSell;
            lockedSummary.push(`${getLetter(i)}: $${formatNumber(opt.amount)} @${optMaxSell.toFixed(2)}`);
        });
        
        console.log('All options after locking:', JSON.stringify(calcOptions.map(o => ({locked: o.locked, lb: o.lockedBuyRate, lm: o.lockedMaxSell}))));
        
        // Track lender lock event
        window.lenderLocked = true;
        updateModeStatusIcons();
        
        // Update tracking for existing offer if link exists
        const currentLink = getLink();
        updateOfferTrackingByLink(currentLink, 'lenderLock');
        
        updateLockButtonState();
        updateHeaderLockIndicator();
        updateTabsUI();
        updateLockToggleUI();
        
        showToast(`Locked: ${lockedSummary.join(', ')}`);
    }
    
    function unlockTerms() {
        // Unlock ALL options
        calcOptions.forEach((opt) => {
            opt.locked = false;
            opt.lockedAmount = null;
            opt.lockedTerm = null;
            opt.lockedFrequency = null;
            opt.lockedBuyRate = null;
            opt.lockedMaxSell = null;
        });
        
        // Reset sliders to full range
        const amountSlider = $('calcAmountSlider');
        const termSlider = $('calcTermSlider');
        const buyRateSlider = $('lenderBuyRateSlider');
        const maxSellSlider = $('lenderMaxSellSlider');
        if (amountSlider) { amountSlider.max = 1000000; updateSliderFill(amountSlider); }
        if (termSlider) { termSlider.max = 520; updateSliderFill(termSlider); }
        if (buyRateSlider) updateSliderFill(buyRateSlider);
        if (maxSellSlider) updateSliderFill(maxSellSlider);
        
        // Unlock all frequency buttons
        const dailyBtn = document.querySelector('.toggle-btn[data-freq="daily"]');
        const weeklyBtn = document.querySelector('.toggle-btn[data-freq="weekly"]');
        const monthlyBtn = document.querySelector('.toggle-btn[data-freq="monthly"]');
        [dailyBtn, weeklyBtn, monthlyBtn].forEach(btn => {
            if (btn) {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            }
        });
        
        updateLockButtonState();
        updateHeaderLockIndicator();
        updateTabsUI();
        updateLockToggleUI();
        showToast(`All options unlocked`);
    }
    
    function toggleTermsLock() {
        const opt = calcOptions[activeCalcTab];
        if (opt && opt.locked) unlockTerms();
        else lockTerms();
    }
    
    function updateLockButtonState() {
        const lockBtn = $('lockTermsBtn');
        if (!lockBtn) return;
        
        const opt = calcOptions[activeCalcTab];
        const isLocked = opt && opt.locked;
        
        if (isLocked) {
            let freqLabel = opt.lockedFrequency === 'weekly' ? 'Wk' : opt.lockedFrequency === 'monthly' ? 'Mo' : 'D';
            lockBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>
                <span>LOCKED: $${formatNumber(opt.lockedAmount)} / ${opt.lockedTerm}d / ${freqLabel}</span>
            `;
            lockBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
            lockBtn.style.border = '2px solid #10b981';
            lockBtn.style.boxShadow = '0 0 25px rgba(16, 185, 129, 0.4)';
            lockBtn.onclick = unlockTerms;
        } else {
            lockBtn.innerHTML = `
                <svg xmlns="http://www.w3.org/2000/svg" style="width: 18px; height: 18px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z" />
                </svg>
                <span>Lock Option ${getLetter(activeCalcTab)} for ISO</span>
            `;
            lockBtn.style.background = 'linear-gradient(135deg, #f59e0b, #d97706)';
            lockBtn.style.border = '2px solid #f59e0b';
            lockBtn.style.boxShadow = '0 0 20px rgba(245, 158, 7, 0.3)';
            lockBtn.onclick = lockTerms;
        }
    }
    
    function updateHeaderLockIndicator() {
        // Just update the mode status icons (gold lock on Lender button)
        updateModeStatusIcons();
    }
    
    function updateLockToggleUI() {
        const lockShareBtn = $('lockShareISOBtn');
        const lockShareText = $('lockShareISOText');
        const unlockBtn = $('unlockISOBtn');
        const buyRateSlider = $('lenderBuyRateSlider');
        const buyRateInput = $('lenderBuyRate');
        const maxSellSlider = $('lenderMaxSellSlider');
        const maxSellInput = $('lenderMaxSell');
        
        // Check if any option is locked
        const isLocked = calcOptions.some(o => o && o.locked);
        const lockedCount = calcOptions.filter(o => o && o.locked).length;
        
        if (isLocked) {
            // Update lock/share button to show locked state
            if (lockShareBtn) {
                lockShareBtn.style.background = 'linear-gradient(135deg, #10b981, #059669)';
                lockShareBtn.style.boxShadow = '0 0 20px rgba(16, 185, 129, 0.3)';
            }
            if (lockShareText) {
                lockShareText.textContent = `✓ Locked (${lockedCount} Option${lockedCount > 1 ? 's' : ''}) - Share Again`;
            }
            
            // Show unlock button
            if (unlockBtn) {
                unlockBtn.classList.remove('hidden');
            }
            
            // Disable rate inputs (locked rates)
            [buyRateSlider, buyRateInput, maxSellSlider, maxSellInput].forEach(el => {
                if (el) {
                    el.disabled = true;
                    el.style.opacity = '0.5';
                    el.style.cursor = 'not-allowed';
                }
            });
            
            // Disable tier buttons
            document.querySelectorAll('.tier-preset-btn').forEach(btn => {
                btn.disabled = true;
                btn.style.opacity = '0.5';
                btn.style.cursor = 'not-allowed';
            });
        } else {
            // Reset button to default state
            if (lockShareBtn) {
                lockShareBtn.style.background = 'var(--accent)';
                lockShareBtn.style.boxShadow = 'none';
            }
            if (lockShareText) {
                lockShareText.textContent = 'Lock and Share with ISO';
            }
            
            // Hide unlock button
            if (unlockBtn) {
                unlockBtn.classList.add('hidden');
            }
            
            // Enable rate inputs
            [buyRateSlider, buyRateInput, maxSellSlider, maxSellInput].forEach(el => {
                if (el) {
                    el.disabled = false;
                    el.style.opacity = '1';
                    el.style.cursor = '';
                }
            });
            
            // Enable tier buttons
            document.querySelectorAll('.tier-preset-btn').forEach(btn => {
                btn.disabled = false;
                btn.style.opacity = '1';
                btn.style.cursor = 'pointer';
            });
        }
    }
    
    // Track sharing/viewing states (use window scope for persistence)
    window.isoLinkShared = window.isoLinkShared || false;
    window.isoViewed = window.isoViewed || false;
    window.clientLinkShared = window.clientLinkShared || false;
    window.clientEmailShared = window.clientEmailShared || false;
    window.clientViewed = window.clientViewed || false;
    window.clientAccepted = window.clientAccepted || false;
    
    function updateModeStatusIcons() {
        const lenderIcon = $('lenderStatusIcon');
        const isoIcon = $('isoStatusIcon');
        const clientIcon = $('clientStatusIcon');
        
        // Lender: Gold lock when any option is locked
        const isLocked = calcOptions.some(o => o && o.locked);
        if (lenderIcon) {
            if (isLocked) {
                lenderIcon.classList.remove('hidden');
                lenderIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #f59e0b;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                </svg>`;
            } else {
                lenderIcon.classList.add('hidden');
            }
        }
        
        // ISO: Priority order - Viewed (green eye) > Shared (blue share)
        if (isoIcon) {
            if (window.isoViewed) {
                isoIcon.classList.remove('hidden');
                isoIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>`;
            } else if (window.isoLinkShared) {
                isoIcon.classList.remove('hidden');
                isoIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>`;
            } else {
                isoIcon.classList.add('hidden');
            }
        }
        
        // Client: Priority order - Accepted (green check) > Viewed (green eye) > Shared (blue share)
        if (clientIcon) {
            if (window.clientAccepted) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>`;
            } else if (window.clientViewed) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #10b981;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                </svg>`;
            } else if (window.clientEmailShared) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                </svg>`;
            } else if (window.clientLinkShared) {
                clientIcon.classList.remove('hidden');
                clientIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" style="width: 12px; height: 12px; color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                </svg>`;
            } else {
                clientIcon.classList.add('hidden');
            }
        }
    }
    
    function applyFrequencyLock() {
        const opt = calcOptions[activeCalcTab];
        const dailyBtn = document.querySelector('.toggle-btn[data-freq="daily"]');
        const weeklyBtn = document.querySelector('.toggle-btn[data-freq="weekly"]');
        const monthlyBtn = document.querySelector('.toggle-btn[data-freq="monthly"]');
        
        if (!opt || !opt.locked || currentClientMode === 'lender') {
            [dailyBtn, weeklyBtn, monthlyBtn].forEach(btn => {
                if (btn) {
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                }
            });
            return;
        }
        
        const lockedFreq = opt.lockedFrequency;
        
        if (lockedFreq === 'daily') {
            if (dailyBtn) { dailyBtn.disabled = false; dailyBtn.style.opacity = '1'; dailyBtn.style.cursor = 'pointer'; }
            if (weeklyBtn) { weeklyBtn.disabled = true; weeklyBtn.style.opacity = '0.4'; weeklyBtn.style.cursor = 'not-allowed'; weeklyBtn.classList.remove('active'); }
            if (monthlyBtn) { monthlyBtn.disabled = true; monthlyBtn.style.opacity = '0.4'; monthlyBtn.style.cursor = 'not-allowed'; monthlyBtn.classList.remove('active'); }
            if (dailyBtn && !dailyBtn.classList.contains('active')) setFrequency('daily');
        } else if (lockedFreq === 'weekly') {
            if (dailyBtn) { dailyBtn.disabled = false; dailyBtn.style.opacity = '1'; dailyBtn.style.cursor = 'pointer'; }
            if (weeklyBtn) { weeklyBtn.disabled = false; weeklyBtn.style.opacity = '1'; weeklyBtn.style.cursor = 'pointer'; }
            if (monthlyBtn) { monthlyBtn.disabled = true; monthlyBtn.style.opacity = '0.4'; monthlyBtn.style.cursor = 'not-allowed'; monthlyBtn.classList.remove('active'); }
            if (monthlyBtn && monthlyBtn.classList.contains('active')) setFrequency('weekly');
        }
        // If monthly, all are allowed (no restrictions)
    }
    
    function applyRateLock() {
        // Only applies in ISO mode
        if (currentClientMode !== 'iso') return;
        
        const opt = calcOptions[activeCalcTab];
        const sellSlider = $('isoSellRateSlider');
        const sellInput = $('isoSellRate');
        
        console.log('applyRateLock called, tab:', activeCalcTab, 'opt:', opt);
        
        if (!sellSlider || !sellInput) return;
        
        // Check if option is locked and has rate constraints
        if (opt && opt.locked && opt.lockedMaxSell && opt.lockedBuyRate) {
            const maxSell = opt.lockedMaxSell;
            const buyRate = opt.lockedBuyRate;
            
            console.log('Applying rate lock - buy:', buyRate, 'max:', maxSell);
            
            // Apply constraints to slider - set to MAX (slider appears capped/maxed)
            sellSlider.min = buyRate;
            sellSlider.max = maxSell;
            sellSlider.value = maxSell; // Set to max so slider is at right edge
            sellInput.value = maxSell.toFixed(2);
            sellInput.max = maxSell;
            sellInput.min = buyRate;
            updateSliderFill(sellSlider);
            
            // Update buy rate display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
            
            // Update factor rate as well
            if ($('calcFactor')) $('calcFactor').value = maxSell.toFixed(2);
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSell;
                updateSliderFill($('calcFactorSlider'));
            }
        } else if (!window.isoShareMode) {
            // Unlocked option in direct ISO mode - full range
            sellSlider.min = 1.05;
            sellSlider.max = 1.70;
            sellInput.min = 1.05;
            sellInput.max = 1.70;
            updateSliderFill(sellSlider);
        }
        
        updateIsoUpsell();
    }
    
    function applyTermLock() {
        // Only applies in ISO/client mode
        if (currentClientMode === 'lender') return;
        
        const opt = calcOptions[activeCalcTab];
        const amountSlider = $('calcAmountSlider');
        const amountInput = $('calcAmount');
        const termSlider = $('calcTermSlider');
        const termInput = $('calcTerm');
        
        console.log('applyTermLock - opt:', opt);
        
        if (opt && opt.locked) {
            // Apply amount cap - set max AND value to locked amount (slider appears maxed)
            if (opt.lockedAmount && amountSlider && amountInput) {
                amountSlider.max = opt.lockedAmount;
                amountSlider.value = opt.lockedAmount; // Set to max (slider at right edge)
                amountInput.value = formatNumber(opt.lockedAmount);
                updateSliderFill(amountSlider);
                console.log('Amount capped at:', opt.lockedAmount);
            }
            
            // Apply term cap - set max AND value to locked term (slider appears maxed)
            if (opt.lockedTerm && termSlider && termInput) {
                termSlider.max = opt.lockedTerm;
                termSlider.value = opt.lockedTerm; // Set to max (slider at right edge)
                termInput.value = opt.lockedTerm;
                updateSliderFill(termSlider);
                console.log('Term capped at:', opt.lockedTerm);
            }
        } else if (!window.isoShareMode && currentClientMode !== 'lender') {
            // Unlocked - restore full range
            if (amountSlider) { amountSlider.max = 1000000; updateSliderFill(amountSlider); }
            if (termSlider) { termSlider.max = 520; updateSliderFill(termSlider); }
        }
        
        updatePreview();
    }

    function toggleThemeDropdown() {
        const dropdown = $('themeDropdown');
        dropdown.classList.toggle('open');
        
        // Close preview dropdown if open
        $('previewDropdown')?.classList.remove('open');
        $('previewDropdownSticky')?.classList.remove('open');
        
        // Sync tier preset inputs when opening
        if (dropdown.classList.contains('open')) {
            syncTierPresetInputs();
        }
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closeThemeDropdownOnClickOutside);
            }, 10);
        }
    }
    
    function toggleThemeDropdownSticky() {
        // Use the main theme dropdown - just scroll to make it visible
        toggleThemeDropdown();
    }
    
    function syncTierPresetInputs() {
        // Sync Tier A
        if ($('tierABuy')) $('tierABuy').value = LENDER_TIERS[1].buyRate.toFixed(2);
        if ($('tierAMax')) $('tierAMax').value = LENDER_TIERS[1].maxSell.toFixed(2);
        // Sync Tier B
        if ($('tierBBuy')) $('tierBBuy').value = LENDER_TIERS[2].buyRate.toFixed(2);
        if ($('tierBMax')) $('tierBMax').value = LENDER_TIERS[2].maxSell.toFixed(2);
        // Sync Tier C
        if ($('tierCBuy')) $('tierCBuy').value = LENDER_TIERS[3].buyRate.toFixed(2);
        if ($('tierCMax')) $('tierCMax').value = LENDER_TIERS[3].maxSell.toFixed(2);
    }

    function closeThemeDropdownOnClickOutside(e) {
        const dropdown = $('themeDropdown');
        const picker = document.querySelector('.theme-picker');
        const pickerSticky = document.querySelector('.theme-picker-sticky');
        if (!picker?.contains(e.target) && !pickerSticky?.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closeThemeDropdownOnClickOutside);
        }
    }
    
    function togglePreviewDropdown() {
        const dropdown = $('previewDropdown');
        dropdown.classList.toggle('open');
        
        // Close theme dropdown if open
        $('themeDropdown')?.classList.remove('open');
        $('previewDropdownSticky')?.classList.remove('open');
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closePreviewDropdownOnClickOutside);
            }, 10);
        }
    }
    
    function togglePreviewDropdownSticky() {
        const dropdown = $('previewDropdownSticky');
        dropdown.classList.toggle('open');
        
        // Close other dropdowns
        $('themeDropdown')?.classList.remove('open');
        $('previewDropdown')?.classList.remove('open');
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closePreviewDropdownStickyOnClickOutside);
            }, 10);
        }
    }
    
    function closePreviewDropdownStickyOnClickOutside(e) {
        const dropdown = $('previewDropdownSticky');
        const picker = document.querySelector('.preview-picker-sticky');
        if (!picker?.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closePreviewDropdownStickyOnClickOutside);
        }
    }

    function closePreviewDropdownOnClickOutside(e) {
        const dropdown = $('previewDropdown');
        const picker = document.querySelector('.preview-picker');
        if (!picker.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closePreviewDropdownOnClickOutside);
        }
    }

    function setThemeMode(mode) {
        currentTheme = mode;
        const html = document.documentElement;
        html.classList.remove('theme-light', 'theme-dark', 'theme-black');
        html.classList.add(`theme-${mode}`);
        
        // Update mode buttons
        $$('.theme-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        saveThemePreference();
        updateSliders();
    }

    function setAccentColor(accent) {
        currentAccent = accent;
        const html = document.documentElement;
        
        // Clear any existing rainbow interval
        if (window.rainbowInterval) {
            clearInterval(window.rainbowInterval);
            window.rainbowInterval = null;
        }
        
        // Remove all accent classes
        html.classList.remove('accent-mint', 'accent-blue', 'accent-purple', 'accent-rainbow', 'accent-orange', 'accent-cyan', 'accent-gold', 'accent-slate', 'accent-lime', 'accent-teal', 'accent-pink', 'accent-indigo', 'rainbow-mode');
        
        if (accent === 'rainbow') {
            // Rainbow mode - cycle through colors
            html.classList.add('rainbow-mode');
            const rainbowColors = ['mint', 'blue', 'purple', 'orange', 'cyan', 'gold', 'slate', 'lime', 'teal', 'pink', 'indigo'];
            let colorIndex = 0;
            
            const applyColor = () => {
                html.classList.remove('accent-mint', 'accent-blue', 'accent-purple', 'accent-orange', 'accent-cyan', 'accent-gold', 'accent-slate', 'accent-lime', 'accent-teal', 'accent-pink', 'accent-indigo');
                html.classList.add(`accent-${rainbowColors[colorIndex]}`);
                colorIndex = (colorIndex + 1) % rainbowColors.length;
            };
            
            applyColor();
            window.rainbowInterval = setInterval(applyColor, 4000);
        } else {
            html.classList.add(`accent-${accent}`);
        }
        
        // Update swatches
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('active', swatch.dataset.accent === accent);
        });
        
        saveThemePreference();
        updateSliders();
    }
    
    function updateAccentSwatchLocks() {
        // All accents now unlocked for everyone
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.remove('locked');
        });
    }

    // Welcome screen mode toggle
    function setClientModeWelcome(mode) {
        // Update welcome toggle buttons
        const isoBtn = $('welcomeIsoModeBtn');
        const lenderBtn = $('welcomeLenderModeBtn');
        if (isoBtn) isoBtn.classList.toggle('active', mode === 'iso');
        if (lenderBtn) lenderBtn.classList.toggle('active', mode === 'lender');
        
        // Store for use after login
        window.pendingClientMode = mode;
    }

    function setClientMode(mode) {
        currentClientMode = mode;
        
        // Save to localStorage for persistence
        localStorage.setItem('trustbureau_client_mode', mode);
        
        // Update mode toggle buttons
        const isoBtn = $('isoModeBtn');
        const lenderBtn = $('lenderModeBtn');
        if (isoBtn) isoBtn.classList.toggle('active', mode === 'iso');
        if (lenderBtn) lenderBtn.classList.toggle('active', mode === 'lender');
        
        // Also sync welcome screen toggle
        const welcomeIsoBtn = $('welcomeIsoModeBtn');
        const welcomeLenderBtn = $('welcomeLenderModeBtn');
        if (welcomeIsoBtn) welcomeIsoBtn.classList.toggle('active', mode === 'iso');
        if (welcomeLenderBtn) welcomeLenderBtn.classList.toggle('active', mode === 'lender');
        
        // Hide factor rate card in both modes (controlled by lender rates)
        const factorRateCard = $('factorRateCard');
        if (factorRateCard) factorRateCard.classList.add('hidden');
        
        // Show/hide ISO preview option in dropdown (only visible in lender mode)
        const isoPreviewOption = $('isoPreviewOption');
        const isoPreviewOptionSticky = $('isoPreviewOptionSticky');
        if (isoPreviewOption) {
            isoPreviewOption.classList.toggle('hidden', mode !== 'lender');
        }
        if (isoPreviewOptionSticky) {
            isoPreviewOptionSticky.classList.toggle('hidden', mode !== 'lender');
        }
        
        // Show/hide sections based on mode
        const lenderRateSection = $('lenderRateSection');
        const isoUpsellSection = $('isoUpsellSection');
        const lenderSettings = $('lenderRateSettings');
        
        if (mode === 'lender') {
            if (lenderRateSection) lenderRateSection.classList.remove('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
            if (lenderSettings) lenderSettings.classList.remove('hidden');
            updateLenderDisplay();
            updateHeaderLockIndicator();
            updateLockButtonState();
            updateLockToggleUI();
        } else {
            // ISO mode - apply locks if current option is locked
            const opt = calcOptions[activeCalcTab];
            if (opt && opt.locked) {
                applyFrequencyLock();
                const amountSlider = $('calcAmountSlider');
                const termSlider = $('calcTermSlider');
                if (amountSlider) {
                    amountSlider.max = opt.lockedAmount;
                    if (parseFloat(amountSlider.value) > opt.lockedAmount) {
                        amountSlider.value = opt.lockedAmount;
                        if ($('calcAmount')) $('calcAmount').value = formatNumber(opt.lockedAmount);
                    }
                    updateSliderFill(amountSlider);
                }
                if (termSlider) {
                    termSlider.max = opt.lockedTerm;
                    if (parseInt(termSlider.value) > opt.lockedTerm) {
                        termSlider.value = opt.lockedTerm;
                        if ($('calcTerm')) $('calcTerm').value = opt.lockedTerm;
                    }
                    updateSliderFill(termSlider);
                }
            }
            
            // ISO mode - set factor rate to max sell rate
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            
            // Check if current option is locked - use per-option rates
            const optForRates = calcOptions[activeCalcTab];
            const isOptionLocked = optForRates && optForRates.locked && optForRates.lockedBuyRate && optForRates.lockedMaxSell;
            
            // Check if this is a shared link (restricted range) or direct ISO login (full range)
            if (window.isoShareMode || isOptionLocked) {
                // Use per-option locked rates if available, otherwise fall back to global
                let maxSell, buyRate;
                if (isOptionLocked) {
                    maxSell = optForRates.lockedMaxSell;
                    buyRate = optForRates.lockedBuyRate;
                } else {
                    maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
                    buyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
                }
                
                if (sellSlider) {
                    sellSlider.min = buyRate;
                    sellSlider.max = maxSell;
                    sellSlider.value = maxSell;
                    updateSliderFill(sellSlider);
                }
                if (sellInput) {
                    sellInput.value = maxSell.toFixed(2);
                    sellInput.min = buyRate;
                    sellInput.max = maxSell;
                }
                
                // Update buy rate display
                if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
                
                if ($('calcFactor')) $('calcFactor').value = maxSell;
                if ($('calcFactorSlider')) $('calcFactorSlider').value = maxSell;
            } else {
                // Direct ISO login: give full range 1.05-1.70
                const defaultRate = 1.25;
                
                if (sellSlider) {
                    sellSlider.min = 1.05;
                    sellSlider.max = 1.70;
                    sellSlider.value = defaultRate;
                    updateSliderFill(sellSlider);
                }
                if (sellInput) {
                    sellInput.value = defaultRate.toFixed(2);
                }
                
                // Update global vars for ISO calculations
                lenderBuyRate = 1.05;
                lenderMaxSellRate = 1.70;
                
                if ($('calcFactor')) $('calcFactor').value = defaultRate;
                if ($('calcFactorSlider')) $('calcFactorSlider').value = defaultRate;
            }
            
            updateSliderFill($('calcFactorSlider'));
            
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            if (lenderSettings) lenderSettings.classList.add('hidden');
            // Show ISO upsell section in ISO mode
            if (isoUpsellSection) isoUpsellSection.classList.remove('hidden');
            
            // Update ISO upsell display
            updateIsoUpsell();
        }
        
        updatePreview();
    }
    
    // Tier presets for lender mode (mutable for customization)
    let LENDER_TIERS = {
        1: { buyRate: 1.15, maxSell: 1.25 },
        2: { buyRate: 1.25, maxSell: 1.35 },
        3: { buyRate: 1.35, maxSell: 1.45 }
    };
    
    // Map tier letters to numbers
    const TIER_MAP = { 'A': 1, 'B': 2, 'C': 3 };
    
    function updateTierPreset(tierLetter) {
        const tierNum = TIER_MAP[tierLetter];
        const buyInput = $('tier' + tierLetter + 'Buy');
        const maxInput = $('tier' + tierLetter + 'Max');
        
        if (!buyInput || !maxInput) return;
        
        let buyRate = parseFloat(buyInput.value) || 1.15;
        let maxSell = parseFloat(maxInput.value) || 1.25;
        
        // Enforce minimum spread
        if (maxSell <= buyRate + 0.04) {
            maxSell = buyRate + 0.05;
            maxInput.value = maxSell.toFixed(2);
        }
        
        // Update the tier preset
        LENDER_TIERS[tierNum] = { buyRate, maxSell };
        
        // Update the tier button display
        const tierBtn = $('tierBtn' + tierNum);
        if (tierBtn) {
            const rateDisplay = tierBtn.querySelector('span:last-child');
            if (rateDisplay) {
                rateDisplay.textContent = buyRate.toFixed(2) + ' / ' + maxSell.toFixed(2);
            }
        }
        
        // If this tier is currently active, update the rates
        if (tierBtn && tierBtn.classList.contains('active')) {
            setLenderTier(tierNum);
        }
    }
    
    function clearTierSelection() {
        for (let i = 1; i <= 3; i++) {
            const btn = $('tierBtn' + i);
            if (btn) {
                btn.classList.remove('active');
                btn.style.borderColor = 'var(--border-primary)';
            }
        }
    }
    
    function setLenderTier(tier) {
        const preset = LENDER_TIERS[tier];
        if (!preset) return;
        
        // Update tier button states
        for (let i = 1; i <= 3; i++) {
            const btn = $('tierBtn' + i);
            if (btn) {
                btn.classList.toggle('active', i === tier);
                btn.style.borderColor = i === tier ? 'var(--accent)' : 'var(--border-primary)';
            }
        }
        
        // Update buy rate
        if ($('lenderBuyRate')) $('lenderBuyRate').value = preset.buyRate;
        if ($('lenderBuyRateSlider')) $('lenderBuyRateSlider').value = preset.buyRate;
        if ($('buyRateInput')) $('buyRateInput').value = preset.buyRate;
        if ($('buyRateSlider')) $('buyRateSlider').value = preset.buyRate;
        
        // Update max sell rate
        if ($('lenderMaxSell')) $('lenderMaxSell').value = preset.maxSell;
        if ($('lenderMaxSellSlider')) $('lenderMaxSellSlider').value = preset.maxSell;
        if ($('maxSellRateInput')) $('maxSellRateInput').value = preset.maxSell;
        if ($('maxSellRateSlider')) $('maxSellRateSlider').value = preset.maxSell;
        
        // Update display and recalculate
        updateLenderDisplay();
        updatePreview();
    }
    
    function updateLenderDisplay() {
        const buyRate = parseFloat($('lenderBuyRate')?.value) || 1.15;
        const maxSell = parseFloat($('lenderMaxSell')?.value) || 1.25;
        const fundingAmount = parseFloat($('calcAmount').value.replace(/[,$]/g, '')) || 0;
        
        // Update global vars
        lenderBuyRate = buyRate;
        lenderMaxSellRate = maxSell;
        
        // Save rates to current option (for per-option locking)
        if (calcOptions[activeCalcTab]) {
            calcOptions[activeCalcTab].buyRate = buyRate;
            calcOptions[activeCalcTab].maxSell = maxSell;
        }
        
        // Calculate max spread and profit
        const maxSpread = maxSell - buyRate;
        const maxProfit = fundingAmount * maxSpread;
        
        if ($('lenderMaxSpread')) $('lenderMaxSpread').textContent = maxSpread.toFixed(2);
        if ($('lenderMaxProfit')) $('lenderMaxProfit').textContent = '$' + maxProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // Sync factor rate with buy rate in lender mode
        if ($('calcFactor')) $('calcFactor').value = buyRate;
        if ($('calcFactorSlider')) {
            $('calcFactorSlider').value = buyRate;
            updateSliderFill($('calcFactorSlider'));
        }
    }
    
    function shareWithISO() {
        // Lock current option first
        lockTerms();
        
        // Save current state
        saveState(activeCalcTab);
        
        const buyRate = parseFloat($('lenderBuyRate')?.value) || 1.15;
        const maxSell = parseFloat($('lenderMaxSell')?.value) || 1.25;
        
        // Build URL with parameters
        const baseUrl = window.location.origin + window.location.pathname;
        const params = new URLSearchParams();
        params.set('iso', '1');
        params.set('buy', buyRate.toFixed(2));
        params.set('max', maxSell.toFixed(2));
        
        // Include option data with locks
        const optData = calcOptions.map(op => ({
            a: op.amount, f: op.factor, t: op.term, q: op.frequency,
            lk: op.locked ? 1 : 0,
            la: op.lockedAmount,
            lt: op.lockedTerm,
            lq: op.lockedFrequency,
            lb: op.lockedBuyRate,
            lm: op.lockedMaxSell
        }));
        const optJson = JSON.stringify(optData);
        const optEnc = LZString.compressToEncodedURIComponent(optJson);
        params.set('opts', optEnc);
        
        const shareUrl = baseUrl + '?' + params.toString();
        
        // Mark as shared and update UI
        window.isoLinkShared = true;
        updateModeStatusIcons();
        
        // Save to dashboard (ISO rate share)
        const isoName = getVal('calcISOName') || '';
        saveISOShareToDashboard(shareUrl, buyRate, maxSell, isoName);
        
        // Copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ISO link copied with locked options!');
        }).catch(() => {
            // Fallback
            prompt('Copy this ISO link:', shareUrl);
        });
    }
    
    // Save ISO rate share to dashboard (for lenders)
    function saveISOShareToDashboard(link, buyRate, maxSell, isoName = '') {
        const offers = getStoredOffers();
        const now = new Date().toISOString();
        
        const offer = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            businessName: 'ISO Rate Share',
            contactName: '',
            isoName: isoName,
            amount: 0,
            factor: maxSell,
            buyRate: buyRate,
            term: 0,
            frequency: 'daily',
            payment: 0,
            totalPayback: 0,
            optionCount: 0,
            link: link,
            createdAt: now,
            mode: 'lender',
            isISOShare: true,
            tracking: {
                lenderLocked: now,
                isoShared: now,
                isoViewed: null,
                clientShared: null,
                clientShareMethod: null,
                clientViewed: null,
                clientDeclined: null,
                clientAccepted: null
            }
        };
        
        offers.unshift(offer);
        
        if (offers.length > 100) {
            offers.splice(100);
        }
        
        saveStoredOffers(offers);
        updateOfferCount();
    }
    
    function checkISOShareMode() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.get('iso') === '1') {
            window.isoShareMode = true;
            window.isoLinkShared = true;
            window.lenderLocked = true; // Lender has locked rates when sharing to ISO
            
            // Track ISO view event
            window.isoViewed = true;
            updateOfferTrackingByLink(window.location.href, 'isoView');
            
            const buyRate = parseFloat(params.get('buy')) || 1.15;
            const maxSell = parseFloat(params.get('max')) || 1.25;
            
            lenderBuyRate = buyRate;
            lenderMaxSellRate = maxSell;
            
            // Parse option data with locks if present
            const optsEnc = params.get('opts');
            if (optsEnc) {
                try {
                    const optsJson = LZString.decompressFromEncodedURIComponent(optsEnc);
                    const opts = JSON.parse(optsJson);
                    
                    console.log('Parsed opts from URL:', opts);
                    
                    // Ensure we have enough options
                    while (calcOptions.length < opts.length) {
                        calcOptions.push(initDefaultOption());
                    }
                    
                    // Apply option data and locks to calcOptions
                    opts.forEach((opt, i) => {
                        // Restore all option values
                        calcOptions[i].amount = parseFloat(opt.a) || calcOptions[i].amount;
                        calcOptions[i].factor = parseFloat(opt.f) || calcOptions[i].factor;
                        calcOptions[i].term = parseInt(opt.t) || calcOptions[i].term;
                        calcOptions[i].frequency = opt.q || calcOptions[i].frequency;
                        
                        // Restore lock values
                        calcOptions[i].locked = opt.lk === 1;
                        calcOptions[i].lockedAmount = opt.la ? parseFloat(opt.la) : null;
                        calcOptions[i].lockedTerm = opt.lt ? parseInt(opt.lt) : null;
                        calcOptions[i].lockedFrequency = opt.lq || null;
                        calcOptions[i].lockedBuyRate = opt.lb ? parseFloat(opt.lb) : null;
                        calcOptions[i].lockedMaxSell = opt.lm ? parseFloat(opt.lm) : null;
                        
                        console.log('Restored option', i, '- locked:', calcOptions[i].locked, 'lockedBuyRate:', calcOptions[i].lockedBuyRate, 'lockedMaxSell:', calcOptions[i].lockedMaxSell);
                    });
                    
                    // Update tabs UI to show lock icons
                    updateTabsUI();
                } catch(e) {
                    console.error('Error parsing ISO option data:', e);
                }
            }
            
            // Set up ISO upsell slider - use per-option values if locked
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            const activeOpt = calcOptions[activeCalcTab];
            
            // Use per-option locked rates if available, otherwise global
            const effectiveBuy = (activeOpt && activeOpt.locked && activeOpt.lockedBuyRate) ? activeOpt.lockedBuyRate : buyRate;
            const effectiveMax = (activeOpt && activeOpt.locked && activeOpt.lockedMaxSell) ? activeOpt.lockedMaxSell : maxSell;
            
            if (sellSlider && sellInput) {
                sellSlider.min = effectiveBuy;
                sellSlider.max = effectiveMax;
                sellSlider.value = effectiveMax;
                sellInput.value = effectiveMax.toFixed(2);
                updateSliderFill(sellSlider);
            }
            
            // Update display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = effectiveBuy.toFixed(2);
            
            // Show ISO section, hide lender section
            const isoUpsellSection = $('isoUpsellSection');
            const lenderRateSection = $('lenderRateSection');
            
            if (isoUpsellSection) isoUpsellSection.classList.remove('hidden');
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            
            // Set factor rate to max sell rate (ISO's default sell rate)
            if ($('calcFactor')) {
                $('calcFactor').value = effectiveMax;
                $('calcFactor').disabled = true;
            }
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = effectiveMax;
                $('calcFactorSlider').disabled = true;
            }
            
            // Force to Option A on ISO load
            activeCalcTab = 0;
            updateTabsUI();
            
            // Force ISO client mode in menu
            setClientMode('iso');
            
            // Load Option A state and apply all locks
            loadState(0);
            applyFrequencyLock();
            applyRateLock();
            applyTermLock();
            
            // Update ISO profit display
            updateIsoUpsell();
            updatePreview();
            
            showToast('ISO Mode: Adjust your sell rate below');
        }
    }
    
    function updateLenderRates() {
        clearTierSelection();
        // Get values from theme menu inputs
        let buyFromMenu = parseFloat($('buyRateInput')?.value) || 1.15;
        let maxFromMenu = parseFloat($('maxSellRateInput')?.value) || 1.25;
        
        // Enforce minimum spread of 0.05 between buy and max sell
        if (maxFromMenu <= buyFromMenu + 0.04) {
            // Determine which one was just changed by comparing to current slider values
            const currentBuy = parseFloat($('lenderBuyRate')?.value) || 1.15;
            const currentMax = parseFloat($('lenderMaxSell')?.value) || 1.25;
            
            // If buy rate changed more, adjust max sell up
            if (Math.abs(buyFromMenu - currentBuy) > Math.abs(maxFromMenu - currentMax)) {
                maxFromMenu = Math.min(buyFromMenu + 0.05, 1.70);
                if ($('maxSellRateInput')) $('maxSellRateInput').value = maxFromMenu.toFixed(2);
            } else {
                // Max sell changed more, adjust buy rate down
                buyFromMenu = Math.max(maxFromMenu - 0.05, 1.05);
                if ($('buyRateInput')) $('buyRateInput').value = buyFromMenu.toFixed(2);
            }
        }
        
        // Sync to calculator area sliders
        if ($('lenderBuyRate')) {
            $('lenderBuyRate').value = buyFromMenu;
            if ($('lenderBuyRateSlider')) {
                $('lenderBuyRateSlider').value = buyFromMenu;
                updateSliderFill($('lenderBuyRateSlider'));
            }
        }
        if ($('lenderMaxSell')) {
            $('lenderMaxSell').value = maxFromMenu;
            if ($('lenderMaxSellSlider')) {
                $('lenderMaxSellSlider').value = maxFromMenu;
                updateSliderFill($('lenderMaxSellSlider'));
            }
        }
        
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxFromMenu;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxFromMenu;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        
        updateLenderDisplay();
    }
    
    function updateIsoUpsell() {
        const sellRate = parseFloat($('isoSellRate')?.value) || lenderBuyRate;
        const fundingAmount = parseFloat($('calcAmount').value.replace(/[,$]/g, '')) || 0;
        
        // If lender lock is enabled, use the locked buy rate; otherwise ISO buys at 1.00 (cost)
        const lenderLockEnabled = $('lenderLockToggle')?.checked || window.lenderLocked;
        const effectiveBuyRate = lenderLockEnabled ? (parseFloat($('lenderBuyRate')?.value) || lenderBuyRate || 1.15) : 1.00;
        
        const spread = sellRate - effectiveBuyRate;
        const isoProfit = fundingAmount * spread;
        
        if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = effectiveBuyRate.toFixed(2);
        if ($('isoSpreadDisplay')) $('isoSpreadDisplay').textContent = spread.toFixed(2);
        if ($('isoProfitDisplay')) $('isoProfitDisplay').textContent = '$' + isoProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // When in ISO mode, the sell rate becomes the client's factor rate
        if (currentClientMode === 'iso' || window.isoShareMode || window.isoPreviewMode) {
            if ($('calcFactor')) $('calcFactor').value = sellRate;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = sellRate;
                updateSliderFill($('calcFactorSlider'));
            }
            
            // Update preview without triggering another updateIsoUpsell
            window._skipIsoUpdate = true;
            updatePreview();
            window._skipIsoUpdate = false;
        }
    }

    function updateLogoPreview(url) {
        currentLogoUrl = url ? url.trim() : '';
        const previewSmall = $('logoPreviewSmall');
        const clearBtn = $('clearLogoBtn');
        const previewContainer = $('previewLogoContainer');
        const previewLogo = $('previewLogo');
        
        if (currentLogoUrl) {
            // Save to localStorage for persistence across sessions
            localStorage.setItem('trustbureau_logo_url', currentLogoUrl);
            
            // Display directly in small preview
            previewSmall.innerHTML = `<img src="${currentLogoUrl}" alt="Logo Preview" onload="this.style.opacity=1" onerror="this.parentElement.innerHTML='<span class=\\'logo-preview-placeholder\\'>Unable to load</span>'" style="opacity:0; transition: opacity 0.2s;" />`;
            clearBtn.classList.remove('hidden');
            
            // Show in main preview card
            previewLogo.src = currentLogoUrl;
            previewLogo.onload = function() {
                previewContainer.classList.remove('hidden');
            };
            previewLogo.onerror = function() {
                previewContainer.classList.add('hidden');
            };
            
            saveThemePreference();
        } else {
            localStorage.removeItem('trustbureau_logo_url');
            previewSmall.innerHTML = '<span class="logo-preview-placeholder">Logo preview will appear here</span>';
            clearBtn.classList.add('hidden');
            previewContainer.classList.add('hidden');
        }
    }

    function clearLogo() {
        $('logoUrlInput').value = '';
        localStorage.removeItem('trustbureau_logo_url');
        updateLogoPreview('');
    }

    function updateCompanyName(name) {
        currentCompanyName = name.trim();
        const previewName = $('previewCompanyName');
        const cPreviewName = $('cPreviewCompanyName');
        
        if (currentCompanyName) {
            // Save to localStorage for persistence across sessions
            localStorage.setItem('trustbureau_company_name', currentCompanyName);
            previewName.textContent = currentCompanyName;
            previewName.classList.remove('hidden');
            cPreviewName.textContent = currentCompanyName;
            cPreviewName.classList.remove('hidden');
        } else {
            localStorage.removeItem('trustbureau_company_name');
            previewName.classList.add('hidden');
            cPreviewName.classList.add('hidden');
        }
        
        saveThemePreference();
    }

    function saveThemePreference() {
        localStorage.setItem('fundingCalcTheme', JSON.stringify({
            mode: currentTheme,
            accent: currentAccent,
            logoUrl: currentLogoUrl,
            companyName: currentCompanyName
        }));
    }

    // Load saved brand data (logo URL and company name) from localStorage
    function loadSavedBrandData() {
        const savedLogoUrl = localStorage.getItem('trustbureau_logo_url');
        const savedCompanyName = localStorage.getItem('trustbureau_company_name');
        
        if (savedLogoUrl) {
            $('logoUrlInput').value = savedLogoUrl;
            updateLogoPreview(savedLogoUrl);
        }
        
        if (savedCompanyName) {
            $('companyNameInput').value = savedCompanyName;
            updateCompanyName(savedCompanyName);
        }
        
        // Update preview if any brand data was loaded
        if (savedLogoUrl || savedCompanyName) {
            updatePreview();
        }
    }

    // Save current theme settings as favorite (for logged-in users)
    function saveFavoriteTheme() {
        if (!currentUser) return;
        
        const favoriteTheme = {
            mode: currentTheme,
            accent: currentAccent,
            logoUrl: currentLogoUrl,
            companyName: currentCompanyName
        };
        localStorage.setItem('trustbureau_favorite_theme_' + currentUser, JSON.stringify(favoriteTheme));
        
        // Show confirmation
        const btn = $('saveFavoriteBtn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg> Saved!';
        btn.style.background = 'var(--accent)';
        btn.style.color = 'white';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.background = 'var(--bg-option-card)';
            btn.style.color = 'var(--accent)';
        }, 1500);
    }

    // Load favorite theme (for logged-in users)
    function loadFavoriteTheme() {
        if (!currentUser) return;
        
        const saved = localStorage.getItem('trustbureau_favorite_theme_' + currentUser);
        if (saved) {
            try {
                const fav = JSON.parse(saved);
                if (fav.mode) setThemeMode(fav.mode);
                if (fav.accent) setAccentColor(fav.accent);
                if (fav.logoUrl) {
                    $('logoUrlInput').value = fav.logoUrl;
                    updateLogoPreview(fav.logoUrl);
                }
                if (fav.companyName) {
                    $('companyNameInput').value = fav.companyName;
                    updateCompanyName(fav.companyName);
                }
                updatePreview();
            } catch (e) {
                console.error('Failed to load favorite theme', e);
            }
        }
    }

    // Update Save Favorite button visibility based on login state
    function updateSaveFavoriteButton() {
        const btn = $('saveFavoriteBtn');
        if (btn) {
            if (currentUser) {
                btn.classList.remove('hidden');
            } else {
                btn.classList.add('hidden');
            }
        }
    }

    function loadThemePreference() {
        const saved = localStorage.getItem('fundingCalcTheme');
        if (saved) {
            try {
                const pref = JSON.parse(saved);
                if (pref.mode) setThemeMode(pref.mode);
                if (pref.accent) {
                    setAccentColor(pref.accent);
                }
                if (pref.logoUrl) {
                    $('logoUrlInput').value = pref.logoUrl;
                    updateLogoPreview(pref.logoUrl);
                }
                if (pref.companyName) {
                    $('companyNameInput').value = pref.companyName;
                    updateCompanyName(pref.companyName);
                }
            } catch (e) {
                console.error('Failed to load theme preference', e);
            }
        } else {
            // Default to black theme with rainbow accent
            setThemeMode('black');
            setAccentColor('rainbow');
        }
        
        // Set initial active states
        $$('.theme-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === currentTheme);
        });
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('active', swatch.dataset.accent === currentAccent);
        });
    }

    function resetBrandKit() {
        // Reset to defaults
        setThemeMode('black');
        // Lite users default to indigo (steel), logged-in users get rainbow
        setAccentColor(currentUser ? 'rainbow' : 'indigo');
        setClientMode('iso');
        
        // Clear brand fields
        currentLogoUrl = '';
        currentCompanyName = '';
        $('logoUrlInput').value = '';
        $('companyNameInput').value = '';
        
        // Reset logo preview
        const previewSmall = $('logoPreviewSmall');
        previewSmall.innerHTML = '<span class="logo-preview-placeholder">Logo preview will appear here</span>';
        $('clearLogoBtn').classList.add('hidden');
        $('previewLogoContainer').classList.add('hidden');
        
        // Reset company name in preview
        const companyNameEl = $('previewCompanyName');
        if (companyNameEl) {
            companyNameEl.textContent = '';
            companyNameEl.classList.add('hidden');
        }
        
        // Clear localStorage
        localStorage.removeItem('fundingCalcTheme');
        
        // Update swatch locks
        updateAccentSwatchLocks();
        
        showToast('Theme Reset');
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    const VALID_USERS = {
        'sutton': 'nouns'
    };
    
    let currentUser = null;

    function handleWelcomeLogin() {
        const username = $('welcomeUsername').value.trim();
        const password = $('welcomePassword').value;
        
        // Accept any username/password as long as password ends with !#
        if (username && password.endsWith('!#')) {
            currentUser = username;
            localStorage.setItem('fundingCalcUser', username);
            // Load user's saved favorite theme (or keep rainbow if none)
            loadFavoriteTheme();
            hideWelcomeScreen();
            updateAuthUI();
            showToast(`Welcome, ${username}!`);
        } else {
            $('welcomeError').classList.add('show');
            $('welcomePassword').value = '';
            $('welcomePassword').focus();
        }
    }

    function continueAsFree() {
        // Log out and set lite defaults
        currentUser = null;
        localStorage.removeItem('fundingCalcUser');
        // Hide welcome screen first (keeps rainbow theme active)
        hideWelcomeScreen();
        updateAuthUI();
        // Do rainbow rotation (15s) then switch to indigo
        setTimeout(() => {
            setAccentColor('indigo');
        }, 15000);
    }

    function hideWelcomeScreen() {
        $('welcomeScreen').classList.add('hidden');
        
        // Apply the mode selected on welcome screen
        if (window.pendingClientMode) {
            setClientMode(window.pendingClientMode);
            window.pendingClientMode = null;
        }
        
        // Update accent swatch locks based on login state
        updateAccentSwatchLocks();
    }

    function showWelcomeScreen() {
        // Always show rainbow theme on welcome/login screen
        setAccentColor('rainbow');
        $('welcomeScreen').classList.remove('hidden');
        $('welcomeUsername').value = '';
        $('welcomePassword').value = '';
        $('welcomeError').classList.remove('show');
    }

    function openLoginModal() {
        $('loginModal').classList.add('open');
        $('loginUsername').focus();
        $('loginError').classList.remove('show');
        $('loginUsername').value = '';
        $('loginPassword').value = '';
        $('loginPassword').type = 'password';
        $('eyeIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
    }

    function closeLoginModal() {
        $('loginModal').classList.remove('open');
    }

    function togglePasswordVisibility() {
        const passwordInput = $('loginPassword');
        const eyeIcon = $('eyeIcon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />';
        } else {
            passwordInput.type = 'password';
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
        }
    }

    function handleLogin() {
        const username = $('loginUsername').value.trim();
        const password = $('loginPassword').value;
        
        // Accept any username/password as long as password ends with !#
        if (username && password.endsWith('!#')) {
            currentUser = username;
            localStorage.setItem('fundingCalcUser', username);
            // Load user's saved favorite theme
            loadFavoriteTheme();
            closeLoginModal();
            updateAuthUI();
            showToast(`Welcome back, ${username}!`);
        } else {
            // Failed
            $('loginError').classList.add('show');
            $('loginPassword').value = '';
            $('loginPassword').focus();
        }
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('fundingCalcUser');
        updateAuthUI();
        showToast('Logged out successfully');
    }

    function updateAuthUI() {
        const brandSection = $('brandSection');
        const userBadge = $('userBadge');
        const userBadgeName = $('userBadgeName');
        
        if (currentUser) {
            // Logged in - unlock brand section
            brandSection.classList.remove('locked');
            userBadge.classList.remove('hidden');
            userBadgeName.textContent = currentUser;
        } else {
            // Logged out - lock brand section
            brandSection.classList.add('locked');
            userBadge.classList.add('hidden');
        }
        
        // Update Save Favorite button visibility
        updateSaveFavoriteButton();
        
        // Update accent swatch locks
        updateAccentSwatchLocks();
    }

    function loadAuthState() {
        const savedUser = localStorage.getItem('fundingCalcUser');
        const savedMode = localStorage.getItem('trustbureau_client_mode');
        
        // Always show rainbow theme on welcome/login screen
        setAccentColor('rainbow');
        
        // Store user but don't load their theme yet - welcome screen still showing
        if (savedUser) {
            currentUser = savedUser;
            // Theme will be loaded after they sign in via handleWelcomeLogin
        }
        
        // Set saved mode for use after welcome screen
        if (savedMode) {
            window.pendingClientMode = savedMode;
            // Also update welcome screen toggle buttons to reflect saved mode
            const welcomeIsoBtn = $('welcomeIsoModeBtn');
            const welcomeLenderBtn = $('welcomeLenderModeBtn');
            if (welcomeIsoBtn) welcomeIsoBtn.classList.toggle('active', savedMode === 'iso');
            if (welcomeLenderBtn) welcomeLenderBtn.classList.toggle('active', savedMode === 'lender');
        }
        
        // Welcome screen always shows on page load
        // User must sign in or continue as free each session
        
        updateAuthUI();
    }

    // Keyboard handlers for modals and welcome screen
    document.addEventListener('keydown', (e) => {
        // Welcome screen - Enter to login
        if (e.key === 'Enter' && !$('welcomeScreen').classList.contains('hidden')) {
            const active = document.activeElement;
            if (active && (active.id === 'welcomeUsername' || active.id === 'welcomePassword')) {
                handleWelcomeLogin();
            }
        }
        // Login modal - Escape to close, Enter to submit
        if (e.key === 'Escape' && $('loginModal').classList.contains('open')) {
            closeLoginModal();
        }
        if (e.key === 'Enter' && $('loginModal').classList.contains('open')) {
            const active = document.activeElement;
            if (active && (active.id === 'loginUsername' || active.id === 'loginPassword')) {
                handleLogin();
            }
        }
    });

    // ============================================
    // STATE
    // ============================================
    let calcOptions = [];
    let activeCalcTab = 0;
    let clientData = null;
    let clientActiveIdx = 0;
    let clientSelectedAmount = 0;

    // ============================================
    // CORE CALCULATION
    // ============================================
    function calculate(a, f, t, fr, fe) { 
        // Validate inputs - ensure all are valid numbers
        a = (typeof a === 'number' && !isNaN(a) && a >= 0) ? a : 0;
        f = (typeof f === 'number' && !isNaN(f) && f > 0) ? f : 1.15;
        t = (typeof t === 'number' && !isNaN(t) && t > 0) ? t : 130;
        fe = (typeof fe === 'number' && !isNaN(fe) && fe >= 0) ? fe : 0;
        
        const tp = a * f; 
        const tc = tp - a; 
        const p = t > 0 ? tp / t : 0; 
        const fa = a * (fe / 100); 
        const net = a - fa; 
        return { amount: a, factor: f, term: t, frequency: fr, fee: fe, feeAmount: fa, net: net, totalPayback: tp, totalCost: tc, payment: p }; 
    }
    
    // Shared term display calculation for consistency across Link, SMS, Email
    function getTermDisplay(term, frequency, termOverride) {
        if (termOverride && termOverride.trim()) {
            return termOverride.trim();
        }
        let months;
        if (frequency === 'daily') {
            months = Math.round((term / 21) * 2) / 2; // 21 business days, round to .5
        } else if (frequency === 'weekly') {
            months = Math.round((term / 4.33) * 2) / 2; // 4.33 weeks per month, round to .5
        } else {
            months = term; // monthly = term is already months
        }
        // Format: "6 months" or "6.5 months"
        const label = months === 1 ? 'month' : 'months';
        return months + ' ' + label;
    }

    // ============================================
    // ADMIN LOGIC
    // ============================================
    function initDefaultOption() { 
        return { amount: 50000, factor: 1.19, term: 130, frequency: 'daily', fee: 0, prepay: 0, termOverride: '', notes: '', docs: false, docsText: "Voided Check\nGovernment Issued ID", locked: false, lockedAmount: null, lockedTerm: null, lockedFrequency: null, lockedBuyRate: null, lockedMaxSell: null, buyRate: 1.15, maxSell: 1.25 }; 
    }

    function addCalcOption() { 
        if (calcOptions.length >= 3) return; 
        const p = calcOptions[calcOptions.length - 1] || initDefaultOption(); 
        calcOptions.push({ ...p }); 
        updateTabsUI(); 
        switchCalcTab(calcOptions.length - 1); 
    }

    function removeCalcOption() { 
        if (calcOptions.length <= 1) return; 
        calcOptions.splice(activeCalcTab, 1); 
        if (activeCalcTab >= calcOptions.length) activeCalcTab = calcOptions.length - 1; 
        updateTabsUI(); 
        switchCalcTab(activeCalcTab); 
    }

    function switchCalcTab(i) { 
        console.log('switchCalcTab called, switching to:', i, 'current mode:', currentClientMode);
        
        // In ISO mode, DON'T save state - each option should reset to locked values
        if (currentClientMode !== 'iso') {
            saveState(activeCalcTab);
        }
        
        activeCalcTab = i; 
        updateTabsUI(); 
        loadState(activeCalcTab); // This now handles ISO mode with locked values
        updateSliders();
        updateLockButtonState();
        
        // Apply frequency lock (works for both modes)
        applyFrequencyLock();
        
        // In lender mode, apply other locks
        if (currentClientMode !== 'iso') {
            applyRateLock();
            applyTermLock();
        }
        
        // Update displays
        updateIsoUpsell();
        updatePreview();
    }
    
    function updateTabsUI() { 
        for(let i=0; i<3; i++) { 
            const b = $(`tab-btn-${i}`); 
            if (i < calcOptions.length) { 
                b.classList.remove('hidden'); 
                b.classList.toggle('active', i === activeCalcTab);
                const isLocked = calcOptions[i] && calcOptions[i].locked;
                b.innerHTML = `Option ${getLetter(i)}${isLocked ? ' <span style="color: #10b981;">🔒</span>' : ''}`;
            } else { 
                b.classList.add('hidden'); 
            } 
        } 
        $('add-tab-btn').classList.toggle('hidden', calcOptions.length >= 3); 
        $('remove-option-btn').classList.toggle('hidden', calcOptions.length <= 1); 
    }

    function getVal(id, num=false) { 
        const el = $(id); 
        if (!el) return num ? 0 : ''; 
        if (num) return parseNumber(el.value); 
        return el.value.trim(); 
    }

    function setVal(id, v) { 
        if($(id)) $(id).value = v; 
    }

    function saveState(i) { 
        if (!calcOptions[i]) return; 
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        // Preserve ALL lock state including rate locks
        const prevLocked = calcOptions[i].locked;
        const prevLockedAmount = calcOptions[i].lockedAmount;
        const prevLockedTerm = calcOptions[i].lockedTerm;
        const prevLockedFrequency = calcOptions[i].lockedFrequency;
        const prevLockedBuyRate = calcOptions[i].lockedBuyRate;
        const prevLockedMaxSell = calcOptions[i].lockedMaxSell;
        
        // Capture current rates for this option (for per-option rate locking)
        const currentBuyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
        const currentMaxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
        
        calcOptions[i] = { 
            amount: getVal('calcAmount', true), 
            factor: getVal('calcFactor', true), 
            term: getVal('calcTerm', true), 
            frequency: fr, 
            fee: $('toggleFee').checked ? getVal('calcFee', true) : 0, 
            prepay: $('togglePrepay').checked ? getVal('calcPrepay', true) : 0,
            prepayDate: getVal('calcPrepayDate'),
            termOverride: $('toggleOverride').checked ? getVal('calcTermOverride') : '', 
            notes: $('toggleNotes').checked ? getVal('calcNotes') : '',
            expiry: $('toggleExpiry').checked,
            expiryDate: getVal('calcExpiryDate'),
            docs: $('toggleDocs').checked,
            docsText: getVal('calcDocs'),
            locked: prevLocked,
            lockedAmount: prevLockedAmount,
            lockedTerm: prevLockedTerm,
            lockedFrequency: prevLockedFrequency,
            lockedBuyRate: prevLockedBuyRate,
            lockedMaxSell: prevLockedMaxSell,
            // Store current rates for this option (used when locking)
            buyRate: currentBuyRate,
            maxSell: currentMaxSell
        }; 
    }

    function loadState(i) { 
        const o = calcOptions[i]; 
        if (!o) return; 
        
        // In ISO mode with locked option, set sliders to locked values (not stored values)
        if (currentClientMode === 'iso' && o.locked) {
            console.log('loadState ISO mode - loading locked values for option', i, o);
            
            // Amount - set to locked max
            if (o.lockedAmount) {
                const amountSlider = $('calcAmountSlider');
                if (amountSlider) {
                    amountSlider.min = 5000;
                    amountSlider.max = o.lockedAmount;
                    amountSlider.value = o.lockedAmount;
                    updateSliderFill(amountSlider);
                }
                setVal('calcAmount', formatNumber(o.lockedAmount));
            }
            
            // Term - set to locked max
            if (o.lockedTerm) {
                const termSlider = $('calcTermSlider');
                if (termSlider) {
                    termSlider.min = 5;
                    termSlider.max = o.lockedTerm;
                    termSlider.value = o.lockedTerm;
                    updateSliderFill(termSlider);
                }
                setVal('calcTerm', o.lockedTerm);
            }
            
            // Factor/sell rate - set to locked max
            if (o.lockedMaxSell) {
                const factorSlider = $('calcFactorSlider');
                if (factorSlider) {
                    factorSlider.min = o.lockedBuyRate || 1.0;
                    factorSlider.max = o.lockedMaxSell;
                    factorSlider.value = o.lockedMaxSell;
                    updateSliderFill(factorSlider);
                }
                setVal('calcFactor', o.lockedMaxSell.toFixed(2));
                
                // ISO sell rate slider
                const sellSlider = $('isoSellRateSlider');
                const sellInput = $('isoSellRate');
                if (sellSlider && sellInput) {
                    sellSlider.min = o.lockedBuyRate || 1.0;
                    sellSlider.max = o.lockedMaxSell;
                    sellSlider.value = o.lockedMaxSell;
                    sellInput.value = o.lockedMaxSell.toFixed(2);
                    sellInput.min = o.lockedBuyRate || 1.0;
                    sellInput.max = o.lockedMaxSell;
                    updateSliderFill(sellSlider);
                }
                
                // Update buy rate display
                if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = (o.lockedBuyRate || 1.0).toFixed(2);
            }
            
            // Frequency
            if (o.frequency) setFrequency(o.frequency);
            
            // Fee/prepay/notes/etc
            const hf = o.fee > 0; $('toggleFee').checked = hf; toggleSection('Fee', hf); if(hf) { setVal('calcFee', o.fee); setVal('calcFeeSlider', o.fee); }
            const hp = o.prepay > 0; $('togglePrepay').checked = hp; toggleSection('Prepay', hp); if(hp) { setVal('calcPrepay', o.prepay); setVal('calcPrepaySlider', o.prepay); } if(o.prepayDate) setVal('calcPrepayDate', o.prepayDate);
            const ho = !!o.termOverride; $('toggleOverride').checked = ho; toggleSection('Override', ho); if(ho) setVal('calcTermOverride', o.termOverride);
            const hn = !!o.notes; $('toggleNotes').checked = hn; toggleSection('Notes', hn); if(hn) setVal('calcNotes', o.notes);
            const he = !!o.expiry; $('toggleExpiry').checked = he; toggleSection('Expiry', he); if(o.expiryDate) setVal('calcExpiryDate', o.expiryDate);
            const hd = !!o.docs; $('toggleDocs').checked = hd; toggleSection('Docs', hd); setVal('calcDocs', o.docsText || "Voided Check\nGovernment Issued ID");
            
            return; // Done for ISO mode
        }
        
        // Normal mode (lender) - load stored values
        setVal('calcAmount', formatNumber(o.amount)); setVal('calcAmountSlider', o.amount); 
        setVal('calcFactor', o.factor); setVal('calcFactorSlider', o.factor); 
        setVal('calcTerm', o.term); setVal('calcTermSlider', o.term); 
        
        const hf = o.fee > 0; $('toggleFee').checked = hf; toggleSection('Fee', hf); if(hf) { setVal('calcFee', o.fee); setVal('calcFeeSlider', o.fee); }
        const hp = o.prepay > 0; $('togglePrepay').checked = hp; toggleSection('Prepay', hp); if(hp) { setVal('calcPrepay', o.prepay); setVal('calcPrepaySlider', o.prepay); } if(o.prepayDate) setVal('calcPrepayDate', o.prepayDate);
        const ho = !!o.termOverride; $('toggleOverride').checked = ho; toggleSection('Override', ho); if(ho) setVal('calcTermOverride', o.termOverride);
        const hn = !!o.notes; $('toggleNotes').checked = hn; toggleSection('Notes', hn); if(hn) setVal('calcNotes', o.notes);
        const he = !!o.expiry; $('toggleExpiry').checked = he; toggleSection('Expiry', he); if(o.expiryDate) setVal('calcExpiryDate', o.expiryDate);
        
        const hd = !!o.docs;
        $('toggleDocs').checked = hd;
        toggleSection('Docs', hd);
        setVal('calcDocs', o.docsText || "Voided Check\nGovernment Issued ID");
        
        setFrequency(o.frequency);
        
        // Restore per-option rates to lender inputs (in lender mode)
        if (currentClientMode === 'lender' && o.buyRate && o.maxSell) {
            if ($('lenderBuyRate')) $('lenderBuyRate').value = o.buyRate;
            if ($('lenderMaxSell')) $('lenderMaxSell').value = o.maxSell;
            if ($('buyRateInput')) $('buyRateInput').value = o.buyRate.toFixed(2);
            if ($('maxSellRateInput')) $('maxSellRateInput').value = o.maxSell.toFixed(2);
            if ($('lenderBuyRateSlider')) { $('lenderBuyRateSlider').value = o.buyRate; updateSliderFill($('lenderBuyRateSlider')); }
            if ($('lenderMaxSellSlider')) { $('lenderMaxSellSlider').value = o.maxSell; updateSliderFill($('lenderMaxSellSlider')); }
            updateLenderDisplay();
        }
    }

    function updatePreview(animate = false) {
        const a = getVal('calcAmount', true); 
        const f = getVal('calcFactor', true) || 1.15; 
        const t = getVal('calcTerm', true) || 130;
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        const fe = $('toggleFee').checked ? (getVal('calcFee', true) || 0) : 0;
        const c = calculate(a, f, t, fr, fe);
        
        // Update ISO profit if in lender mode or ISO share/preview mode
        if ((currentClientMode === 'lender' || window.isoShareMode || window.isoPreviewMode) && !window._skipIsoUpdate) {
            updateIsoUpsell();
        }
        
        const bn = getVal('calcBusinessName');
        if(bn) { 
            $('previewBusinessName').textContent = bn; 
            $('previewBusinessName').classList.remove('hidden'); 
        } else { 
            $('previewBusinessName').classList.add('hidden'); 
        }
        
        if (calcOptions.length > 1) {
            $('previewLabelContainer').classList.remove('hidden');
            $('previewOptionLabel').textContent = `Option ${getLetter(activeCalcTab)}`;
        } else {
            $('previewLabelContainer').classList.add('hidden');
        }

        // Animate all numeric values
        animateNumber($('previewAmount'), c.amount, 1200);
        animateNumber($('previewPaybackChart'), c.totalPayback, 1200);
        
        const to = $('toggleOverride').checked ? getVal('calcTermOverride') : '';
        $('previewTermLength').textContent = getTermDisplay(t, fr, to); 
        animateNumber($('previewTermPayments'), c.term, 1200, (n) => Math.round(n).toString());
        animateNumber($('previewFactor'), c.factor, 1200, (n) => n.toFixed(2) + 'x');
        animateNumber($('previewCost'), c.totalCost, 1200);
        
        const pLabel = fr === 'weekly' ? 'Weekly Payment' : fr === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('previewPaymentLabel').textContent = pLabel;
        animateNumber($('previewPayment'), c.payment, 1200);
        
        if (fe > 0) { 
            $('previewFeeRow').classList.remove('hidden'); 
            animateNumber($('previewFeeAmount'), c.feeAmount, 1200); 
            animateNumber($('previewNet'), c.net, 1200); 
        } else { 
            $('previewFeeRow').classList.add('hidden'); 
        }
        
        // Prepay discount
        const prepayVal = $('togglePrepay').checked ? getVal('calcPrepay', true) : 0;
        if (prepayVal > 0) {
            $('previewPrepayRow').classList.remove('hidden');
            const prepayDate = getVal('calcPrepayDate');
            if (prepayDate) {
                $('previewPrepay').textContent = prepayVal + '% off if paid by ' + new Date(prepayDate).toLocaleDateString();
            } else {
                $('previewPrepay').textContent = prepayVal + '% off if paid early';
            }
        } else {
            $('previewPrepayRow').classList.add('hidden');
        }
        
        // Notes, Expiry, Docs - Separate Sections
        const hasExpiry = $('toggleExpiry').checked;
        const hasNotes = $('toggleNotes').checked;
        const hasDocs = $('toggleDocs').checked;
        
        // Expiry Section
        if (hasExpiry) {
            $('previewExpirySection').classList.remove('hidden');
            const expDate = getVal('calcExpiryDate');
            $('previewExpiryDate').textContent = expDate ? new Date(expDate).toLocaleDateString() : 'Not set';
        } else {
            $('previewExpirySection').classList.add('hidden');
        }
        
        // Notes Section
        if (hasNotes) {
            const notesList = $('previewNotesList');
            notesList.innerHTML = '';
            const notesText = getVal('calcNotes').trim();
            const items = notesText ? notesText.split('\n') : [];
            let hasItems = false;
            items.forEach(item => {
                if (!item.trim()) return;
                hasItems = true;
                const li = document.createElement('li');
                li.className = "flex items-center gap-2";
                li.innerHTML = `
                    <div class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(59, 130, 246, 0.2);">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" style="color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <span style="color: var(--text-secondary);">${item.trim()}</span>
                `;
                notesList.appendChild(li);
            });
            if (hasItems) {
                $('previewNotesSection').classList.remove('hidden');
            } else {
                $('previewNotesSection').classList.add('hidden');
            }
        } else {
            $('previewNotesSection').classList.add('hidden');
        }
        
        // Docs Section
        if (hasDocs) {
            $('previewDocsSection').classList.remove('hidden');
            const docsList = $('previewDocsList');
            docsList.innerHTML = '';
            const items = getVal('calcDocs').split('\n');
            items.forEach(item => {
                if (!item.trim()) return;
                const li = document.createElement('li');
                li.className = "flex items-center gap-2";
                li.innerHTML = `
                    <div class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-glow);">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <span>${item.trim()}</span>
                `;
                docsList.appendChild(li);
            });
        } else {
            $('previewDocsSection').classList.add('hidden');
        }
        
        // Source Info Section (ISO/Lender)
        const hasISO = $('toggleISO').checked;
        const hasLender = $('toggleLender').checked;
        const isoName = getVal('calcISOName');
        const lenderName = getVal('calcLenderName');
        if ((hasISO && isoName) || (hasLender && lenderName)) {
            $('previewSourceSection').classList.remove('hidden');
            const isoTag = $('previewISOTag');
            const lenderTag = $('previewLenderTag');
            if (hasISO && isoName) {
                isoTag.textContent = isoName;
                isoTag.classList.remove('hidden');
            } else {
                isoTag.classList.add('hidden');
            }
            if (hasLender && lenderName) {
                lenderTag.textContent = lenderName;
                lenderTag.classList.remove('hidden');
            } else {
                lenderTag.classList.add('hidden');
            }
        } else {
            $('previewSourceSection').classList.add('hidden');
        }
        
        const pp = c.totalPayback > 0 ? (c.amount / c.totalPayback) * 100 : 0; 
        $('previewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // ============================================
    // INLINE EDITING ON PREVIEW CARD
    // ============================================
    function initInlineEditing() {
        const editableFields = document.querySelectorAll('.editable-value[data-field]');
        
        editableFields.forEach(el => {
            // Prevent newlines
            el.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    el.blur();
                }
                if (e.key === 'Escape') {
                    el.blur();
                    updatePreview(); // Reset to form values
                }
            });
            
            // Handle blur - sync back to form
            el.addEventListener('blur', () => {
                const field = el.dataset.field;
                const rawValue = el.textContent.trim();
                
                syncInlineEdit(field, rawValue);
            });
            
            // Select all on focus for easy replacement
            el.addEventListener('focus', () => {
                const range = document.createRange();
                range.selectNodeContents(el);
                const sel = window.getSelection();
                sel.removeAllRanges();
                sel.addRange(range);
            });
        });
    }
    
    function syncInlineEdit(field, rawValue) {
        let numVal;
        
        switch(field) {
            case 'amount':
                // Parse currency: remove $, commas
                numVal = parseFloat(rawValue.replace(/[$,]/g, '')) || 0;
                if (numVal > 0) {
                    $('calcAmount').value = numVal;
                    $('calcAmountSlider').value = Math.min(numVal, 500000);
                }
                break;
                
            case 'termLength':
                // Could be "6 months" or just "6" - extract number
                numVal = parseInt(rawValue.replace(/[^\d]/g, '')) || 6;
                // Check for term override (if it has text like "months")
                if (rawValue.toLowerCase().includes('month') || rawValue.toLowerCase().includes('week')) {
                    $('toggleTermOverride').checked = true;
                    $('termOverrideContainer').classList.remove('hidden');
                    $('calcTermOverride').value = rawValue;
                } else {
                    // Just a number - use as term
                    $('calcTerm').value = numVal;
                    $('calcTermSlider').value = Math.min(numVal, 365);
                }
                break;
                
            case 'payments':
                numVal = parseInt(rawValue.replace(/[^\d]/g, '')) || 130;
                $('calcTerm').value = numVal;
                $('calcTermSlider').value = Math.min(numVal, 365);
                break;
                
            case 'factor':
                // Parse factor: "1.19x" or "1.19"
                numVal = parseFloat(rawValue.replace(/[x×]/gi, '')) || 1.19;
                if (numVal > 0 && numVal < 3) {
                    $('calcFactor').value = numVal;
                    $('calcFactorSlider').value = numVal;
                }
                break;
        }
        
        // Recalculate and update preview
        updatePreview();
    }
    
    // Initialize inline editing on load
    setTimeout(initInlineEditing, 100);

    // ============================================
    // CLIENT VIEW
    // ============================================
    function getCurrentData() {
        saveState(activeCalcTab);
        return {
            b: getVal('calcBusinessName'), c: getVal('calcContactName'),
            iso: $('toggleISO').checked ? getVal('calcISOName') : null,
            ln: $('toggleLender').checked ? getVal('calcLenderName') : null,
            ex: $('toggleExpiry').checked ? getVal('calcExpiryDate') : null,
            logo: currentLogoUrl,
            companyName: currentCompanyName,
            o: calcOptions.map(op => ({ a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, pd: op.prepayDate, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText }))
        };
    }

    function previewClientView() {
        console.log('previewClientView called');
        try {
            // Track client view
            window.clientViewed = true;
            updateModeStatusIcons();
            
            // Update tracking for existing offer if link exists
            const currentLink = getLink();
            updateOfferTrackingByLink(currentLink, 'clientView');
            
            // Hide ISO preview bar if visible
            const isoBar = $('isoPreviewBar');
            if (isoBar) isoBar.classList.add('hidden');
            
            // Clear ISO preview flags
            window.isoShareMode = false;
            window.isoPreviewMode = false;
            
            // Update mode toggle to show Client as active
            const clientBtn = $('clientModeBtn');
            const isoBtn = $('isoModeBtn');
            const lenderBtn = $('lenderModeBtn');
            if (clientBtn) clientBtn.classList.add('active');
            if (isoBtn) isoBtn.classList.remove('active');
            if (lenderBtn) lenderBtn.classList.remove('active');
            
            // Ensure factor rate is set to max sell rate for client preview
            const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
            if ($('calcFactor')) $('calcFactor').value = maxSell;
            if ($('calcFactorSlider')) $('calcFactorSlider').value = maxSell;
            
            const data = getCurrentData();
            console.log('data:', data);
            initClientView(data);
            $('clientPreviewBar').classList.remove('hidden');
            document.body.style.paddingTop = '72px';
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('previewClientView completed');
        } catch(e) {
            console.error('previewClientView error:', e);
        }
    }
    
    function openFloatingPreview() {
        // Get current data
        const data = getCurrentData();
        
        // Store current scroll position
        const scrollPos = window.scrollY;
        
        // Store current panel states
        const adminWasHidden = $('adminPanel').classList.contains('hidden');
        const clientWasHidden = $('clientPanel').classList.contains('hidden');
        
        // Temporarily show client panel to render it properly
        $('clientPanel').classList.remove('hidden');
        $('adminPanel').classList.add('hidden');
        
        // Initialize client view (this populates the clientPanel)
        clientData = data;
        clientActiveIdx = 0;
        
        $('clientGreeting').textContent = `Hello, ${data.c || 'Business Owner'}`;
        $('clientBusinessName').textContent = data.b || 'your business';
        if(data.ex) {
            $('clientExpirySection').classList.remove('hidden');
            $('clientExpiryDate').textContent = new Date(data.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        } else {
            $('clientExpirySection').classList.add('hidden');
        }
        
        // Handle Source Info (ISO/Lender)
        if (data.iso || data.ln) {
            $('clientSourceSection').classList.remove('hidden');
            const isoTag = $('clientISOTag');
            const lenderTag = $('clientLenderTag');
            if (data.iso) {
                isoTag.textContent = data.iso;
                isoTag.classList.remove('hidden');
            } else {
                isoTag.classList.add('hidden');
            }
            if (data.ln) {
                lenderTag.textContent = data.ln;
                lenderTag.classList.remove('hidden');
            } else {
                lenderTag.classList.add('hidden');
            }
        } else {
            $('clientSourceSection').classList.add('hidden');
        }
        
        // Handle logo
        const cLogoContainer = $('cPreviewLogoContainer');
        const cLogo = $('cPreviewLogo');
        if (data.logo) {
            cLogo.src = data.logo;
            cLogoContainer.classList.remove('hidden');
        } else {
            cLogoContainer.classList.add('hidden');
        }
        
        // Handle company name
        const cCompanyName = $('cPreviewCompanyName');
        if (data.companyName) {
            cCompanyName.textContent = data.companyName;
            cCompanyName.classList.remove('hidden');
        } else {
            cCompanyName.classList.add('hidden');
        }
        
        // Render tabs
        const tabsContainer = $('clientTabsContainer');
        tabsContainer.innerHTML = '';
        if(data.o && data.o.length > 1) {
            tabsContainer.classList.remove('hidden');
            data.o.forEach((opt, idx) => {
                const btn = document.createElement('button');
                btn.className = `py-1.5 px-5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border`;
                if (idx === 0) {
                    btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
                    btn.style.color = 'white';
                    btn.style.borderColor = 'var(--accent)';
                    btn.style.boxShadow = 'var(--shadow-md)';
                } else {
                    btn.style.background = 'rgba(255,255,255,0.1)';
                    btn.style.color = 'var(--text-muted)';
                    btn.style.borderColor = 'rgba(255,255,255,0.2)';
                }
                btn.textContent = `Option ${getLetter(idx)}`;
                tabsContainer.appendChild(btn);
            });
        } else {
            tabsContainer.classList.add('hidden');
        }
        
        // Setup first option display
        if (typeof setupClientOption === 'function') {
            setupClientOption(0);
        }
        
        // Clone the client panel content into the floating preview
        const container = $('floatingPreviewContent');
        const clientPanel = $('clientPanel');
        if (container && clientPanel) {
            container.innerHTML = clientPanel.innerHTML;
            
            // Animate all numeric values in the cloned modal
            if (clientData && clientData.o && clientData.o[0]) {
                const opt = clientData.o[0];
                const calc = calculate(opt.a, opt.f, opt.t, opt.q, opt.fe);
                
                const clonedAmount = container.querySelector('#cPreviewAmount');
                const clonedPayback = container.querySelector('#cPreviewPayback');
                const clonedCount = container.querySelector('#cPreviewCount');
                const clonedFactor = container.querySelector('#cPreviewFactor');
                const clonedCost = container.querySelector('#cPreviewCost');
                const clonedPayment = container.querySelector('#cPreviewPayment');
                const clonedFee = container.querySelector('#cPreviewFee');
                const clonedNet = container.querySelector('#cPreviewNet');
                
                if (clonedAmount) animateNumber(clonedAmount, calc.amount, 1200);
                if (clonedPayback) animateNumber(clonedPayback, calc.totalPayback, 1200);
                if (clonedCount) animateNumber(clonedCount, calc.term, 1200, (n) => Math.round(n).toString());
                if (clonedFactor) animateNumber(clonedFactor, calc.factor, 1200, (n) => n.toFixed(2) + 'x');
                if (clonedCost) animateNumber(clonedCost, calc.totalCost, 1200);
                if (clonedPayment) animateNumber(clonedPayment, calc.payment, 1200);
                if (clonedFee && calc.fee > 0) animateNumber(clonedFee, calc.feeAmount, 1200);
                if (clonedNet && calc.fee > 0) animateNumber(clonedNet, calc.net, 1200);
            }
        }
        
        // Restore panel states - show admin, hide client
        $('adminPanel').classList.remove('hidden');
        $('clientPanel').classList.add('hidden');
        
        // Show modal
        $('floatingPreviewModal').classList.remove('hidden');
        $('floatingPreviewBtn').classList.add('hidden');
        
        // Restore scroll position
        window.scrollTo(0, scrollPos);
    }
    
    function closeFloatingPreview() {
        $('floatingPreviewModal').classList.add('hidden');
        $('floatingPreviewBtn').classList.remove('hidden');
    }
    
    function copyLinkFromPreview() {
        const link = getLink();
        navigator.clipboard.writeText(link).then(() => {
            showToast('Link copied!');
        }).catch(() => {
            prompt('Copy this link:', link);
        });
    }
    
    function previewISOView() {
        console.log('=== previewISOView START ===');
        try {
            // Track ISO view
            window.isoViewed = true;
            updateModeStatusIcons();
            
            // Update tracking for existing offer if link exists
            const currentLink = getLink();
            updateOfferTrackingByLink(currentLink, 'isoView');
            
            // Get current lender rates (use defaults if in ISO mode)
            const buyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
            const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
            console.log('Rates - Buy:', buyRate, 'MaxSell:', maxSell);
            
            // Temporarily enable ISO preview mode flags
            window.isoShareMode = true;
            window.isoPreviewMode = true;
            lenderBuyRate = buyRate;
            lenderMaxSellRate = maxSell;
            
            // Expand Structure Your Offer card if collapsed (for mobile)
            const structureCard = $('structureOfferCard');
            if (structureCard && structureCard.classList.contains('collapsed')) {
                structureCard.classList.remove('collapsed');
            }
            
            // Set up ISO upsell slider with correct bounds
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            console.log('Slider elements - sellSlider:', !!sellSlider, 'sellInput:', !!sellInput);
            
            if (sellSlider && sellInput) {
                // Set bounds first
                sellSlider.min = buyRate;
                sellSlider.max = maxSell;
                sellSlider.step = 0.01;
                
                // Default to max sell rate (full margin for ISO)
                sellSlider.value = maxSell;
                sellInput.value = maxSell.toFixed(2);
                
                updateSliderFill(sellSlider);
                console.log('Slider configured');
            }
            
            // Update buy rate display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
            
            // Show ISO section, hide lender section
            const isoUpsellSection = $('isoUpsellSection');
            const lenderRateSection = $('lenderRateSection');
            console.log('Sections - isoUpsell:', !!isoUpsellSection, 'lenderRate:', !!lenderRateSection);
            
            if (isoUpsellSection) {
                isoUpsellSection.classList.remove('hidden');
                console.log('isoUpsellSection shown');
            }
            if (lenderRateSection) {
                lenderRateSection.classList.add('hidden');
                console.log('lenderRateSection hidden');
            }
            
            // Set factor rate to max sell rate (ISO's default sell rate)
            const calcFactor = $('calcFactor');
            const calcFactorSlider = $('calcFactorSlider');
            if (calcFactor) calcFactor.value = maxSell.toFixed(2);
            if (calcFactorSlider) {
                calcFactorSlider.value = maxSell;
                updateSliderFill(calcFactorSlider);
            }
            
            // Update ISO profit display and recalculate with animation
            updateIsoUpsell();
            updatePreview(true);
            
            // Show ISO preview bar
            const previewBar = $('isoPreviewBar');
            console.log('isoPreviewBar element:', !!previewBar);
            if (previewBar) {
                previewBar.classList.remove('hidden');
                document.body.style.paddingTop = '72px';
                console.log('isoPreviewBar shown');
            }
            
            showToast('ISO Preview: Showing what your ISO partner sees');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('=== previewISOView END ===');
        } catch(e) {
            console.error('previewISOView error:', e);
            showToast('Error entering ISO preview mode');
        }
    }
    
    function exitISOPreview() {
        window.isoShareMode = false;
        window.isoPreviewMode = false;
        
        const isoUpsellSection = $('isoUpsellSection');
        const lenderRateSection = $('lenderRateSection');
        const isoPreviewBar = $('isoPreviewBar');
        
        // Restore based on current client mode
        if (currentClientMode === 'lender') {
            if (lenderRateSection) lenderRateSection.classList.remove('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
            // Restore lender display (resets factor rate to buy rate)
            updateLenderDisplay();
        } else {
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
        }
        
        // Hide preview bar
        if (isoPreviewBar) isoPreviewBar.classList.add('hidden');
        document.body.style.paddingTop = '0';
        
        updatePreview();
        showToast('Returned to editor mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exitPreview() {
        $('clientPanel').classList.add('hidden');
        $('adminPanel').classList.remove('hidden');
        $('clientPreviewBar').classList.add('hidden');
        document.body.style.paddingTop = '0';
        $('floatingPreviewBtn').classList.remove('hidden');
        
        // Reset mode toggle buttons
        const clientBtn = $('clientModeBtn');
        const isoBtn = $('isoModeBtn');
        const lenderBtn = $('lenderModeBtn');
        if (clientBtn) clientBtn.classList.remove('active');
        if (currentClientMode === 'iso') {
            if (isoBtn) isoBtn.classList.add('active');
        } else {
            if (lenderBtn) lenderBtn.classList.add('active');
        }
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function acceptOffer() {
        // Track acceptance
        window.clientAccepted = true;
        updateModeStatusIcons();
        
        // Update tracking in dashboard
        const currentUrl = window.location.href;
        updateOfferTrackingByLink(currentUrl, 'clientAccept');
        
        // Get accent color for confetti
        const style = getComputedStyle(document.documentElement);
        const accent = style.getPropertyValue('--accent').trim();
        const accentLight = style.getPropertyValue('--accent-light').trim();
        const accentDark = style.getPropertyValue('--accent-dark').trim();
        
        confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 },
            colors: [accent, accentLight, accentDark]
        });
        $('successModal').classList.remove('hidden');
    }

    function declineOffer() {
        if (confirm('Are you sure you want to decline this offer?')) {
            // Track decline
            window.clientDeclined = true;
            updateModeStatusIcons();
            
            // Update tracking in dashboard
            const currentUrl = window.location.href;
            updateOfferTrackingByLink(currentUrl, 'clientDecline');
            
            showToast('Offer declined. Thank you for your consideration.');
        }
    }

    function initClientView(data) {
        console.log('initClientView called with:', data);
        $('adminPanel').classList.add('hidden');
        $('clientPanel').classList.remove('hidden');
        $('floatingPreviewBtn').classList.add('hidden');
        console.log('panels toggled');
        
        clientData = data;
        clientActiveIdx = 0;
        
        $('clientGreeting').textContent = `Hello, ${data.c || 'Business Owner'}`;
        $('clientBusinessName').textContent = data.b || 'your business';
        if(data.ex) {
            $('clientExpirySection').classList.remove('hidden');
            $('clientExpiryDate').textContent = new Date(data.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }
        
        // Handle Source Info (ISO/Lender)
        if (data.iso || data.ln) {
            $('clientSourceSection').classList.remove('hidden');
            const isoTag = $('clientISOTag');
            const lenderTag = $('clientLenderTag');
            if (data.iso) {
                isoTag.textContent = data.iso;
                isoTag.classList.remove('hidden');
            } else {
                isoTag.classList.add('hidden');
            }
            if (data.ln) {
                lenderTag.textContent = data.ln;
                lenderTag.classList.remove('hidden');
            } else {
                lenderTag.classList.add('hidden');
            }
        } else {
            $('clientSourceSection').classList.add('hidden');
        }

        // Handle logo in client view
        const cLogoContainer = $('cPreviewLogoContainer');
        const cLogo = $('cPreviewLogo');
        if (data.logo) {
            cLogo.referrerPolicy = 'no-referrer';
            cLogo.src = data.logo;
            cLogo.onerror = function() {
                cLogoContainer.classList.add('hidden');
            };
            cLogo.onload = function() {
                cLogoContainer.classList.remove('hidden');
            };
        } else {
            cLogoContainer.classList.add('hidden');
        }

        // Handle company name in client view
        const cCompanyName = $('cPreviewCompanyName');
        if (data.companyName) {
            cCompanyName.textContent = data.companyName;
            cCompanyName.classList.remove('hidden');
        } else {
            cCompanyName.classList.add('hidden');
        }

        // Apply theme from share link
        if (data.theme) {
            setThemeMode(data.theme);
        }
        if (data.accent) {
            setAccentColor(data.accent);
        }

        const tabsContainer = $('clientTabsContainer');
        tabsContainer.innerHTML = '';
        if(data.o.length > 1) {
             tabsContainer.classList.remove('hidden');
             data.o.forEach((opt, idx) => {
                 const btn = document.createElement('button');
                 btn.className = `py-1.5 px-5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border`;
                 if (idx === 0) {
                     btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
                     btn.style.color = 'white';
                     btn.style.borderColor = 'var(--accent)';
                     btn.style.boxShadow = 'var(--shadow-md)';
                 } else {
                     btn.style.background = 'rgba(255,255,255,0.1)';
                     btn.style.color = 'var(--text-muted)';
                     btn.style.borderColor = 'rgba(255,255,255,0.2)';
                 }
                 btn.textContent = `Option ${getLetter(idx)}`;
                 btn.onclick = () => switchClientTab(idx, btn);
                 tabsContainer.appendChild(btn);
             });
        } else {
             tabsContainer.classList.add('hidden');
        }
        
        setupClientOption(0);
    }

    function switchClientTab(idx, btn) {
        clientActiveIdx = idx;
        const btns = $('clientTabsContainer').children;
        Array.from(btns).forEach(b => {
            b.style.background = 'rgba(255,255,255,0.1)';
            b.style.color = 'var(--text-muted)';
            b.style.borderColor = 'rgba(255,255,255,0.2)';
            b.style.boxShadow = 'none';
        });
        btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--accent)';
        btn.style.boxShadow = 'var(--shadow-md)';
        setupClientOption(idx);
    }

    function setupClientOption(idx) {
        console.log('setupClientOption called with idx:', idx);
        const opt = clientData.o[idx];
        console.log('opt:', opt);
        const maxAmt = opt.a;
        console.log('maxAmt:', maxAmt);
        
        clientSelectedAmount = maxAmt; 
        
        $('clientMaxLabelSlider').textContent = `Max ${formatCurrency(maxAmt)}`;
        
        const slider = $('clientAmountSlider');
        slider.min = 5000;
        slider.max = maxAmt;
        slider.step = 1; 
        slider.value = maxAmt;
        updateSliderFill(slider);
        
        const hasNotes = !!opt.n;
        const hasExpiry = !!clientData.ex; 
        const hasDocs = !!opt.d; 
        
        const termsContainer = $('clientTermsContainer');
        const expirySection = $('clientExpirySection');
        const notesSection = $('clientNotesSection');
        const docsSection = $('clientDocsSection');
        const notesDocsRow = $('clientNotesDocsRow');
        
        if (hasNotes || hasExpiry || hasDocs) {
            termsContainer.classList.remove('hidden');
            
            // Expiration Section
            if (hasExpiry) {
                expirySection.classList.remove('hidden');
                $('clientExpiryDate').textContent = new Date(clientData.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); 
            } else {
                expirySection.classList.add('hidden');
            }
            
            // Notes & Docs Row
            if (hasNotes || hasDocs) {
                notesDocsRow.classList.remove('hidden');
            } else {
                notesDocsRow.classList.add('hidden');
            }
            
            // Notes Section
            if (hasNotes) {
                notesSection.classList.remove('hidden');
                const notesList = $('clientNotesList');
                notesList.innerHTML = '';
                const items = opt.n.split('\n');
                items.forEach(item => {
                    if (!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    notesList.appendChild(li);
                });
            } else {
                notesSection.classList.add('hidden');
            }

            // Documents Section
            if (hasDocs) {
                docsSection.classList.remove('hidden');
                const docsList = $('clientDocsList');
                docsList.innerHTML = '';
                const items = (opt.dt || "Voided Check\nGovernment Issued ID").split('\n');
                
                items.forEach(item => {
                    if(!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="color: #8b5cf6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    docsList.appendChild(li);
                });

            } else {
                docsSection.classList.add('hidden');
            }

        } else {
            termsContainer.classList.add('hidden');
        }

        updateClientPreview(true);
    }

    function updateClientPreview(animate = false) {
        const opt = clientData.o[clientActiveIdx];
        const amt = clientSelectedAmount;
        
        const calc = calculate(amt, opt.f, opt.t, opt.q, opt.fe);
        
        if (clientData.o.length > 1) {
             $('cPreviewLabelContainer').classList.add('hidden');
        } else {
             $('cPreviewLabelContainer').classList.add('hidden');
        }

        // Animate all numeric values
        animateNumber($('cPreviewAmount'), calc.amount, 1200);
        animateNumber($('cPreviewPayback'), calc.totalPayback, 1200);
        
        $('cPreviewTerm').textContent = getTermDisplay(opt.t, opt.q, opt.to);
        animateNumber($('cPreviewCount'), calc.term, 1200, (n) => Math.round(n).toString());
        animateNumber($('cPreviewFactor'), calc.factor, 1200, (n) => n.toFixed(2) + 'x');
        animateNumber($('cPreviewCost'), calc.totalCost, 1200);
        
        if(calc.fee > 0) {
            $('cPreviewFeeRow').classList.remove('hidden');
            animateNumber($('cPreviewFee'), calc.feeAmount, 1200);
            animateNumber($('cPreviewNet'), calc.net, 1200);
        } else {
            $('cPreviewFeeRow').classList.add('hidden');
        }
        
        // Prepay discount
        if (opt.pp && opt.pp > 0) {
            $('cPreviewPrepayRow').classList.remove('hidden');
            if (opt.pd) {
                $('cPreviewPrepay').textContent = opt.pp + '% off if paid by ' + new Date(opt.pd).toLocaleDateString();
            } else {
                $('cPreviewPrepay').textContent = opt.pp + '% off if paid early';
            }
        } else {
            $('cPreviewPrepayRow').classList.add('hidden');
        }
        
        const pLabel = opt.q === 'weekly' ? 'Weekly Payment' : opt.q === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('cPreviewPaymentLabel').textContent = pLabel;
        animateNumber($('cPreviewPayment'), calc.payment, 1200);
        
        const pp = calc.totalPayback > 0 ? (calc.amount / calc.totalPayback) * 100 : 0; 
        $('cPreviewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function updateSliderFill(s) { 
        if (!s) return; 
        const m = parseFloat(s.min), mx = parseFloat(s.max), v = parseFloat(s.value);
        const p = ((v - m) / (mx - m)) * 100; 
        const isDark = s.classList.contains('slider-dark');
        const trackColor = isDark ? 'rgba(255,255,255,0.12)' : 'var(--slider-track)';
        s.style.background = `linear-gradient(to right, var(--accent) 0%, var(--accent-light) ${p}%, ${trackColor} ${p}%, ${trackColor} 100%)`; 
    }
    
    function updateSliders() { 
        $$('.slider').forEach(s => updateSliderFill(s)); 
    }

    function toggleSection(id, show) { 
        const el = $('sec'+id); 
        if(show) { 
            el.classList.remove('hidden'); 
            el.classList.add('fade-enter'); 
            updatePreview();
        } else { 
            el.classList.add('hidden'); 
            updatePreview(); 
        } 
    }

    function setFrequency(f) { 
        $$('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.freq === f)); 
        updatePreview(); 
    }

    function resetCalculator() { 
        calcOptions = [initDefaultOption()]; 
        activeCalcTab = 0; 
        setVal('calcBusinessName',''); setVal('calcContactName',''); 
        setVal('calcISOName',''); setVal('calcLenderName','');
        ['toggleFee','togglePrepay','toggleOverride','toggleExpiry','toggleNotes','toggleDocs','toggleISO','toggleLender'].forEach(id => { 
            const el = $(id); if(el) { el.checked = false; toggleSection(id.replace('toggle',''), false); }
        });
        updateTabsUI(); loadState(0); updatePreview(); updateSliders(); 
        showToast('Calculator Reset');
    }
    
    function shareOffer() { 
        saveState(activeCalcTab); 
        $('shareModal').classList.remove('hidden'); 
    }

    function getLink() {
        saveState(activeCalcTab);
        const d = { 
            b: getVal('calcBusinessName'), c: getVal('calcContactName'), 
            iso: $('toggleISO').checked ? getVal('calcISOName') : null, 
            ln: $('toggleLender').checked ? getVal('calcLenderName') : null,
            ex: $('toggleExpiry').checked ? getVal('calcExpiryDate') : null,
            logo: currentLogoUrl,
            companyName: currentCompanyName,
            theme: currentTheme,
            accent: currentAccent,
            o: calcOptions.map(op => ({ 
                a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, pd: op.prepayDate, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText,
                lk: op.locked ? 1 : 0,
                la: op.lockedAmount,
                lt: op.lockedTerm,
                lq: op.lockedFrequency,
                lb: op.lockedBuyRate,
                lm: op.lockedMaxSell
            }))
        };
        const json = JSON.stringify(d);
        const enc = LZString.compressToEncodedURIComponent(json);
        return `${window.location.origin}${window.location.pathname}?d=${enc}`;
    }
    
    function copyLink() { 
        console.log('copyLink() called');
        try {
            const l = getLink(); 
            console.log('Generated link:', l);
            saveOfferToDashboard(l, 'clientShareLink');
            
            window.clientLinkShared = true;
            updateModeStatusIcons();
            
            if (navigator.clipboard) { 
                navigator.clipboard.writeText(l).then(() => {
                    console.log('Clipboard write success');
                    showToast('Link copied!');
                }).catch((err) => {
                    console.log('Clipboard failed, using prompt', err);
                    prompt("Copy Link:", l);
                }); 
            } else { 
                console.log('No clipboard API, using prompt');
                prompt("Copy Link:", l); 
            }
            $('shareModal').classList.add('hidden');
        } catch(e) {
            console.error('copyLink error:', e);
            alert('Error: ' + e.message);
        }
    }
    
    function copySMS() {
        console.log('copySMS() called');
        try {
            const smsLink = getSMSLink();
            console.log('Generated SMS link:', smsLink);
            saveOfferToDashboard(smsLink, 'smsShare');
            
            window.clientLinkShared = true;
            updateModeStatusIcons();
            
            const opt = calcOptions[0];
            const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
            const amt = opt.amount >= 1000 ? '$' + Math.round(opt.amount / 1000) + 'K' : '$' + opt.amount;
            const businessName = getVal('calcBusinessName') || '';
            const contactName = getVal('calcContactName') || '';
            const name = businessName || contactName || 'Your Business';
            const sms = `${amt} Approval for ${name} - View or Accept: ${smsLink}`;
            
            if (navigator.clipboard) { 
                navigator.clipboard.writeText(sms).then(() => {
                    console.log('SMS clipboard success');
                    showToast('SMS copied!');
                }).catch((err) => {
                    console.log('SMS clipboard failed', err);
                    prompt("Copy SMS:", sms);
                }); 
            } else { 
                prompt("Copy SMS:", sms); 
            }
            $('shareModal').classList.add('hidden');
        } catch(e) {
            console.error('copySMS error:', e);
            alert('Error: ' + e.message);
        }
    }
    
    function getSMSLink() {
        // Generate minimal link for SMS (excludes non-essential data)
        saveState(activeCalcTab);
        const d = { 
            b: getVal('calcBusinessName'), 
            c: getVal('calcContactName'),
            theme: currentTheme,
            accent: currentAccent,
            o: calcOptions.map(op => ({ 
                a: op.amount, f: op.factor, t: op.term, q: op.frequency, to: op.termOverride
            }))
        };
        const json = JSON.stringify(d);
        const enc = LZString.compressToEncodedURIComponent(json);
        return `${window.location.origin}${window.location.pathname}?d=${enc}`;
    }
    
    // ============================================
    // OFFER DASHBOARD FUNCTIONS
    // ============================================
    
    function getStoredOffers() {
        try {
            const offers = JSON.parse(localStorage.getItem('trustbureau_offers') || '[]');
            // Filter out any corrupted/incomplete offers
            return offers.filter(o => o && o.id && o.factor !== undefined);
        } catch (e) {
            return [];
        }
    }
    
    function saveStoredOffers(offers) {
        localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
    }
    
    function saveOfferToDashboard(link, trackingEvent = 'created') {
        const offers = getStoredOffers();
        const businessName = getVal('calcBusinessName') || 'Unnamed Business';
        const contactName = getVal('calcContactName') || '';
        const isoName = getVal('calcISOName') || '';
        const lenderName = getVal('calcLenderName') || '';
        
        // Check if offer with this link already exists
        const existingOffer = offers.find(o => o.link === link);
        if (existingOffer) {
            // Update business name and ISO/Lender name if changed
            if (businessName && businessName !== 'Unnamed Business') {
                existingOffer.businessName = businessName;
            }
            if (isoName) existingOffer.isoName = isoName;
            if (lenderName) existingOffer.lenderName = lenderName;
            if (contactName) existingOffer.contactName = contactName;
            // Update tracking on existing offer
            updateOfferTracking(existingOffer.id, trackingEvent);
            return existingOffer.id;
        }
        
        // Get first option details for summary
        const opt = calcOptions[0];
        if (!opt || !opt.factor) {
            console.warn('No valid option to save');
            return null;
        }
        const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
        
        const offer = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            businessName: businessName,
            contactName: contactName,
            isoName: isoName,
            lenderName: lenderName,
            amount: opt.amount || 0,
            factor: opt.factor || 1.0,
            term: opt.term || 0,
            frequency: opt.frequency || 'daily',
            payment: cal.payment || 0,
            totalPayback: cal.totalPayback || 0,
            optionCount: calcOptions.length,
            link: link,
            createdAt: new Date().toISOString(),
            mode: currentClientMode || 'iso',
            // Tracking fields
            tracking: {
                lenderLocked: null,
                isoShared: null,
                isoViewed: null,
                clientShared: null,
                clientShareMethod: null, // 'link' or 'email'
                clientViewed: null,
                clientDeclined: null,
                clientAccepted: null
            }
        };
        
        // Set initial tracking based on event
        if (trackingEvent === 'lenderLock') {
            offer.tracking.lenderLocked = new Date().toISOString();
        } else if (trackingEvent === 'isoShare') {
            offer.tracking.isoShared = new Date().toISOString();
        } else if (trackingEvent === 'clientShareLink') {
            offer.tracking.clientShared = new Date().toISOString();
            offer.tracking.clientShareMethod = 'link';
        } else if (trackingEvent === 'clientShareEmail') {
            offer.tracking.clientShared = new Date().toISOString();
            offer.tracking.clientShareMethod = 'email';
        }
        
        offers.unshift(offer); // Add to beginning
        
        // Keep max 100 offers
        if (offers.length > 100) {
            offers.splice(100);
        }
        
        saveStoredOffers(offers);
        updateOfferCount();
        return offer.id;
    }
    
    function updateOfferTracking(offerId, event) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (!offer) return;
        
        // Initialize tracking if missing
        if (!offer.tracking) {
            offer.tracking = {
                lenderLocked: null,
                isoShared: null,
                isoViewed: null,
                clientShared: null,
                clientShareMethod: null,
                clientViewed: null,
                clientDeclined: null,
                clientAccepted: null
            };
        }
        
        const now = new Date().toISOString();
        
        switch(event) {
            case 'lenderLock':
                offer.tracking.lenderLocked = now;
                break;
            case 'isoShare':
                offer.tracking.isoShared = now;
                break;
            case 'isoView':
                offer.tracking.isoViewed = now;
                break;
            case 'clientShareLink':
                offer.tracking.clientShared = now;
                offer.tracking.clientShareMethod = 'link';
                break;
            case 'clientShareEmail':
                offer.tracking.clientShared = now;
                offer.tracking.clientShareMethod = 'email';
                break;
            case 'clientView':
                offer.tracking.clientViewed = now;
                break;
            case 'clientDecline':
                offer.tracking.clientDeclined = now;
                break;
            case 'clientAccept':
                offer.tracking.clientAccepted = now;
                break;
        }
        
        saveStoredOffers(offers);
        renderOffersDashboard();
    }
    
    function updateOfferTrackingByLink(link, event) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.link === link);
        if (offer) {
            updateOfferTracking(offer.id, event);
        }
    }
    
    function getOfferStatus(offer) {
        if (!offer.tracking) return { label: 'Pending', class: 'pending' };
        
        const t = offer.tracking;
        if (t.clientAccepted) return { label: 'Accepted', class: 'accepted' };
        if (t.clientDeclined) return { label: 'Declined', class: 'declined' };
        if (t.clientViewed) return { label: 'Client Viewed', class: 'client-viewed' };
        if (t.clientShared) return { label: 'With Client', class: 'client-shared' };
        if (t.isoViewed) return { label: 'ISO Viewed', class: 'iso-viewed' };
        if (t.isoShared) return { label: 'With ISO', class: 'iso-shared' };
        if (t.lenderLocked) return { label: 'Locked', class: 'locked' };
        return { label: 'Draft', class: 'draft' };
    }
    
    function updateOfferCount() {
        const offers = getStoredOffers();
        const countEl = $('offerCount');
        const stickyCountEl = $('stickyOfferCount');
        if (offers.length > 0) {
            if (countEl) {
                countEl.textContent = offers.length;
                countEl.classList.remove('hidden');
            }
            if (stickyCountEl) {
                stickyCountEl.textContent = offers.length;
                stickyCountEl.classList.remove('hidden');
            }
        } else {
            if (countEl) countEl.classList.add('hidden');
            if (stickyCountEl) stickyCountEl.classList.add('hidden');
        }
    }
    
    function loadOfferCount() {
        updateOfferCount();
    }
    
    // Pipeline view state
    window.pipelineView = 'list';
    window.showArchived = false;
    window.showStarredOnly = false;
    window.chartPeriod = 'week';
    window.currentMetricFilter = 'all';
    
    const STALE_DAYS = 3; // Days before an offer is considered stale
    const AVAILABLE_TAGS = [
        { id: 'hot-lead', label: 'Hot Lead', color: '#f87171' },
        { id: 'renewal', label: 'Renewal', color: '#34d399' },
        { id: 'referral', label: 'Referral', color: '#a78bfa' },
        { id: 'follow-up', label: 'Follow Up', color: '#fbbf24' },
        { id: 'vip', label: 'VIP', color: '#f472b6' }
    ];
    
    function openDashboard() {
        renderOffersDashboard();
        $('dashboardModal').classList.remove('hidden');
        
        // Re-attach Clear All button handler each time modal opens
        setTimeout(() => {
            const clearBtn = $('clearAllBtn');
            if (clearBtn) {
                clearBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.opacity = '0.5';
                    clearAllOffers();
                    this.style.opacity = '1';
                };
            }
        }, 100);
    }
    
    function closeDashboard() {
        $('dashboardModal').classList.add('hidden');
    }
    
    function renderOffersDashboard(searchFilter = '') {
        const allOffers = getStoredOffers();
        
        // Filter archived unless showing
        let offers = window.showArchived 
            ? allOffers 
            : allOffers.filter(o => !o.archived);
        
        // Render enhanced stats
        renderEnhancedStats(offers);
        
        // Render volume chart
        renderVolumeChart(allOffers);
        
        // Filter by search
        let filtered = searchFilter 
            ? offers.filter(o => (o.businessName || '').toLowerCase().includes(searchFilter.toLowerCase()) ||
                                 (o.isoName || '').toLowerCase().includes(searchFilter.toLowerCase()) ||
                                 (o.lenderName || '').toLowerCase().includes(searchFilter.toLowerCase()) ||
                                 (o.contactName || '').toLowerCase().includes(searchFilter.toLowerCase()))
            : offers;
        
        // Filter starred only
        if (window.showStarredOnly) {
            filtered = filtered.filter(o => o.starred);
        }
        
        // Sort: starred first, then by date
        filtered.sort((a, b) => {
            if (a.starred && !b.starred) return -1;
            if (!a.starred && b.starred) return 1;
            return new Date(b.createdAt || 0) - new Date(a.createdAt || 0);
        });
        
        // Render based on view
        if (window.pipelineView === 'kanban') {
            $('offersTableContainer').classList.add('hidden');
            $('kanbanContainer').classList.remove('hidden');
            renderKanbanBoard(filtered);
        } else {
            $('offersTableContainer').classList.remove('hidden');
            $('kanbanContainer').classList.add('hidden');
            renderListView(filtered, offers.length, searchFilter);
        }
        
        // Update toolbar button states
        $('showArchivedBtn').classList.toggle('active', window.showArchived);
        $('showStarredBtn').classList.toggle('active', window.showStarredOnly);
    }
    
    function renderEnhancedStats(offers) {
        const container = $('enhancedStats');
        if (!container) return;
        
        const total = offers.length;
        if (total === 0) {
            container.innerHTML = `
                <div class="enhanced-stat"><div class="enhanced-stat-value">0</div><div class="enhanced-stat-label">ISO</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Re-share Rate</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Client Share Rate</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Client View Rate</div></div>
                <div class="enhanced-stat"><div class="enhanced-stat-value">0%</div><div class="enhanced-stat-label">Acceptance Rate</div></div>
            `;
            return;
        }
        
        // Calculate stats from tracking
        let isoShares = 0, reShares = 0, clientShares = 0, clientViews = 0, clientAccepts = 0;
        
        offers.forEach(o => {
            const t = o.tracking || {};
            if (t.isoShared) isoShares++;
            if (t.reshareCount && t.reshareCount > 0) reShares++;
            if (t.clientShared) clientShares++;
            if (t.clientViewed) clientViews++;
            if (t.clientAccepted) clientAccepts++;
        });
        
        // Calculate rates
        const reShareRate = total > 0 ? Math.round((reShares / total) * 100) : 0;
        const clientShareRate = total > 0 ? Math.round((clientShares / total) * 100) : 0;
        const clientViewRate = clientShares > 0 ? Math.round((clientViews / clientShares) * 100) : 0;
        const acceptanceRate = clientViews > 0 ? Math.round((clientAccepts / clientViews) * 100) : 0;
        
        container.innerHTML = `
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${isoShares}</div>
                <div class="enhanced-stat-label">ISO</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${reShareRate}%</div>
                <div class="enhanced-stat-label">Re-share Rate</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${clientShareRate}%</div>
                <div class="enhanced-stat-label">Client Share Rate</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${clientViewRate}%</div>
                <div class="enhanced-stat-label">Client View Rate</div>
            </div>
            <div class="enhanced-stat">
                <div class="enhanced-stat-value">${acceptanceRate}%</div>
                <div class="enhanced-stat-label">Acceptance Rate</div>
            </div>
        `;
    }
    
    function renderVolumeChart(offers) {
        const container = $('volumeChart');
        if (!container) return;
        
        const now = new Date();
        const isWeek = window.chartPeriod === 'week';
        const periods = isWeek ? 7 : 4;
        const data = [];
        
        for (let i = periods - 1; i >= 0; i--) {
            let start, end, label;
            if (isWeek) {
                start = new Date(now);
                start.setDate(now.getDate() - i);
                start.setHours(0, 0, 0, 0);
                end = new Date(start);
                end.setHours(23, 59, 59, 999);
                label = start.toLocaleDateString('en-US', { weekday: 'short' }).charAt(0);
            } else {
                start = new Date(now);
                start.setDate(now.getDate() - (i * 7) - 6);
                start.setHours(0, 0, 0, 0);
                end = new Date(start);
                end.setDate(start.getDate() + 6);
                end.setHours(23, 59, 59, 999);
                label = 'W' + (periods - i);
            }
            
            const count = offers.filter(o => {
                const created = new Date(o.createdAt || 0);
                return created >= start && created <= end;
            }).length;
            
            data.push({ label, count });
        }
        
        const maxCount = Math.max(...data.map(d => d.count), 1);
        
        container.innerHTML = data.map(d => `
            <div class="volume-bar-wrap">
                <div class="volume-bar" style="height: ${Math.max((d.count / maxCount) * 60, 4)}px;">
                    <span class="volume-bar-value">${d.count}</span>
                </div>
                <span class="volume-bar-label">${d.label}</span>
            </div>
        `).join('');
        
        // Update period buttons
        document.querySelectorAll('.volume-chart-period button').forEach(btn => {
            btn.classList.toggle('active', btn.textContent.toLowerCase() === window.chartPeriod);
        });
    }
    
    function setChartPeriod(period) {
        window.chartPeriod = period;
        renderVolumeChart(getStoredOffers());
    }
    
    function setPipelineView(view) {
        window.pipelineView = view;
        $('listViewBtn').classList.toggle('active', view === 'list');
        $('kanbanViewBtn').classList.toggle('active', view === 'kanban');
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function toggleShowArchived() {
        window.showArchived = !window.showArchived;
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function toggleShowStarred() {
        window.showStarredOnly = !window.showStarredOnly;
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function getOfferStage(offer) {
        const t = offer.tracking || {};
        if (offer.funded || t.funded) return 'funded';
        if (t.clientAccepted) return 'accepted';
        if (t.clientViewed || t.isoViewed) return 'viewed';
        if (t.clientShared || t.isoShared) return 'sent';
        return 'draft';
    }
    
    function isOfferStale(offer) {
        const t = offer.tracking || {};
        const sentTime = t.clientSharedAt || t.isoSharedAt;
        if (!sentTime) return false;
        if (t.clientViewed || t.isoViewed) return false;
        
        const daysSinceSent = (Date.now() - new Date(sentTime)) / (1000 * 60 * 60 * 24);
        return daysSinceSent >= STALE_DAYS;
    }
    
    function renderKanbanBoard(offers) {
        const stages = ['draft', 'sent', 'viewed', 'accepted', 'funded'];
        const grouped = { draft: [], sent: [], viewed: [], accepted: [], funded: [] };
        
        offers.forEach(offer => {
            const stage = getOfferStage(offer);
            if (grouped[stage]) grouped[stage].push(offer);
        });
        
        stages.forEach(stage => {
            const container = $(`kanban-${stage}`);
            const countEl = $(`kanban-count-${stage}`);
            if (!container) return;
            
            countEl.textContent = grouped[stage].length;
            
            if (grouped[stage].length === 0) {
                container.innerHTML = `<div style="text-align:center;padding:20px;color:var(--text-muted);font-size:11px;">No offers</div>`;
                return;
            }
            
            container.innerHTML = grouped[stage].map(offer => renderKanbanCard(offer)).join('');
        });
    }
    
    function renderKanbanCard(offer) {
        const isStale = isOfferStale(offer);
        const date = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '';
        const amount = offer.amount ? '$' + offer.amount.toLocaleString() : '';
        const tags = offer.tags || [];
        
        return `
            <div class="kanban-card ${offer.starred ? 'starred' : ''} ${isStale ? 'stale' : ''} ${offer.archived ? 'archived' : ''}" onclick="openOfferLink('${offer.id}')">
                <div class="kanban-card-header">
                    <span class="kanban-card-title">${escapeHtml(offer.businessName || 'Unnamed')}</span>
                    <span class="kanban-card-star ${offer.starred ? 'active' : ''}" onclick="event.stopPropagation(); toggleStar('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${offer.starred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                        </svg>
                    </span>
                </div>
                ${amount ? `<div class="kanban-card-amount">${amount}</div>` : ''}
                <div class="kanban-card-meta">
                    <span class="kanban-card-date">${date}</span>
                    ${isStale ? '<span class="kanban-card-stale">⚠ Stale</span>' : ''}
                </div>
                ${tags.length > 0 ? `
                    <div class="offer-tags">
                        ${tags.map(tag => `<span class="offer-tag ${tag}">${AVAILABLE_TAGS.find(t => t.id === tag)?.label || tag}</span>`).join('')}
                    </div>
                ` : ''}
            </div>
        `;
    }
    
    function renderListView(filtered, totalCount, searchFilter) {
        const container = $('offersTableContainer');
        
        if (totalCount === 0) {
            container.innerHTML = `
                <div class="dashboard-empty">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3>No offers yet</h3>
                    <p>Share an offer to start tracking it here</p>
                </div>
            `;
            return;
        }
        
        if (filtered.length === 0) {
            container.innerHTML = `
                <div class="dashboard-empty">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <h3>No matches</h3>
                    <p>${searchFilter ? `No offers found for "${escapeHtml(searchFilter)}"` : 'No matching offers'}</p>
                </div>
            `;
            return;
        }
        
        container.innerHTML = filtered.map(offer => renderOfferCard(offer)).join('');
        
        // Animate all numeric values in the rendered cards
        container.querySelectorAll('.animate-amount').forEach(el => {
            const amount = parseFloat(el.dataset.amount) || 0;
            if (amount > 0) animateNumber(el, amount, 1200);
        });
        container.querySelectorAll('.animate-factor').forEach(el => {
            const factor = parseFloat(el.dataset.factor) || 0;
            if (factor > 0) animateNumber(el, factor, 1200, (n) => n.toFixed(2) + 'x');
        });
        container.querySelectorAll('.animate-profit').forEach(el => {
            const profit = parseFloat(el.dataset.profit) || 0;
            if (profit > 0) animateNumber(el, profit, 1200, (n) => '+$' + Math.round(n).toLocaleString());
        });
    }
    
    function toggleStar(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            offer.starred = !offer.starred;
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function archiveOffer(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            offer.archived = !offer.archived;
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function markAsFunded(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            offer.funded = !offer.funded;
            if (!offer.tracking) offer.tracking = {};
            offer.tracking.funded = offer.funded;
            offer.tracking.fundedAt = offer.funded ? new Date().toISOString() : null;
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function toggleOfferTag(offerId, tagId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            if (!offer.tags) offer.tags = [];
            const idx = offer.tags.indexOf(tagId);
            if (idx >= 0) {
                offer.tags.splice(idx, 1);
            } else {
                offer.tags.push(tagId);
            }
            localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
            renderOffersDashboard($('dashboardSearch')?.value || '');
        }
    }
    
    function showTagPicker(offerId, event) {
        event.stopPropagation();
        // Close any open pickers
        document.querySelectorAll('.tag-picker-dropdown.show').forEach(el => el.classList.remove('show'));
        const dropdown = document.getElementById(`tag-picker-${offerId}`);
        if (dropdown) dropdown.classList.toggle('show');
    }
    
    // Close tag picker when clicking outside
    document.addEventListener('click', () => {
        document.querySelectorAll('.tag-picker-dropdown.show').forEach(el => el.classList.remove('show'));
    });
    
    function calculatePipelineMetrics(offers) {
        const metrics = {
            total: offers.length,
            locked: 0,
            isoShared: 0,
            isoViewed: 0,
            clientShared: 0,
            clientViewed: 0,
            accepted: 0,
            declined: 0,
            pending: 0
        };
        
        offers.forEach(offer => {
            const t = offer.tracking || {};
            if (t.lenderLocked) metrics.locked++;
            if (t.isoShared) metrics.isoShared++;
            if (t.isoViewed) metrics.isoViewed++;
            if (t.clientShared) metrics.clientShared++;
            if (t.clientViewed) metrics.clientViewed++;
            if (t.clientAccepted) metrics.accepted++;
            else if (t.clientDeclined) metrics.declined++;
            else if (t.clientShared || t.isoShared) metrics.pending++;
        });
        
        return metrics;
    }
    
    function renderPipelineMetrics(container, metrics, total) {
        if (!container) return;
        
        // Calculate rates
        const totalShared = metrics.isoShared + metrics.clientShared - (metrics.clientShared > 0 && metrics.isoShared > 0 ? Math.min(metrics.isoShared, metrics.clientShared) : 0);
        const totalViewed = metrics.isoViewed + metrics.clientViewed;
        const shareRate = total > 0 ? Math.round(((metrics.isoShared || metrics.clientShared ? 1 : 0) * metrics.isoShared + (metrics.clientShared ? 1 : 0) * metrics.clientShared) / total / (metrics.isoShared && metrics.clientShared ? 2 : 1) * 100) : 0;
        
        // Simpler: just count unique offers that have been shared to anyone
        let sharedOffers = 0;
        let viewedOffers = 0;
        const offers = getStoredOffers();
        offers.forEach(o => {
            const t = o.tracking || {};
            if (t.isoShared || t.clientShared) sharedOffers++;
            if (t.isoViewed || t.clientViewed) viewedOffers++;
        });
        
        const viewRate = sharedOffers > 0 ? Math.round((viewedOffers / sharedOffers) * 100) : 0;
        const acceptRate = viewedOffers > 0 ? Math.round((metrics.accepted / viewedOffers) * 100) : 0;
        const declineRate = viewedOffers > 0 ? Math.round((metrics.declined / viewedOffers) * 100) : 0;
        
        container.innerHTML = `
            <div class="metric-card total" onclick="filterOffersByMetric('all')" title="Show all offers">
                <div class="metric-value">${total}</div>
                <div class="metric-label">Total Offers</div>
            </div>
            <div class="metric-card shared" onclick="filterOffersByMetric('shared')" title="Show shared offers">
                <div class="metric-value">${sharedOffers}</div>
                <div class="metric-count">${total > 0 ? Math.round((sharedOffers / total) * 100) : 0}% of total</div>
                <div class="metric-label">Shared</div>
            </div>
            <div class="metric-card viewed" onclick="filterOffersByMetric('viewed')" title="Show viewed offers">
                <div class="metric-value">${viewRate}%</div>
                <div class="metric-count">${viewedOffers} of ${sharedOffers}</div>
                <div class="metric-label">View Rate</div>
            </div>
            <div class="metric-card accepted" onclick="filterOffersByMetric('accepted')" title="Show accepted offers">
                <div class="metric-value">${acceptRate}%</div>
                <div class="metric-count">${metrics.accepted} won</div>
                <div class="metric-label">Accept Rate</div>
            </div>
            <div class="metric-card declined" onclick="filterOffersByMetric('declined')" title="Show declined offers">
                <div class="metric-value">${declineRate}%</div>
                <div class="metric-count">${metrics.declined} lost</div>
                <div class="metric-label">Decline Rate</div>
            </div>
            <div class="metric-card pending" onclick="filterOffersByMetric('pending')" title="Show pending offers">
                <div class="metric-value">${metrics.pending}</div>
                <div class="metric-count">awaiting</div>
                <div class="metric-label">In Progress</div>
            </div>
        `;
        
        // Apply active state to current filter
        if (window.currentMetricFilter) {
            const activeCard = container.querySelector(`.metric-card.${window.currentMetricFilter === 'all' ? 'total' : window.currentMetricFilter}`);
            if (activeCard) activeCard.classList.add('active');
        }
    }
    
    // Filter offers by metric card click
    window.currentMetricFilter = 'all';
    
    function filterOffersByMetric(filterType) {
        window.currentMetricFilter = filterType;
        
        // Update active states
        const cards = document.querySelectorAll('.metric-card');
        cards.forEach(card => card.classList.remove('active'));
        
        const activeClass = filterType === 'all' ? 'total' : filterType;
        const activeCard = document.querySelector(`.metric-card.${activeClass}`);
        if (activeCard) activeCard.classList.add('active');
        
        // Re-render with filter
        renderOffersDashboard($('dashboardSearch')?.value || '');
    }
    
    function applyMetricFilter(offers) {
        const filter = window.currentMetricFilter;
        if (!filter || filter === 'all') return offers;
        
        return offers.filter(o => {
            const t = o.tracking || {};
            switch (filter) {
                case 'shared':
                    return t.isoShared || t.clientShared;
                case 'viewed':
                    return t.isoViewed || t.clientViewed;
                case 'accepted':
                    return !!t.clientAccepted;
                case 'declined':
                    return !!t.clientDeclined;
                case 'pending':
                    return (t.isoShared || t.clientShared) && !t.clientAccepted && !t.clientDeclined;
                default:
                    return true;
            }
        });
    }
    
    function renderOfferCard(offer) {
        const t = offer.tracking || {};
        const isISO = offer.isISOShare;
        const isStale = isOfferStale(offer);
        const tags = offer.tags || [];
        
        // Determine current status (furthest stage reached)
        let statusClass = 'draft';
        let statusLabel = 'Draft';
        if (offer.funded || t.funded) { statusClass = 'funded'; statusLabel = 'Funded'; }
        else if (t.clientAccepted) { statusClass = 'accepted'; statusLabel = 'Accepted'; }
        else if (t.clientDeclined) { statusClass = 'declined'; statusLabel = 'Declined'; }
        else if (t.clientViewed) { statusClass = 'viewed'; statusLabel = 'Client Viewed'; }
        else if (t.clientShared) { statusClass = 'sent'; statusLabel = 'With Client'; }
        else if (t.isoViewed) { statusClass = 'viewed'; statusLabel = 'ISO Viewed'; }
        else if (t.isoShared) { statusClass = 'sent'; statusLabel = 'With ISO'; }
        else if (t.lenderLocked) { statusClass = 'locked'; statusLabel = 'Locked'; }
        
        // Date display with time
        const date = offer.createdAt ? new Date(offer.createdAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';
        
        // Star button HTML
        const starBtn = `
            <button class="offer-star-btn ${offer.starred ? 'active' : ''}" onclick="event.stopPropagation(); toggleStar('${offer.id}')" title="${offer.starred ? 'Unstar' : 'Star'} this offer">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="${offer.starred ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" class="h-4 w-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.049 2.927c.3-.921 1.603-.921 1.902 0l1.519 4.674a1 1 0 00.95.69h4.915c.969 0 1.371 1.24.588 1.81l-3.976 2.888a1 1 0 00-.363 1.118l1.518 4.674c.3.922-.755 1.688-1.538 1.118l-3.976-2.888a1 1 0 00-1.176 0l-3.976 2.888c-.783.57-1.838-.197-1.538-1.118l1.518-4.674a1 1 0 00-.363-1.118l-3.976-2.888c-.784-.57-.38-1.81.588-1.81h4.914a1 1 0 00.951-.69l1.519-4.674z" />
                </svg>
            </button>
        `;
        
        // Stale indicator
        const staleHtml = isStale ? `
            <span class="stale-indicator">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                </svg>
                ${STALE_DAYS}+ days
            </span>
        ` : '';
        
        // Tags HTML
        const tagsHtml = `
            <div class="offer-tags" style="margin-top: 8px;">
                ${tags.map(tag => `<span class="offer-tag ${tag}">${AVAILABLE_TAGS.find(t => t.id === tag)?.label || tag}</span>`).join('')}
                <div class="tag-picker">
                    <button class="tag-picker-btn" onclick="showTagPicker('${offer.id}', event)" title="Add tag">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                        </svg>
                    </button>
                    <div class="tag-picker-dropdown" id="tag-picker-${offer.id}">
                        ${AVAILABLE_TAGS.map(tag => `
                            <div class="tag-picker-option ${tags.includes(tag.id) ? 'selected' : ''}" onclick="event.stopPropagation(); toggleOfferTag('${offer.id}', '${tag.id}')">
                                <span class="offer-tag ${tag.id}" style="margin:0;">${tag.label}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        if (isISO) {
            // ISO Rate Share card
            return `
                <div class="offer-card ${offer.archived ? 'archived' : ''}" data-offer-id="${offer.id}" style="${offer.archived ? 'opacity:0.5;' : ''}">
                    <div class="offer-card-header">
                        <div style="display:flex;align-items:flex-start;gap:8px;">
                            ${starBtn}
                            <div class="offer-card-title">
                                <h3>
                                    <span style="color: var(--accent);">⚡ ISO Rate Share</span>
                                    ${offer.isoName ? `<span class="iso-tag">${escapeHtml(offer.isoName)}</span>` : ''}
                                    ${staleHtml}
                                </h3>
                                <div class="sub-info">${(offer.buyRate || 0).toFixed(2)}x → ${(offer.factor || 0).toFixed(2)}x • ${date}</div>
                            </div>
                        </div>
                        <span class="offer-status-badge ${statusClass}">${statusLabel}</span>
                    </div>
                    
                    ${tagsHtml}
                    
                    <div class="offer-tracking">
                        ${renderTrackingProgress(offer, true)}
                    </div>
                    
                    <div class="offer-actions">
                        <button class="offer-action-btn" onclick="copyOfferLink('${offer.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            Copy
                        </button>
                        <button class="offer-action-btn" onclick="openOfferLink('${offer.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                            Open
                        </button>
                        <button class="offer-action-btn archive" onclick="archiveOffer('${offer.id}')" title="${offer.archived ? 'Unarchive' : 'Archive'}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                        </button>
                        <button class="offer-action-btn delete" onclick="deleteOffer('${offer.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </div>
                </div>
            `;
        }
        
        // Regular offer card
        const freqLabel = offer.frequency === 'daily' ? 'D' : offer.frequency === 'weekly' ? 'W' : 'M';
        const amountStr = offer.amount ? '$' + offer.amount.toLocaleString() : '$0';
        const factorStr = offer.factor ? offer.factor.toFixed(2) + 'x' : '-';
        const termStr = offer.term ? offer.term + freqLabel : '-';
        
        // Calculate profit
        let profitHtml = '';
        let profitAmount = 0;
        if (offer.amount && offer.factor) {
            const buyRate = offer.buyRate || 1.00;
            profitAmount = offer.amount * (offer.factor - buyRate);
            if (profitAmount > 0) {
                profitHtml = `
                    <div class="offer-stat-divider"></div>
                    <div class="offer-stat">
                        <span class="offer-stat-label">Profit</span>
                        <span class="offer-stat-value profit animate-profit" data-profit="${Math.round(profitAmount)}">+$${Math.round(profitAmount).toLocaleString()}</span>
                    </div>
                `;
            }
        }
        
        return `
            <div class="offer-card ${offer.archived ? 'archived' : ''}" data-offer-id="${offer.id}" style="${offer.archived ? 'opacity:0.5;' : ''}">
                <div class="offer-card-header">
                    <div style="display:flex;align-items:flex-start;gap:8px;">
                        ${starBtn}
                        <div class="offer-card-title">
                            <h3>
                                ${escapeHtml(offer.businessName || 'Unnamed')}
                                ${offer.isoName ? `<span class="iso-tag">${escapeHtml(offer.isoName)}</span>` : ''}
                                ${offer.lenderName ? `<span class="lender-tag">${escapeHtml(offer.lenderName)}</span>` : ''}
                                ${staleHtml}
                            </h3>
                            <div class="sub-info">${offer.contactName ? escapeHtml(offer.contactName) + ' • ' : ''}${date}</div>
                        </div>
                    </div>
                    <span class="offer-status-badge ${statusClass}">${statusLabel}</span>
                </div>
                
                ${tagsHtml}
                
                <div class="offer-stats">
                    <div class="offer-stat">
                        <span class="offer-stat-label">Amount</span>
                        <span class="offer-stat-value animate-amount" data-amount="${offer.amount || 0}">${amountStr}</span>
                    </div>
                    <div class="offer-stat-divider"></div>
                    <div class="offer-stat">
                        <span class="offer-stat-label">Factor</span>
                        <span class="offer-stat-value animate-factor" data-factor="${offer.factor || 0}">${factorStr}</span>
                    </div>
                    <div class="offer-stat-divider"></div>
                    <div class="offer-stat">
                        <span class="offer-stat-label">Term</span>
                        <span class="offer-stat-value">${termStr}</span>
                    </div>
                    ${profitHtml}
                </div>
                
                <div class="offer-tracking">
                    ${renderTrackingProgress(offer, false)}
                </div>
                
                <button id="tracking-toggle-${offer.id}" class="tracking-toggle" onclick="toggleTrackingDetails('${offer.id}')">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                    View Timeline
                </button>
                
                <div id="tracking-detail-${offer.id}" class="tracking-detailed">
                    ${renderDetailedTracking(offer)}
                </div>
                
                <div class="offer-actions">
                    <button class="offer-action-btn" onclick="copyOfferLink('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                        Copy
                    </button>
                    <button class="offer-action-btn" onclick="openOfferLink('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" /></svg>
                        Open
                    </button>
                    ${statusClass === 'accepted' ? `
                        <button class="offer-action-btn ${offer.funded ? 'active' : ''}" onclick="markAsFunded('${offer.id}')" title="${offer.funded ? 'Unmark as funded' : 'Mark as funded'}" style="${offer.funded ? 'background: rgba(16, 185, 129, 0.15); border-color: #10b981; color: #10b981;' : ''}">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            ${offer.funded ? 'Funded' : 'Fund'}
                        </button>
                    ` : ''}
                    <button class="offer-action-btn archive" onclick="archiveOffer('${offer.id}')" title="${offer.archived ? 'Unarchive' : 'Archive'}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4" /></svg>
                    </button>
                    <button class="offer-action-btn delete" onclick="deleteOffer('${offer.id}')">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                </div>
            </div>
        `;
    }
    
    function renderTrackingProgress(offer, isISOShare) {
        const t = offer.tracking || {};
        
        // Stage order: Locked → ISO Share → ISO View → Client Share → Client View → Reject/Accept
        // For ISO shares, show all stages
        // For regular offers (direct to client), skip ISO stages
        const svgIcon = (path, sw = 2) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round">${path}</svg>`;
        const allStages = [
            { key: 'lenderLocked', icon: svgIcon('<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>'), label: 'Locked', cls: 'locked' },
            { key: 'isoShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'ISO', cls: 'iso-share' },
            { key: 'isoViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'View', cls: 'iso-view' },
            { key: 'clientShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'Client', cls: 'client-share' },
            { key: 'clientViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'View', cls: 'client-view' },
            { key: 'clientDeclined', icon: svgIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>', 2.5), label: 'Reject', cls: 'rejected', final: true },
            { key: 'clientAccepted', icon: svgIcon('<polyline points="20 6 9 17 4 12"/>', 2.5), label: 'Accept', cls: 'accepted', final: true }
        ];
        
        // Always show all stages from lender lock forward
        let stages = allStages;
        
        // Filter out declined if accepted, and vice versa
        const hasAccepted = t.clientAccepted;
        const hasDeclined = t.clientDeclined;
        stages = stages.filter(s => {
            if (s.key === 'clientDeclined' && hasAccepted) return false;
            if (s.key === 'clientAccepted' && hasDeclined) return false;
            return true;
        });
        
        let html = '';
        
        // If client was shared with, ISO must have viewed it, and it must have been locked
        const inferredComplete = (key) => {
            if (t[key]) return true;
            // If client shared, all prior stages must be complete
            if (t.clientShared && ['lenderLocked', 'isoShared', 'isoViewed'].includes(key)) return true;
            // If ISO viewed, it must have been locked and shared
            if (t.isoViewed && ['lenderLocked', 'isoShared'].includes(key)) return true;
            // If ISO shared, it must have been locked
            if (t.isoShared && key === 'lenderLocked') return true;
            return false;
        };
        
        stages.forEach((stage, i) => {
            const isComplete = inferredComplete(stage.key);
            const nextComplete = stages[i+1] && inferredComplete(stages[i+1].key);
            const timestamp = t[stage.key] ? new Date(t[stage.key]).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: 'numeric', minute: '2-digit' }) : '';
            
            html += `
                <div class="tracking-stage ${isComplete ? 'complete ' + stage.cls : ''}" title="${timestamp || 'Pending'}">
                    <span class="tracking-icon ${isComplete ? 'complete ' + stage.cls : ''}">${stage.icon}</span>
                    <span class="tracking-label">${stage.label}</span>
                </div>
            `;
            
            // Add connecting line between stages (except after the last one)
            if (i < stages.length - 1) {
                html += `<div class="tracking-line ${isComplete && nextComplete ? 'complete' : ''}"></div>`;
            }
        });
        
        return html;
    }
    
    function renderDetailedTracking(offer) {
        const t = offer.tracking || {};
        const isISOShare = !!t.isoShared || !!t.lenderLocked;
        
        const svgIcon = (path, sw = 2) => `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="${sw}" stroke-linecap="round" stroke-linejoin="round">${path}</svg>`;
        
        const allStages = [
            { key: 'lenderLocked', icon: svgIcon('<rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/>'), label: 'Lender Locked', description: 'Offer locked by lender', cls: 'locked' },
            { key: 'isoShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'Shared with ISO', description: 'Offer sent to ISO partner', cls: 'iso-share' },
            { key: 'isoViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'Viewed by ISO', description: 'ISO partner opened the offer', cls: 'iso-view' },
            { key: 'clientShared', icon: svgIcon('<path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>'), label: 'Shared with Client', description: 'Offer forwarded to merchant', cls: 'client-share' },
            { key: 'clientViewed', icon: svgIcon('<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>'), label: 'Viewed by Client', description: 'Merchant opened the offer', cls: 'client-view' },
            { key: 'clientDeclined', icon: svgIcon('<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>', 2.5), label: 'Rejected', description: 'Merchant declined the offer', cls: 'rejected', final: true },
            { key: 'clientAccepted', icon: svgIcon('<polyline points="20 6 9 17 4 12"/>', 2.5), label: 'Accepted', description: 'Merchant accepted the offer', cls: 'accepted', final: true }
        ];
        
        // Always show all stages from lender lock forward
        let stages = allStages;
        
        // Filter out the opposite final state
        const hasAccepted = t.clientAccepted;
        const hasDeclined = t.clientDeclined;
        stages = stages.filter(s => {
            if (s.key === 'clientDeclined' && hasAccepted) return false;
            if (s.key === 'clientAccepted' && hasDeclined) return false;
            return true;
        });
        
        let html = '';
        
        // If client was shared with, ISO must have viewed it, and it must have been locked
        const inferredComplete = (key) => {
            if (t[key]) return true;
            // If client shared, all prior stages must be complete
            if (t.clientShared && ['lenderLocked', 'isoShared', 'isoViewed'].includes(key)) return true;
            // If ISO viewed, it must have been locked and shared
            if (t.isoViewed && ['lenderLocked', 'isoShared'].includes(key)) return true;
            // If ISO shared, it must have been locked
            if (t.isoShared && key === 'lenderLocked') return true;
            return false;
        };
        
        stages.forEach((stage, i) => {
            const isComplete = inferredComplete(stage.key);
            const timestamp = t[stage.key] ? new Date(t[stage.key]).toLocaleString('en-US', { 
                weekday: 'short',
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true
            }) : '';
            
            const statusText = isComplete ? 'Complete' : 'Pending';
            const statusClass = isComplete ? '' : 'pending';
            
            html += `
                <div class="tracking-detail-row ${isComplete ? 'complete ' + stage.cls : statusClass}">
                    <div class="tracking-detail-icon">${stage.icon}</div>
                    <div class="tracking-detail-content">
                        <span class="tracking-detail-label">${stage.label}</span>
                        <span class="tracking-detail-time">${isComplete ? (timestamp || 'Inferred') : stage.description}</span>
                    </div>
                    <span class="tracking-detail-status">${statusText}</span>
                </div>
            `;
        });
        
        return html;
    }
    
    function toggleTrackingDetails(offerId) {
        const detailEl = document.getElementById('tracking-detail-' + offerId);
        const toggleBtn = document.getElementById('tracking-toggle-' + offerId);
        if (detailEl && toggleBtn) {
            detailEl.classList.toggle('show');
            toggleBtn.classList.toggle('expanded');
            toggleBtn.innerHTML = detailEl.classList.contains('show') 
                ? `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="18 15 12 9 6 15"/></svg> Hide Details`
                : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg> View Details`;
        }
    }
    
    function renderOfferRow(offer) {
        // Deprecated - now using renderOfferCard
        return renderOfferCard(offer);
    }
    
    function renderTrackingStages(offer, isISOShare) {
        // Deprecated - now using renderTrackingProgress
        return renderTrackingProgress(offer, isISOShare);
    }
    
    function filterDashboardOffers() {
        const search = $('dashboardSearch')?.value || '';
        renderOffersDashboard(search);
    }
    
    function renderTrackingColumn(offer) {
        // Legacy function - redirect to new format
        return renderTrackingStages(offer, offer.isISOShare);
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function copyOfferLink(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer && offer.link) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(offer.link).then(() => showToast('Link copied!')).catch(() => prompt("Copy Link:", offer.link));
            } else {
                prompt("Copy Link:", offer.link);
            }
        }
    }
    
    function openOfferLink(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer && offer.link) {
            window.open(offer.link, '_blank');
        }
    }
    
    function deleteOffer(offerId) {
        if (!confirm('Delete this offer?')) return;
        
        let offers = getStoredOffers();
        offers = offers.filter(o => o.id !== offerId);
        saveStoredOffers(offers);
        updateOfferCount();
        renderOffersDashboard();
        showToast('Offer deleted');
    }
    
    function clearAllOffers() {
        console.log('clearAllOffers called');
        try {
            const offers = getStoredOffers();
            console.log('Offers found:', offers.length);
            if (offers.length === 0) {
                showToast('No offers to clear');
                return;
            }
            
            // Clear directly without confirm dialog
            localStorage.removeItem('trustbureau_offers');
            updateOfferCount();
            renderOffersDashboard();
            showToast('All offers cleared');
            console.log('Done');
        } catch (e) {
            console.error('Error in clearAllOffers:', e);
            alert('Error: ' + e.message);
        }
    }
    
    function copyText() {
        console.log('copyText() called');
        const l = getLink();
        console.log('Generated email link:', l);
        const businessName = getVal('calcBusinessName') || 'Business Funding';
        const contactName = getVal('calcContactName') || '';
        const fontMain = "font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;";
        
        let cardsHtml = '';
        
        calcOptions.forEach((opt, i) => {
            const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
            const freqLabel = opt.frequency.charAt(0).toUpperCase() + opt.frequency.slice(1);
            
            // Calculate term length display using shared helper
            const termLengthDisplay = getTermDisplay(opt.term, opt.frequency, opt.termOverride);
            
            // Calculate principal percentage for visual
            const principalPct = Math.round((opt.amount / cal.totalPayback) * 100);
            
            const optionLabelHtml = calcOptions.length > 1 
                ? `<div style="display: inline-block; background-color: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; padding: 6px 16px; margin-bottom: 16px;">
                       <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #10b981; margin: 0;">Option ${getLetter(i)}</p>
                   </div>`
                : '';

            const logoHtml = currentLogoUrl 
                ? `<div style="margin-bottom: 20px;"><img src="${currentLogoUrl}" alt="Logo" style="max-height: 48px; max-width: 160px;" /></div>`
                : '';

            const companyNameHtml = currentCompanyName
                ? `<p style="${fontMain} font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin: 0 0 16px 0;">${currentCompanyName}</p>`
                : '';
            
            // Notes section (conditional)
            let notesHtml = '';
            if (opt.notes && opt.notes.trim()) {
                const noteLines = opt.notes.split('\n').filter(n => n.trim()).map(n => 
                    `<li style="${fontMain} font-size: 13px; color: #475569; margin-bottom: 6px;">${n.trim()}</li>`
                ).join('');
                notesHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-top: 1px solid #e2e8f0;">
                    <tr>
                        <td style="padding: 20px;">
                            <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 10px;">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; font-weight: bold; color: #0f172a;">Offer Notes</td>
                                </tr>
                            </table>
                            <ul style="margin: 0; padding-left: 20px;">${noteLines}</ul>
                        </td>
                    </tr>
                </table>`;
            }
            
            // Documents section (conditional)
            let docsHtml = '';
            if (opt.docs && opt.docs.length > 0) {
                const docsText = opt.docsText || 'The following documents are required to complete your funding';
                const docItems = opt.docs.map(d => 
                    `<li style="${fontMain} font-size: 13px; color: #475569; margin-bottom: 6px;">${d}</li>`
                ).join('');
                docsHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-top: 1px solid #e2e8f0;">
                    <tr>
                        <td style="padding: 20px;">
                            <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 10px;">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; font-weight: bold; color: #0f172a;">Closing Documents</td>
                                </tr>
                            </table>
                            <p style="${fontMain} font-size: 12px; color: #64748b; margin: 0 0 10px 0;">${docsText}</p>
                            <ul style="margin: 0; padding-left: 20px;">${docItems}</ul>
                        </td>
                    </tr>
                </table>`;
            }
            
            // Fee row (conditional)
            const feeRowHtml = opt.fee > 0 
                ? `<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: rgba(251, 191, 36, 0.1);">
                    <tr>
                        <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Origination Fee</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.feeAmount)}</p>
                        </td>
                        <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Net Proceeds</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.net)}</p>
                        </td>
                    </tr>
                </table>`
                : '';
            
            // Prepay row (conditional)
            const prepayRowHtml = opt.prepay > 0 
                ? `<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: rgba(34, 197, 94, 0.1);">
                    <tr>
                        <td align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Prepay Discount</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #22c55e; margin: 0;">${opt.prepay}% off if paid early</p>
                        </td>
                    </tr>
                </table>`
                : '';

            cardsHtml += `
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tr>
                    <td align="center">
                        <div style="max-width: 420px; margin: 0 auto 40px auto; background-color: #ffffff; border-radius: 24px; overflow: hidden; border: 4px solid #10b981; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                            
                            <!-- Header -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 40px 20px 32px 20px;">
                                        ${logoHtml}
                                        ${companyNameHtml}
                                        ${optionLabelHtml}
                                        <p style="${fontMain} font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; margin: 0 0 8px 0;">You Get</p>
                                        <h1 style="${fontMain} font-size: 52px; font-weight: 800; line-height: 1; letter-spacing: -2px; color: #ffffff; margin: 0;">${formatCurrency(opt.amount)}</h1>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Chart/Breakdown Section -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background: linear-gradient(to bottom, #ffffff, #f8fafc);">
                                <tr>
                                    <td align="center" style="padding: 28px 20px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin: 0 0 6px 0;">Total Payback</p>
                                        <p style="${fontMain} font-size: 26px; font-weight: bold; color: #0f172a; margin: 0 0 16px 0;">${formatCurrency(cal.totalPayback)}</p>
                                        <table border="0" cellspacing="0" cellpadding="0" style="margin: 0 auto;">
                                            <tr>
                                                <td style="padding-right: 20px;">
                                                    <table border="0" cellspacing="0" cellpadding="0">
                                                        <tr>
                                                            <td style="width: 12px; height: 12px; background: linear-gradient(135deg, #34d399, #10b981); border-radius: 50%;"></td>
                                                            <td style="padding-left: 8px; ${fontMain} font-size: 12px; color: #64748b;">Principal</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <table border="0" cellspacing="0" cellpadding="0">
                                                        <tr>
                                                            <td style="width: 12px; height: 12px; background: #e2e8f0; border-radius: 50%;"></td>
                                                            <td style="padding-left: 8px; ${fontMain} font-size: 12px; color: #64748b;">Cost of Capital</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <!-- Stats Grid Row 1: Term & Payments -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; border-top: 1px solid #f1f5f9;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Term Length</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${termLengthDisplay}</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Payments</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${cal.term}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Stats Grid Row 2: Factor & Cost -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Factor Rate</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${parseFloat(opt.factor).toFixed(2)}x</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Total Cost</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.totalCost)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Fee Row (conditional) -->
                            ${feeRowHtml}
                            
                            <!-- Prepay Row (conditional) -->
                            ${prepayRowHtml}

                            <!-- Payment Section -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background-color: #ffffff; padding: 28px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 6px 0; letter-spacing: 1px;">${freqLabel} Payment</p>
                                        <p style="${fontMain} font-size: 32px; font-weight: 800; color: #0f172a; margin: 0; letter-spacing: -1px;">${formatCurrency(cal.payment)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Notes Section (conditional) -->
                            ${notesHtml}
                            
                            <!-- Documents Section (conditional) -->
                            ${docsHtml}
                            
                        </div>
                        
                        <!-- URL Below Card -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin: 16px auto 0 auto;">
                            <tr>
                                <td align="center">
                                    <p style="${fontMain} font-size: 12px; color: #64748b; margin: 0;">
                                        <span style="font-weight: 600;">View Offer:</span> ${l}
                                    </p>
                                </td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>`;
        });
        
        // Build expiration section HTML
        const expiryDate = $('toggleExpiry').checked ? getVal('calcExpiryDate') : null;
        let expiryHtml = '';
        if (expiryDate) {
            const formattedExpiry = new Date(expiryDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            expiryHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="max-width: 420px; margin: 20px auto 0 auto;">
                    <tr>
                        <td style="padding: 16px; background-color: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <table border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; color: #475569;">This offer expires on <span style="font-weight: bold; color: #10b981;">${formattedExpiry}</span></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>`;
        }
        
        // Build greeting
        const greetingName = contactName || 'Business Owner';
        
        const html = `
            <!DOCTYPE html>
            <html>
            <body style="margin: 0; padding: 0; background-color: #f8fafc;">
            <center>
            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
                <tr>
                    <td align="center" style="padding: 40px 20px;">
                        
                        <!-- Trust Badge -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 24px;">
                            <tr>
                                <td align="center">
                                    <div style="display: inline-block; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 50px; padding: 10px 20px;">
                                        <table border="0" cellspacing="0" cellpadding="0">
                                            <tr>
                                                <td style="width: 20px; height: 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; text-align: center; vertical-align: middle;">
                                                    <span style="color: white; font-size: 12px; line-height: 20px;">✓</span>
                                                </td>
                                                <td style="padding-left: 10px; ${fontMain} font-size: 12px; font-weight: 600; color: #475569;">
                                                    <span style="color: #10b981; font-weight: 700;">TrustBureau</span> Verified
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                        <!-- Greeting -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 30px;">
                            <tr>
                                <td align="center">
                                    <h2 style="margin: 0 0 8px 0; color: #0f172a; font-size: 26px; font-weight: 800;">Hello, ${greetingName}</h2>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Your business <span style="font-weight: 600; color: #0f172a;">${businessName}</span> has been pre-approved for funding.</p>
                                </td>
                            </tr>
                        </table>

                        ${cardsHtml}
                        
                        ${expiryHtml}

                    </td>
                </tr>
            </table>
            </center>
            </body>
            </html>
        `;
        
        const div = document.createElement('div'); 
        div.innerHTML = html; 
        div.style.position='fixed'; div.style.opacity='0'; div.contentEditable='true'; 
        document.body.appendChild(div);
        
        const range = document.createRange(); 
        range.selectNodeContents(div); 
        const sel = window.getSelection(); 
        sel.removeAllRanges(); 
        sel.addRange(range);
        
        try { 
            document.execCommand('copy'); 
            saveOfferToDashboard(l, 'clientShareEmail'); // Save offer with email tracking
            window.clientEmailShared = true;
            updateModeStatusIcons();
            showToast('Email template copied!'); 
        } catch(e) { 
            copyLink(); 
        }
        document.body.removeChild(div); 
        $('shareModal').classList.add('hidden');
    }

    function openAmortSchedule() { 
        let a, f, t, fr;
        
        if($('adminPanel').classList.contains('hidden')) {
            const opt = clientData.o[clientActiveIdx];
            a = clientSelectedAmount;
            f = opt.f;
            t = opt.t;
            fr = opt.q;
        } else {
            a = getVal('calcAmount', true);
            f = getVal('calcFactor', true);
            t = getVal('calcTerm', true);
            const freqBtn = document.querySelector('.toggle-btn.active');
            fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        }
        
        const c = calculate(a, f, t, fr, 0);
        let b = c.totalPayback, d = new Date(), html = '';
        
        for(let i=1; i<=t; i++) {
            if(i > 300 && i < t) continue;
            if(i === 300 && t > 300) { html += `<tr><td colspan="4" class="text-center py-4 italic text-xs" style="color: var(--text-muted); background: var(--bg-option-card);">... (${t - 300} remaining payments) ...</td></tr>`; continue; }
            if(fr==='weekly') d.setDate(d.getDate()+7); else if(fr==='monthly') d.setMonth(d.getMonth()+1); else { d.setDate(d.getDate()+1); if(d.getDay()===0) d.setDate(d.getDate()+1); if(d.getDay()===6) d.setDate(d.getDate()+2); }
            b -= c.payment; if(b<0) b=0;
            html += `<tr><td class="px-6 py-3 font-medium">${i}</td><td class="px-6 py-3">${d.toLocaleDateString()}</td><td class="px-6 py-3 text-right font-mono">${formatCurrency(c.payment)}</td><td class="px-6 py-3 text-right font-mono font-bold" style="color: var(--text-primary);">${formatCurrency(b)}</td></tr>`;
        }
        $('amortTableBody').innerHTML = html; 
        $('amortModal').classList.remove('hidden'); 
    }

    function showToast(m) { 
        const t=$('toast'); 
        $('toastMessage').textContent=m; 
        t.classList.add('show'); 
        setTimeout(()=>t.classList.remove('show'), 3000); 
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    ['calcAmount','calcFactor','calcTerm','calcFee','calcPrepay'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const v = parseFloat(this.value.replace(/,/g,''))||0; 
            const slider = $(id+'Slider'); if(slider) { slider.value = v; updateSliderFill(slider); }
            updatePreview(); 
        });
    });
    
    ['calcAmountSlider','calcFactorSlider','calcTermSlider','calcFeeSlider','calcPrepaySlider'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const k = id.replace('Slider',''); setVal(k, k==='calcAmount'?formatNumber(this.value):this.value); 
            updatePreview(); updateSliderFill(this);
            // Mark ISO/Client as having used the calculator
            if (currentClientMode === 'iso') {
                window.isoViewed = true;
                updateModeStatusIcons();
            } else if (currentClientMode === 'client') {
                window.clientViewed = true;
                updateModeStatusIcons();
            }
        });
    });
    
    // ISO Sell Rate slider
    $('isoSellRateSlider')?.addEventListener('input', function() {
        if ($('isoSellRate')) $('isoSellRate').value = parseFloat(this.value).toFixed(2);
        updateSliderFill(this);
        updateIsoUpsell();
        // Mark ISO as having used the calculator
        if (currentClientMode === 'iso') {
            window.isoViewed = true;
            updateModeStatusIcons();
        }
    });
    
    $('isoSellRate')?.addEventListener('input', function() {
        const slider = $('isoSellRateSlider');
        const minVal = parseFloat(slider?.min) || 1.05;
        const maxVal = parseFloat(slider?.max) || 1.70;
        
        let val = parseFloat(this.value) || minVal;
        val = Math.max(minVal, Math.min(maxVal, val));
        this.value = val.toFixed(2);
        
        if (slider) {
            slider.value = val;
            updateSliderFill(slider);
        }
        updateIsoUpsell();
        // Mark ISO as having used the calculator
        if (currentClientMode === 'iso') {
            window.isoViewed = true;
            updateModeStatusIcons();
        }
    });
    
    // Lender Buy Rate slider
    $('lenderBuyRateSlider')?.addEventListener('input', function() {
        clearTierSelection();
        const buyVal = parseFloat(this.value);
        const maxSellEl = $('lenderMaxSell');
        const maxSellSlider = $('lenderMaxSellSlider');
        let maxSellVal = parseFloat(maxSellEl?.value) || 1.25;
        
        // If buy rate >= max sell, push max sell up (maintain 0.05 min spread)
        if (buyVal >= maxSellVal - 0.04) {
            maxSellVal = Math.min(buyVal + 0.05, 1.70);
            if (maxSellEl) maxSellEl.value = maxSellVal.toFixed(2);
            if (maxSellSlider) {
                maxSellSlider.value = maxSellVal;
                updateSliderFill(maxSellSlider);
            }
            if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2);
        }
        
        if ($('lenderBuyRate')) $('lenderBuyRate').value = buyVal.toFixed(2);
        if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2); // Sync to theme menu
        updateSliderFill(this);
        updateLenderDisplay();
    });
    
    $('lenderBuyRate')?.addEventListener('input', function() {
        clearTierSelection();
        // Clamp value to slider bounds
        let buyVal = parseFloat(this.value) || 1.15;
        buyVal = Math.max(1.05, Math.min(1.60, buyVal));
        this.value = buyVal.toFixed(2);
        
        const maxSellEl = $('lenderMaxSell');
        const maxSellSlider = $('lenderMaxSellSlider');
        let maxSellVal = parseFloat(maxSellEl?.value) || 1.25;
        
        // If buy rate >= max sell, push max sell up (maintain 0.05 min spread)
        if (buyVal >= maxSellVal - 0.04) {
            maxSellVal = Math.min(buyVal + 0.05, 1.70);
            if (maxSellEl) maxSellEl.value = maxSellVal.toFixed(2);
            if (maxSellSlider) {
                maxSellSlider.value = maxSellVal;
                updateSliderFill(maxSellSlider);
            }
            if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2);
        }
        
        if ($('lenderBuyRateSlider')) {
            $('lenderBuyRateSlider').value = buyVal;
            updateSliderFill($('lenderBuyRateSlider'));
        }
        if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2); // Sync to theme menu
        updateLenderDisplay();
    });
    
    // Lender Max Sell slider
    $('lenderMaxSellSlider')?.addEventListener('input', function() {
        clearTierSelection();
        const maxSellVal = parseFloat(this.value);
        const buyRateEl = $('lenderBuyRate');
        const buyRateSlider = $('lenderBuyRateSlider');
        let buyVal = parseFloat(buyRateEl?.value) || 1.15;
        
        // If max sell <= buy rate, push buy rate down (maintain 0.05 min spread)
        if (maxSellVal <= buyVal + 0.04) {
            buyVal = Math.max(maxSellVal - 0.05, 1.05);
            if (buyRateEl) buyRateEl.value = buyVal.toFixed(2);
            if (buyRateSlider) {
                buyRateSlider.value = buyVal;
                updateSliderFill(buyRateSlider);
            }
            if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2);
        }
        
        if ($('lenderMaxSell')) $('lenderMaxSell').value = maxSellVal.toFixed(2);
        if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2); // Sync to theme menu
        updateSliderFill(this);
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxSellVal.toFixed(2);
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSellVal;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        updateLenderDisplay();
    });
    
    $('lenderMaxSell')?.addEventListener('input', function() {
        clearTierSelection();
        // Clamp value to slider bounds
        let maxSellVal = parseFloat(this.value) || 1.25;
        maxSellVal = Math.max(1.10, Math.min(1.70, maxSellVal));
        this.value = maxSellVal.toFixed(2);
        
        const buyRateEl = $('lenderBuyRate');
        const buyRateSlider = $('lenderBuyRateSlider');
        let buyVal = parseFloat(buyRateEl?.value) || 1.15;
        
        // If max sell <= buy rate, push buy rate down (maintain 0.05 min spread)
        if (maxSellVal <= buyVal + 0.04) {
            buyVal = Math.max(maxSellVal - 0.05, 1.05);
            if (buyRateEl) buyRateEl.value = buyVal.toFixed(2);
            if (buyRateSlider) {
                buyRateSlider.value = buyVal;
                updateSliderFill(buyRateSlider);
            }
            if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2);
        }
        
        if ($('lenderMaxSellSlider')) {
            $('lenderMaxSellSlider').value = maxSellVal;
            updateSliderFill($('lenderMaxSellSlider'));
        }
        if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2); // Sync to theme menu
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxSellVal;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSellVal;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        updateLenderDisplay();
    });
    
    $('clientAmountSlider').addEventListener('input', function() {
        const val = parseInt(this.value);
        clientSelectedAmount = (isNaN(val) || val < 0) ? 5000 : val;
        updateSliderFill(this);
        updateClientPreview();
    });

    ['calcTermOverride','calcBusinessName'].forEach(id => $(id).addEventListener('input', updatePreview));

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('load', () => {
        // Check for client share link FIRST - bypass login entirely
        const params = new URLSearchParams(window.location.search);
        const d = params.get('d');
        let isClientShareLink = false;
        let clientShareData = null;
        
        if (d) {
            try {
                // Try LZString decompression first (new format)
                let json = LZString.decompressFromEncodedURIComponent(d);
                
                // Fall back to old base64 format for backwards compatibility
                if (!json) {
                    json = decodeURIComponent(atob(d).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1)));
                }
                
                const data = JSON.parse(json);
                if(data.o && data.o.length) {
                    isClientShareLink = true;
                    clientShareData = data;
                    // Hide welcome screen immediately for client share links
                    $('welcomeScreen').classList.add('hidden');
                    
                    // Track client view event
                    window.clientViewed = true;
                    updateOfferTrackingByLink(window.location.href, 'clientView');
                }
            } catch(e) { console.error("Error parsing shared data", e); }
        }
        
        resetBrandKit();
        loadSavedBrandData(); // Restore saved logo and company name from localStorage
        
        // Only load auth state if NOT a client share link
        if (!isClientShareLink) {
            loadAuthState();
        }
        
        resetCalculator();
        initMobileSections();
        
        // Only check ISO share mode if NOT a client share link
        if (!isClientShareLink) {
            checkISOShareMode();
        }
        
        loadOfferCount(); // Load offer count on startup
        
        // Attach Clear All button handler
        const clearBtn = $('clearAllBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Clear All clicked via addEventListener');
                clearAllOffers();
            });
        }
        
        // Close login modal on overlay click
        $('loginModal').addEventListener('click', (e) => {
            if (e.target === $('loginModal')) {
                closeLoginModal();
            }
        });
        
        // Initialize client view if this is a client share link
        if (isClientShareLink && clientShareData) {
            initClientView(clientShareData);
        }
    });
  </script>
</body>
</html>
